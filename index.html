
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWA</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Global Font Size Reduction */
        html {
            font-size: 85%; /* MODIFIED: Increased font size */
        }

        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #f5f7fa;
            --gray: #95a5a6;
            --admin: #3498db;
            --teacher: #9b59b6;
            --student: #2ecc71;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: lightgray;
            color: #333;
            min-height: 100vh;
        }
        
        /* Role-based layout rules */
        body.is-admin .admin-only { display: flex; }
        body:not(.is-admin) .admin-only { display: none; }
        
        body.is-admin .admin-action-header,
        body:not(.is-admin) .admin-action-cell {
            display: none;
        }
        
        /* NEW: Teacher role rules */
        body.is-teacher .teacher-only { display: flex; }
        body:not(.is-teacher) .teacher-only { display: none; }
        
        body.is-admin .teacher-only { display: flex; } /* Admins can also see teacher items */

        /* NEW: Student role rules */
        body.is-student .student-only { display: flex; }
        body:not(.is-student) .student-only { display: none; }
        body:not(.is-student) .student-nav { display: none; }

        body.is-admin .student-only,
        body.is-teacher .student-only {
            display: none; /* Hide student-only from admin/teacher */
        }
        
        body.is-admin .student-nav,
        body.is-teacher .student-nav {
            display: none; /* Hide student nav items from admin/teacher */
        }
        
        body.is-student .admin-nav,
        body.is-student .teacher-nav {
             display: none; /* Hide admin/teacher nav items from student */
        }
        
        body.is-admin .teacher-nav {
             display: flex; /* Admin can see teacher nav items */
        }


        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px; 
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            height: 80px; 
            width: 100%; /* Ensure full width */
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px; 
        }
        
        .mobile-nav-toggle {
            display: none; 
            font-size: 1.5rem;
            margin-right: 0; 
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon-wrapper {
            width: 45px;
            height: 45px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .logo h1 {
            color: var(--dark);
            font-weight: 700;
            font-size: 1.5rem;
            line-height: 1.2;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            height: 100%;
        }
        
        .user-details-text {
            /* This will help center the name vertically */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .user-email {
            display: none; /* Hide email as requested */
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .logout-btn {
            background: transparent;
            color: var(--gray);
            border: 1px solid #e0e0e0;
            padding: 8px 15px;
            border-radius: 6px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            font-weight: 600;
            height: 40px;
        }

        .logout-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* Auth Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            margin-top: 20px; /* MODIFIED: Pushed card down */
        }

        .auth-card {
            background: white;
            border-radius: 12px;
            padding: 15px; /* MODIFIED: Was 40px */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            position: relative; 
            overflow: hidden; 
        }
        
        /* NEW: Auth Header Layout */
        .auth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px 15px 15px; /* Padding for spacing */
            margin-bottom: 10px;
        }
        
        .auth-header-title {
            flex-grow: 1;
            text-align: center;
            color: var(--dark);
            font-weight: 700;
            font-size: 1.5rem;
            line-height: 1.2;
        }

        .awa-logo-auth {
            font-weight: 900;
            color: var(--primary);
            font-size: 1.2rem;
            border: 2px solid var(--primary);
            padding: 5px 8px; /* Slightly more padding */
            border-radius: 4px;
            background: rgba(255,255,255,0.9);
            line-height: 1; /* Ensure tight box */
        }
        
        .auth-card .logo-icon-wrapper {
            width: 45px; /* Ensure size */
            height: 45px;
            flex-shrink: 0; /* Prevent shrinking */
        }
        
        .awa-logo-header {
            font-weight: 900;
            color: var(--primary);
            font-size: 1.2rem;
            border: 2px solid var(--primary);
            padding: 2px 5px;
            border-radius: 4px;
            margin-right: 10px;
            display: none; 
        }
        
        .auth-card .logo {
            display: none; /* Replaced by auth-header */
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }

        .auth-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }
        
        /* NEW: Small form group */
        .form-group-sm {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        /* NEW: Checkbox styles */
        .form-check {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f9f9f9;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        .form-check.selected {
             background: #e3f2fd;
             border-color: var(--primary);
        }
        .form-check input[type="checkbox"] {
            width: 1.1rem;
            height: 1.1rem;
            flex-shrink: 0;
        }
        .form-check label {
            margin-bottom: 0;
            font-weight: normal;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            width: 100%;
            position: relative; /* For loading spinner */
            min-height: 44px; /* Ensure height consistency */
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }
        
        /* NEW: Loading spinner */
        .btn .btn-text {
            transition: opacity 0.2s ease;
        }
        .btn .spinner {
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            margin-left: -8px;
            margin-top: -8px;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .btn.loading .btn-text {
            opacity: 0;
        }
        .btn.loading .spinner {
            display: block;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-danger {
            background: var(--danger);
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-success {
            background: var(--secondary);
        }
        .btn-success:hover {
            background: #27ae60;
        }
        .btn-warning {
            background: var(--warning);
        }
        .btn-warning:hover {
            background: #d35400;
        }

        .btn i {
            font-size: 0.9rem;
        }

        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
        }

        /* Sidebar Styles */
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            height: 100%; 
            position: relative; 
        }
        
        .sidebar-close {
            display: none; 
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
        }

        .user-role {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .role-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        .role-admin { background: var(--admin); }
        .role-teacher { background: var(--teacher); }
        .role-student { background: var(--student); }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border-radius: 8px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--light);
            color: var(--primary);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            min-height: 60vh;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .content-header h2 {
            color: var(--dark);
            font-weight: 600;
        }

        .btn-sm {
            width: auto;
            padding: 10px 20px;
        }
        
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--gray);
            transition: color 0.2s ease;
        }
        .btn-icon:hover {
            color: var(--primary);
        }
        .btn-icon.danger:hover {
            color: var(--danger);
        }

        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* NEW: Stats grid for 3 items */
        .stats-grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary);
        }
        
        .stat-card.clickable {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .stat-card.clickable:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .stat-card.teacher { border-left-color: var(--teacher); }
        .stat-card.student { border-left-color: var(--student); }
        .stat-card.secondary { border-left-color: var(--secondary); } /* NEW */
        .stat-card.warning { border-left-color: var(--warning); } /* NEW */
        .stat-card.danger { border-left-color: var(--danger); } /* NEW */
        .stat-card.success { border-left-color: var(--secondary); } /* NEW */

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border: 1px solid #eee;
            border-radius: 8px;
            position: relative;
            z-index: 2; 
        }
        
        /* NEW: Scrollable list for user tables */
        .table-container.scrollable-list {
            max-height: 250px;
            overflow-y: auto;
            border: none;
        }
        .table-container.scrollable-list.expanded {
            max-height: 400px;
        }
         .table-container.scrollable-list table {
            border: none;
         }
        
        /* NEW: Scrollable list for exam table */
        #manageExamListContainer.scrollable-list {
            max-height: 300px; /* Adjust as needed */
            overflow-y: auto;
            border: none;
        }
        #manageExamListContainer.scrollable-list.expanded {
            max-height: none; /* Show all */
        }
         #manageExamListContainer.scrollable-list table {
            border: none;
         }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: normal; 
            word-break: break-word;
            vertical-align: middle; 
        }
        
        tr td:first-child,
        tr th:first-child {
            padding-left: 20px;
        }
        tr td:last-child,
        tr th:last-child {
            padding-right: 20px;
        }

        th {
            background: var(--light);
            color: var(--dark);
            font-weight: 600;
            white-space: nowrap; /* Keep headers on one line */
        }
        
        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: #f9f9f9;
        }
        
        /* NEW: Empty state row */
        .empty-state-row {
            text-align: center;
            color: var(--gray);
            font-style: italic;
        }
        .empty-state-row td {
            padding: 40px;
        }
        .empty-state-row i {
            display: block;
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #ddd;
        }

        /* NEW: Result row styling */
        tr.result-retaken {
            background: #ffebee; /* Light red */
            color: #b71c1c;
        }
        tr.result-retaken td {
            border-color: #ffcdd2;
        }
        tr.result-retaken:hover {
            background: #ffcdd2;
        }


        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-deactivated { background: #fff3cd; color: #856404; }
        .status-active { background: #d4edda; color: #155724; }
        .status-retaken { background: #f8d7da; color: #721c24; }
        /* NEW: Student exam status */
        .status-not-started { background: #e2e3e5; color: #383d41; }


        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary);
            margin-right: 10px;
            font-size: 1rem;
        }
        .action-btn:hover { color: #2980b9; }
        .action-btn.reject-exam { color: var(--danger); }
        .action-btn.reject-exam:hover { color: #c0392b; }
        .action-btn.edit-exam { color: var(--warning); }
        .action-btn.edit-exam:hover { color: #d35400; }
        
        .action-btn.deactivate-user { color: var(--danger); }
        .action-btn.deactivate-user:hover { color: #c0392b; }
        .action-btn.activate-user { color: var(--secondary); }
        .action-btn.activate-user:hover { color: #27ae60; }
        .action-btn.reset-result { color: var(--warning); }
        .action-btn.reset-result:hover { color: #d35400; }
        .action-btn.delete-result { color: var(--danger); }
        .action-btn.delete-result:hover { color: #c0392b; }
        /* NEW: Analytics button */
        .action-btn.view-report { color: var(--teacher); } 
        .action-btn.view-report:hover { color: #8e44ad; }


        .resources-cell {
            text-align: right;
        }

        /* Exam Interface */
        .exam-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .exam-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .exam-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .question-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.1rem;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option:hover {
            background: #f5f5f5;
        }

        .option.selected {
            border-color: var(--primary);
            background: #e3f2fd;
        }
        
        .option input[type="radio"],
        .option input[type="checkbox"] {
            display: none;
        }
        
        /* NEW: Custom checkbox/radio circle */
        .option .check-icon {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray);
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .option.multi-choice .check-icon {
            border-radius: 4px;
        }
        
        .option.selected .check-icon {
            border-color: var(--primary);
            background: var(--primary);
        }
        .option.selected .check-icon::before {
             /* FontAwesome check */
            content: '\f00c';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 0.8rem;
            color: white;
        }


        .exam-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .result-card {
            text-align: center; 
            padding: 40px; 
            background: #f8f9fa; 
            border-radius: 12px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto; 
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px; 
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin: auto; /* Fix for centering on scroll */
        }
        
        .modal-content.mini {
            max-width: 400px;
            text-align: center;
        }
        
        /* NEW: Large modal */
        .modal-content.large {
            max-width: 800px;
        }
        
        /* NEW: Modal list */
        .modal-list {
            max-height: 40vh;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }
        .modal-list .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f5f5f5;
        }
        .modal-list .list-item:last-child {
            border-bottom: none;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        #confirmationModal .modal-icon {
            font-size: 3rem;
            color: var(--warning);
            margin-bottom: 15px;
        }
        #confirmationModal .modal-icon.danger {
            color: var(--danger);
        }
        #confirmationModal h3 {
            margin-bottom: 10px;
        }
        #confirmationModal p {
            margin-bottom: 20px;
            color: var(--dark);
        }
        #confirmationModal .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        #confirmationModal .modal-actions .btn {
            width: 100%;
        }


        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        /* Exam Editor Styles */
        .question-editor-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        .add-question-form {
            background: var(--light);
            padding: 25px;
            border-radius: 10px;
        }
        
        .add-question-form h3 {
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        /* NEW: Question type options */
        .question-type-options {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .option-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .option-input-group input[type="radio"],
        .option-input-group input[type="checkbox"] {
            flex-shrink: 0;
            width: 1.1rem;
            height: 1.1rem;
        }
        
        .option-input-group input[type="text"] {
            flex-grow: 1;
        }
        
        .question-list {
            list-style: none;
            padding: 0;
        }
        
        .question-list-item {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.03);
        }
        
        #questionList.empty-list {
            padding: 40px 20px;
            background: #f9f9f9;
            border-radius: 8px;
            text-align: center;
            color: var(--gray);
            border: 2px dashed #eee;
        }
        #questionList.empty-list::before {
            content: "\f055"; /* FontAwesome plus-circle */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 2rem;
            display: block;
            margin-bottom: 10px;
            color: #ccc;
        }
        #questionList.empty-list::after {
            content: "No questions added. Use the form to add your first question.";
            font-style: italic;
            display: block;
        }
        
        .question-list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .question-list-item-header h4 {
            color: var(--dark);
            font-weight: 600;
            max-width: 80%;
        }
        
        .question-list-item-options {
            list-style: none;
            padding-left: 20px;
        }
        
        .question-list-item-options li {
            margin-bottom: 5px;
            color: var(--gray);
        }
        
        .question-list-item-options li.correct {
            color: var(--secondary);
            font-weight: 600;
        }

        /* Overlay for mobile menu */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            transition: opacity 0.3s ease-in-out;
        }
        .overlay.open {
            display: block;
            opacity: 1;
        }

        /* NEW STYLES FOR BULK UPLOAD */
        .bulk-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        .iframe-preview {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        /* NEW: Toast Notification */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: white;
            color: var(--dark);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid var(--primary);
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success { border-left-color: var(--secondary); }
        .toast.error { border-left-color: var(--danger); }
        .toast.info i { color: var(--primary); }

        /* Responsive Utilities */
        .desktop-text { display: inline; }
        .mobile-text { display: none; }
        
        /* --- ACTION MENU (ALWAYS DROPDOWN) --- */
        .action-wrapper {
            display: flex; 
            align-items: center; 
            justify-content: flex-end; /* Align trigger to the right */
            width: 100%; 
            position: relative; 
            z-index: 5;
        }
        .action-label {
            display: none; /* No longer used */
        }
        .mobile-menu-trigger {
            background: none;
            border: none;
            font-size: 1.5rem; 
            color: var(--dark);
            padding: 0 5px; 
            cursor: pointer;
            display: block; /* Always visible */
            margin-left: auto; /* Push to far right */
        }
        .action-buttons {
            display: none; /* Dropdown is hidden by default */
            position: absolute;
            top: 100%; 
            right: 0;
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            flex-direction: column;
            padding: 5px;
            z-index: 10;
            min-width: 150px; /* More space for text */
            align-items: flex-start;
        }
        .action-buttons .action-btn {
            width: 100%;
            text-align: left;
            justify-content: flex-start;
            padding: 8px 10px;
            color: var(--dark);
            margin: 0; 
            gap: 10px; /* Space between icon and text */
        }
        .action-buttons .action-btn:hover {
            background: var(--light);
            color: var(--primary);
        }
        
        .action-buttons.show {
            display: flex; /* Class to show the dropdown */
        }
        
        .action-buttons.drop-up {
            bottom: 100%; /* Position above trigger */
            top: auto;
        }

        /* --- RESPONSIVE STYLES --- */
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                height: 100vh;
                z-index: 2000;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                width: 280px;
                overflow-y: auto;
                box-shadow: 0 0 20px rgba(0,0,0,0.2);
                border-radius: 0; 
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .sidebar-close {
                display: block;
            }
            .mobile-nav-toggle {
                display: block;
            }
            
            /* Show AWA Logo next to hamburger */
            .awa-logo-header {
                display: inline-block;
            }
        }
        
        @media (max-width: 640px) {
            .container { padding: 10px; }
            
            header { 
                padding: 10px 15px; 
                margin-bottom: 20px; 
                height: auto; 
                flex-wrap: nowrap; 
                overflow-x: hidden; 
                width: 100%; /* Ensure full width */
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .logo h1 { display: none; } 
            .user-info .user-details-text { display: none; } 
            .logout-btn span { display: none; }
            .logout-btn { padding: 8px; margin-left: auto; } 
            .main-content { padding: 15px; }
            .auth-card { padding: 20px; }
            .modal-content { padding: 20px; }
            
            .content-header { 
                margin-bottom: 20px; 
                flex-direction: column; 
                align-items: flex-start;
                gap: 10px;
            }
            .content-header h2 {
                font-size: 1.3rem; 
            }
            .content-header button {
                width: 100%; 
            }

            .stats-container { 
                grid-template-columns: repeat(2, 1fr);
                gap: 15px; 
            } 
            
            .stats-grid-3 {
                 grid-template-columns: 1fr; /* Stack on mobile */
            }
            
            /* Text Visibility */
            .desktop-text { display: none; }
            .mobile-text { display: inline; }

            /* CARD VIEW FOR TABLES ON MOBILE */
            table, thead, tbody, th, td, tr {
                display: block;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                margin-bottom: 15px;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                padding: 5px;
            }
            
            tr.empty-state-row {
                border: 1px dashed #ddd;
                box-shadow: none;
                background: #f9f9f9;
            }
            tr.empty-state-row td {
                justify-content: center;
                text-align: center;
                border: none;
                padding: 30px 15px !important;
            }
            tr.empty-state-row td:before {
                display: none;
            }

            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding: 10px 15px !important;
                text-align: right;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.9rem;
            }
            
            td:before {
                content: attr(data-label);
                font-weight: 600;
                text-align: left;
                color: var(--dark);
                margin-right: 15px;
            }

            tr td:last-child {
                border-bottom: none;
                justify-content: space-between; 
                padding-left: 15px !important;
                padding-right: 15px !important; 
            }
            
            tr td:last-child:before {
                display: inline-block !important;
                white-space: nowrap; 
            }
            
            tr td:first-child, tr th:first-child { padding-left: 15px; }
            
            .add-question-form { padding: 20px; }
        }
        @media (max-width: 480px) {
            .exam-controls { flex-direction: column; gap: 10px; }
            .exam-controls .btn-sm { width: 100%; }
        }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>

    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            
            <div class="auth-header">
                <div class="awa-logo-auth">AWA</div> 
                <h1 class="auth-header-title">WELCOME!</h1>
                <div class="logo-icon-wrapper"><i class="fas fa-graduation-cap"></i></div>
            </div>
            
            <div class="logo">
                <div class="logo-icon-wrapper"><i class="fas fa-graduation-cap"></i></div>
                <h1>AWA</h1>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">Login</div>
                <div class="auth-tab" data-tab="register">Register</div>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" value="admin@examsystem.com" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" value="admin123" required>
                </div>
                <button type="submit" class="btn" id="loginButton">
                    <span class="btn-text">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </span>
                    <div class="spinner"></div>
                </button>
            </form>
            <form id="registerForm" class="hidden">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" class="form-control" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="Enter your password" required>
                </div>
                <div class="form-group">
                    <label for="registerRole">Role</label>
                    <select id="registerRole" class="form-control" required>
                        <option value="">Select Role</option>
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button type="submit" class="btn" id="registerButton">
                    <span class="btn-text">
                        <i class="fas fa-user-plus"></i> Register
                    </span>
                    <div class="spinner"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appScreen" class="hidden">
        <div class="container">
            <header>
                <div class="header-left">
                    <button class="btn-icon mobile-nav-toggle" id="mobileNavToggle"><i class="fas fa-bars"></i></button>
                    <div class="awa-logo-header">AWA</div>
                    <div class="logo">
                        <div class="logo-icon-wrapper"><i class="fas fa-graduation-cap"></i></div>
                        <h1>AWA</h1>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">AD</div>
                    <div class="user-details-text"> 
                        <div class="user-name" id="userName">Admin User</div>
                        <div class="user-email" id="userEmail">admin@examsystem.com</div>
                    </div>
                    <button class="logout-btn" id="logoutBtn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                    </button>
                </div>
            </header>

            <div class="dashboard">
                <div class="sidebar" id="sidebar">
                    <button class="btn-icon sidebar-close" id="sidebarClose"><i class="fas fa-times"></i></button>
                    <div class="user-role">
                        <div class="role-badge role-admin" id="userRoleBadge">Admin</div>
                    </div>
                    <ul class="nav-menu" id="navMenu">
                        <li class="nav-item"><a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                        <li class="nav-item admin-nav"><a href="#" class="nav-link" data-page="users"><i class="fas fa-users"></i> User Management</a></li>
                        <!-- NEW: Classes Nav -->
                        <li class="nav-item teacher-nav"><a href="#" class="nav-link" data-page="classes"><i class="fas fa-school"></i> Class Management</a></li>
                        <li class="nav-item teacher-nav"><a href="#" class="nav-link" data-page="exams"><i class="fas fa-file-alt"></i> Exam Management</a></li>
                        <li class="nav-item teacher-nav"><a href="#" class="nav-link" data-page="results"><i class="fas fa-chart-bar"></i> Results & Analytics</a></li>
                        <!-- NEW: Student Nav -->
                        <li class="nav-item student-nav"><a href="#" class="nav-link" data-page="myExams"><i class="fas fa-pencil-alt"></i> My Exams</a></li>
                    </ul>
                </div>

                <div class="main-content">
                    <!-- Dashboard Page -->
                    <div id="dashboardPage" class="page-content">
                        <div class="content-header">
                            <h2>Dashboard Overview</h2>
                        </div>

                        <div class="stats-container" id="statsContainer">
                            <div class="stat-card clickable admin-only" data-page="users" data-filter="all">
                                <div class="stat-value" id="totalUsers">0</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                            <div class="stat-card teacher clickable admin-only" data-page="users" data-filter="teacher">
                                <div class="stat-value" id="totalTeachers">0</div>
                                <div class="stat-label">Teachers</div>
                            </div>
                            <div class="stat-card student clickable admin-only" data-page="users" data-filter="student">
                                <div class="stat-value" id="totalStudents">0</div>
                                <div class="stat-label">Students</div>
                            </div>
                            <div class="stat-card clickable teacher-only" data-page="exams">
                                <div class="stat-value" id="totalExams">0</div>
                                <div class="stat-label">Total Exams</div>
                            </div>
                            <div class="stat-card clickable teacher-only" data-page="results">
                                <div class="stat-value" id="completedExams">0</div>
                                <div class="stat-label">Exams Completed</div>
                            </div>
                            <!-- NEW: Student Dashboard Stats -->
                             <div class="stat-card clickable student-only" data-page="myExams">
                                <div class="stat-value" id="assignedExamsStat">0</div>
                                <div class="stat-label">Assigned Exams</div>
                            </div>
                             <div class="stat-card secondary clickable student-only" data-page="myExams">
                                <div class="stat-value" id="completedExamsStat">0</div>
                                <div class="stat-label">Completed Exams</div>
                            </div>
                        </div>

                        <div class="tabs" id="dashboardTabs">
                            <div class="tab active teacher-only" data-tab="pending">Pending Approval</div>
                            <div class="tab teacher-only" data-tab="recent">Recent Exams</div>
                            <div class="tab admin-only" data-tab="users">User Activity</div>
                        </div>

                        <div class="tab-content active" id="pending-tab">
                            <div class="table-container">
                                <table id="pendingExamsTable">
                                    <thead>
                                        <tr>
                                            <th>Exam Title</th>
                                            <th>Teacher</th>
                                            <th>Questions</th>
                                            <th>Status</th>
                                            <th class="admin-action-header">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-content" id="recent-tab">
                            <div class="table-container">
                                <table id="recentExamsTable">
                                    <thead>
                                        <tr>
                                            <th>Exam Title</th>
                                            <th>Subject</th>
                                            <th>Questions</th>
                                            <th>Participants</th>
                                            <th class="admin-action-header">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-content" id="users-tab">
                            <div class="table-container scrollable-list" id="dashboardUserListContainer">
                                <table id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Role</th>
                                            <th>Joined</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <button class="btn btn-sm" id="showAllUsersBtn" style="width: auto; margin-top: 10px; display: none;">
                                <i class="fas fa-chevron-down"></i> Show all...
                            </button>
                        </div>
                    </div>

                    <!-- NEW: My Exams Page (Student) -->
                    <div id="myExamsPage" class="page-content hidden">
                        <div class="content-header">
                            <h2>My Exams</h2>
                            <button class="btn btn-sm" id="joinExamByIdBtn">
                                <i class="fas fa-keyboard"></i> Join by ID
                            </button>
                        </div>
                        
                        <h3>Assigned Exams</h3>
                        <div class="table-container">
                            <table id="assignedExamsTable">
                                <thead>
                                    <tr>
                                        <th>Exam Title</th>
                                        <th>Subject</th>
                                        <th>Questions</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Take Exam Page -->
                    <div id="takeExamPage" class="page-content hidden">
                        <div class="exam-container">
                            <div class="exam-header">
                                <button class="btn-icon" id="backToDashboardBtn" style="float: left;" title="Back to Dashboard"><i class="fas fa-arrow-left"></i></button>
                                <h2 id="examTitle">Mathematics Final Exam</h2>
                                <p>Duration: <span id="examDuration">60</span> minutes</p>
                            </div>
                            <div class="exam-info">
                                <div>Time Remaining: <span id="timeRemaining">60:00</span></div>
                                <div>Question: <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span></div>
                            </div>
                            <div class="question-card" id="questionContainer">
                                <div class="question-text" id="questionText">Question Text</div>
                                <!-- NEW: Container for all option types -->
                                <div class="options" id="examOptionsContainer">
                                    <!-- Options will be rendered by JS based on question type -->
                                </div>
                            </div>
                            <div id="resultDisplay" class="result-card hidden">
                                <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--secondary); margin-bottom: 20px;"></i>
                                <h3>Exam Submitted!</h3>
                                <p style="font-size: 1.5rem; margin: 20px 0;">Your Score: <span id="finalScoreDisplay" style="font-weight: bold;"></span></p>
                                <button class="btn" id="examDoneBtn" style="width: auto; margin: 0 auto;">Back to Dashboard</button>
                            </div>
                            
                            <div class="exam-controls" id="activeExamControls">
                                <button class="btn btn-sm" id="prevQuestion"><i class="fas fa-arrow-left"></i> Previous</button>
                                <button class="btn btn-sm" id="nextQuestion">Next <i class="fas fa-arrow-right"></i></button>
                                <button class="btn btn-sm hidden" id="submitExam" style="background: var(--secondary);">Submit Exam</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exam Editor Page -->
                    <div id="examEditorPage" class="page-content hidden">
                        <div class="content-header">
                            <h2 id="examEditorTitle">Edit Exam</h2>
                            <button class="btn btn-sm" id="editorBackToDashboardBtn"><i class="fas fa-arrow-left"></i> Back to Dashboard</button>
                        </div>
                        
                        <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                            <h3>Exam Details</h3>
                            <form id="editExamDetailsForm" style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <div class="form-group">
                                    <label>Title</label>
                                    <input type="text" id="editExamTitleInput" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Subject</label>
                                    <select id="editExamSubjectInput" class="form-control">
                                         <option value="math">Mathematics</option>
                                         <option value="physics">Physics</option>
                                         <option value="chemistry">Chemistry</option>
                                         <option value="biology">Biology</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Duration (mins) <small>(0 = Untimed)</small></label>
                                    <input type="number" id="editExamDurationInput" class="form-control">
                                </div>
                                <div class="form-group" style="display: flex; align-items: flex-end;">
                                    <button type="submit" class="btn btn-sm">Update Details</button>
                                </div>
                            </form>
                        </div>

                        <div class="question-editor-container">
                            <div class="add-question-form">
                                <h3>Add New Question</h3>
                                <form id="addQuestionForm">
                                    <div class="form-group">
                                        <label for="questionTypeSelect">Question Type</label>
                                        <select id="questionTypeSelect" class="form-control">
                                            <option value="single_choice">Single Choice (Radio)</option>
                                            <option value="multi_choice">Multiple Choice (Checkbox)</option>
                                            <option value="true_false">True / False</option>
                                            <option value="short_answer">Short Answer</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="questionTextInput">Question Text</label>
                                        <textarea id="questionTextInput" class="form-control" required></textarea>
                                    </div>
                                    
                                    <!-- NEW: Question Type Options Wrapper -->
                                    <div class="question-type-options">
                                        
                                        <!-- Single/Multi Choice Options -->
                                        <div id="choiceOptionsContainer" class="form-group">
                                            <label>Options (select correct answer/s)</label>
                                            <div class="option-input-group" data-type="single_choice multi_choice">
                                                <input type="radio" name="correctAnswer" value="0" class="correct-answer-input">
                                                <input type="text" id="option1Input" class="form-control" placeholder="Option 1" required>
                                            </div>
                                            <div class="option-input-group" data-type="single_choice multi_choice">
                                                <input type="radio" name="correctAnswer" value="1" class="correct-answer-input">
                                                <input type="text" id="option2Input" class="form-control" placeholder="Option 2" required>
                                            </div>
                                            <div class="option-input-group" data-type="single_choice multi_choice">
                                                <input type="radio" name="correctAnswer" value="2" class="correct-answer-input">
                                                <input type="text" id="option3Input" class="form-control" placeholder="Option 3">
                                            </div>
                                            <div class="option-input-group" data-type="single_choice multi_choice">
                                                <input type="radio" name="correctAnswer" value="3" class="correct-answer-input">
                                                <input type="text" id="option4Input" class="form-control" placeholder="Option 4">
                                            </div>
                                        </div>

                                        <!-- True/False Options -->
                                        <div id="trueFalseContainer" class="form-group hidden">
                                            <label>Correct Answer</label>
                                            <div class="option-input-group">
                                                <input type="radio" name="trueFalseAnswer" value="true" class="correct-answer-input" required> True
                                            </div>
                                            <div class="option-input-group">
                                                <input type="radio" name="trueFalseAnswer" value="false" class="correct-answer-input"> False
                                            </div>
                                        </div>
                                        
                                        <!-- Short Answer Options -->
                                        <div id="shortAnswerContainer" class="form-group hidden">
                                            <label for="shortAnswerInput">Correct Answer (Case-insensitive)</label>
                                            <input type="text" id="shortAnswerInput" class="form-control correct-answer-input" placeholder="Enter the exact answer" required>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-sm" style="width: auto; margin-top: 20px;">Add Question</button>
                                </form>
                            </div>
                            <div>
                                <h3>Existing Questions (<span id="questionCount">0</span>)</h3>
                                <ul id="questionList" class="question-list"></ul>
                            </div>
                        </div>
                    </div>

                      <!-- User Management Page -->
                      <div id="usersPage" class="page-content hidden">
                         <div class="content-header">
                             <h2 id="usersPageTitle">User Management</h2>
                             <button class="btn btn-sm back-to-dashboard-btn"><i class="fas fa-arrow-left"></i> Back</button>
                         </div>
                         <div class="table-container scrollable-list" id="manageUserListContainer">
                             <table id="manageUsersTable">
                                 <thead>
                                     <tr>
                                         <th>Name</th>
                                         <th>Email</th>
                                         <th>Role</th>
                                         <th>Status</th>
                                         <th class="admin-action-header">Actions</th>
                                     </tr>
                                 </thead>
                                 <tbody></tbody>
                             </table>
                         </div>
                         <button class="btn btn-sm" id="showAllManageUsersBtn" style="width: auto; margin-top: 10px; display: none;">
                            <i class="fas fa-chevron-down"></i> Show all users...
                         </button>
                     </div>
                     
                     <!-- NEW: Class Management Page -->
                     <div id="classesPage" class="page-content hidden">
                         <div class="content-header">
                             <h2>Class Management</h2>
                             <button class="btn btn-sm" id="createClassBtn"><i class="fas fa-plus"></i> Create Class</button>
                         </div>
                         <div class="table-container">
                             <table id="classesTable">
                                 <thead>
                                     <tr>
                                         <th>Class Name</th>
                                         <th>Students</th>
                                         <th>Assigned Exams</th>
                                         <th>Actions</th>
                                     </tr>
                                 </thead>
                                 <tbody>
                                     <!-- Rows populated by JS -->
                                 </tbody>
                             </table>
                         </div>
                     </div>

                      <!-- Exam Management Page -->
                      <div id="examsPage" class="page-content hidden">
                         <div class="content-header">
                             <h2>Exam Management</h2>
                             <div style="display: flex; gap: 10px;">
                                 <button class="btn btn-sm back-to-dashboard-btn"><i class="fas fa-arrow-left"></i> Back</button>
                             </div>
                         </div>
                         
                         <div style="margin-bottom: 20px; margin-top: -10px; display: flex; flex-direction: column; align-items: center; gap: 10px; width: 220px; margin-left: auto; margin-right: auto;">
                            <button class="btn btn-sm btn-success admin-only" id="downloadExamsBtn" title="Download All Exams" style="width: 100%;"><i class="fas fa-download"></i> Export JSON</button>
                            <button class="btn btn-sm btn-warning admin-only" id="bulkUploadBtn" title="Upload Exam JSON" style="width: 100%;"><i class="fas fa-upload"></i> Bulk Upload JSON</button>
                            <input type="file" id="bulkJsonInput" accept=".json" style="display: none;">
                            <button class="btn btn-sm teacher-only" id="addExamBtn" style="width: 100%;"><i class="fas fa-plus"></i> Add New Exam</button>
                         </div>

                         <div class="table-container scrollable-list" id="manageExamListContainer">
                             <table id="manageExamsTable">
                                 <thead>
                                     <tr>
                                         <th>Exam Title</th>
                                         <th>Exam ID</th>
                                         <th>Subject</th>
                                         <th>Duration</th>
                                         <th class="resources-cell">Resources</th>
                                         <th>Status</th> <!-- NEW -->
                                         <th>Actions</th> <!-- MODIFIED: No longer admin-only -->
                                     </tr>
                                 </thead>
                                 <tbody></tbody>
                             </table>
                         </div>
                         <button class="btn btn-sm" id="showAllManageExamsBtn" style="width: auto; margin-top: 10px; display: none;">
                            <i class="fas fa-chevron-down"></i> Show all exams...
                         </button>
                     </div>

                      <div id="resultsPage" class="page-content hidden">
                         <div class="content-header">
                             <h2>Results & Analytics</h2>
                             <button class="btn btn-sm back-to-dashboard-btn"><i class="fas fa-arrow-left"></i> Back</button>
                         </div>
                         <div class="table-container">
                             <table id="resultsTable">
                                 <thead>
                                     <tr>
                                         <th>Student</th>
                                         <th>Exam</th>
                                         <th>Score</th>
                                         <th>Date</th>
                                         <th>Status</th>
                                         <th>Actions</th> <!-- MODIFIED: No longer admin-only -->
                                     </tr>
                                 </thead>
                                 <tbody></tbody>
                             </table>
                         </div>
                     </div>
                     
                     <!-- NEW: Report Page -->
                     <div id="reportPage" class="page-content hidden">
                         <div class="content-header">
                             <h2 id="reportExamTitle">Exam Report</h2>
                             <button class="btn btn-sm" id="backToResultsBtn"><i class="fas fa-arrow-left"></i> Back to Results</button>
                         </div>
                         
                         <h3>Key Statistics</h3>
                         <div class="stats-container stats-grid-3" style="margin-bottom: 30px;">
                             <div class="stat-card secondary">
                                 <div class="stat-value" id="reportAvgScore">0%</div>
                                 <div class="stat-label">Average Score</div>
                             </div>
                             <div class="stat-card success">
                                 <div class="stat-value" id="reportHighScore">0/0</div>
                                 <div class="stat-label">Highest Score</div>
                             </div>
                             <div class="stat-card danger">
                                 <div class="stat-value" id="reportLowScore">0/0</div>
                                 <div class="stat-label">Lowest Score</div>
                             </div>
                         </div>
                         
                         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                             <div>
                                 <h3>Score Distribution</h3>
                                 <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.05);">
                                     <canvas id="scoreDistributionChart"></canvas>
                                 </div>
                             </div>
                             <div>
                                <h3>Question Analysis</h3>
                                <div class="table-container" style="margin-bottom: 0;">
                                    <table id="questionAnalysisTable">
                                        <thead>
                                            <tr>
                                                <th>Question</th>
                                                <th>Correct</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- populated by JS -->
                                        </tbody>
                                    </table>
                                </div>
                             </div>
                         </div>
                     </div>
                     
                </div>
            </div>
        </div>
        
        <div id="toastContainer"></div>
    </div>

    <!-- Modals -->
    <div class="modal" id="addExamModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Exam</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="examForm">
                <div class="form-group">
                    <label for="examTitleInput">Exam Title</label>
                    <input type="text" id="examTitleInput" class="form-control" placeholder="Enter exam title" required>
                </div>
                <div class="form-group">
                    <label for="examSubject">Subject</label>
                    <select id="examSubject" class="form-control" required>
                        <option value="">Select Subject</option>
                        <option value="math">Mathematics</option>
                        <option value="physics">Physics</option>
                        <option value="chemistry">Chemistry</option>
                        <option value="biology">Biology</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="examDate">Exam Date</label>
                    <input type="date" id="examDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="examDurationInput">Duration (minutes) <small>(0 for untimed)</small></label>
                    <input type="number" id="examDurationInput" class="form-control" placeholder="60" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn" style="width: 100%;">Create & Add Questions</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="editQuestionModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Question</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="editQuestionForm">
                <!-- NEW: Hidden inputs for exam/question ID -->
                <input type="hidden" id="editQuestionExamId">
                <input type="hidden" id="editQuestionIndex">
                
                <div class="form-group">
                    <label for="editQuestionTypeSelect">Question Type</label>
                    <select id="editQuestionTypeSelect" class="form-control" disabled> <!-- Disabled, as changing type is complex -->
                        <option value="single_choice">Single Choice (Radio)</option>
                        <option value="multi_choice">Multiple Choice (Checkbox)</option>
                        <option value="true_false">True / False</option>
                        <option value="short_answer">Short Answer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editQuestionTextInput">Question Text</label>
                    <textarea id="editQuestionTextInput" class="form-control" required></textarea>
                </div>
                
                <div class="question-type-options">
                    <div id="editChoiceOptionsContainer" class="form-group">
                        <label>Options (select correct answer/s)</label>
                        <div class="option-input-group">
                            <input type="radio" name="editCorrectAnswer" value="0" class="edit-correct-answer-input">
                            <input type="text" id="editOption1Input" class="form-control" placeholder="Option 1" required>
                        </div>
                        <div class="option-input-group">
                            <input type="radio" name="editCorrectAnswer" value="1" class="edit-correct-answer-input">
                            <input type="text" id="editOption2Input" class="form-control" placeholder="Option 2" required>
                        </div>
                        <div class="option-input-group">
                            <input type="radio" name="editCorrectAnswer" value="2" class="edit-correct-answer-input">
                            <input type="text" id="editOption3Input" class="form-control" placeholder="Option 3">
                        </div>
                        <div class="option-input-group">
                            <input type="radio" name="editCorrectAnswer" value="3" class="edit-correct-answer-input">
                            <input type="text" id="editOption4Input" class="form-control" placeholder="Option 4">
                        </div>
                    </div>

                    <div id="editTrueFalseContainer" class="form-group hidden">
                        <label>Correct Answer</label>
                        <div class="option-input-group">
                            <input type="radio" name="editTrueFalseAnswer" value="true" class="edit-correct-answer-input" required> True
                        </div>
                        <div class="option-input-group">
                            <input type="radio" name="editTrueFalseAnswer" value="false" class="edit-correct-answer-input"> False
                        </div>
                    </div>
                    
                    <div id="editShortAnswerContainer" class="form-group hidden">
                        <label for="editShortAnswerInput">Correct Answer (Case-insensitive)</label>
                        <input type="text" id="editShortAnswerInput" class="form-control edit-correct-answer-input" placeholder="Enter the exact answer" required>
                    </div>
                </div>
                
                <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">Save Changes</button>
            </form>
        </div>
    </div>

    <div class="modal" id="editUserModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit User</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label for="editUserNameInput">Full Name</label>
                    <input type="text" id="editUserNameInput" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editUserRoleInput">Role</label>
                    <select id="editUserRoleInput" class="form-control" required>
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <div class="modal" id="pdfPreviewModal" data-close="true">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Resource Preview</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <div id="pdfContainer">
                <!-- Iframe will be injected here -->
            </div>
        </div>
    </div>

    <div class="modal" id="addResourceModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Attach Resource</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="resourceForm">
                <input type="hidden" id="resourceExamId">
                <div class="form-group">
                    <label>Resource Type</label>
                    <select id="resourceType" class="form-control">
                        <option value="link">External Link (Reference)</option>
                        <option value="pdf">PDF File</option>
                    </select>
                </div>
                
                <div id="linkInputGroup" class="form-group">
                    <label for="resourceLink">URL</label>
                    <input type="url" id="resourceLink" class="form-control" placeholder="https://example.com">
                </div>

                <div id="pdfInputGroup" class="form-group hidden">
                    <label for="resourcePdf">Upload PDF</label>
                    <input type="file" id="resourcePdf" class="form-control" accept="application/pdf">
                    <p style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">Note: For simulation, PDF is viewable only during this session.</p>
                </div>

                <button type="submit" class="btn">Attach Resource</button>
            </form>
        </div>
    </div>

    <div class="modal" id="securityModal" data-close="true">
        <div class="modal-content mini">
            <i class="fas fa-shield-alt" style="font-size: 3rem; color: var(--warning); margin-bottom: 15px;"></i>
            <h3 style="margin-bottom: 10px;">Admin Access Required</h3>
            <p style="margin-bottom: 20px;">Please enter the admin security code.</p>
            <input type="password" id="securityCodeInput" class="form-control" placeholder="Enter Code" style="text-align: center; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" id="cancelSecurityBtn" data-close="true">Cancel</button>
                <button class="btn" id="confirmSecurityBtn">Verify</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="joinExamModal" data-close="true">
        <div class="modal-content mini">
            <div class="modal-header" style="justify-content: center;">
                <h3>Join Exam by ID</h3>
                <button class="close-modal" data-close="true" style="position: absolute; top: 10px; right: 15px;">&times;</button>
            </div>
             <form id="joinExamForm">
                 <div class="form-group">
                     <label for="joinExamCodeInput" style="text-align: left;">Exam ID</label>
                     <input type="text" id="joinExamCodeInput" class="form-control" placeholder="Enter Exam ID (e.g., EX-XXXX)" required style="text-align: center; text-transform: uppercase;">
                 </div>
                 <button type="submit" class="btn" id="joinExamButton">
                     <span class="btn-text">
                         <i class="fas fa-pencil-alt"></i> Start Exam
                     </span>
                     <div class="spinner"></div>
                 </button>
             </form>
        </div>
    </div>
    
    <div class="modal" id="confirmationModal" data-close="true">
        <div class="modal-content mini">
            <div id="confirmIcon" class="modal-icon danger"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 id="confirmTitle">Are you sure?</h3>
            <p id="confirmText">This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn btn-warning" id="confirmCancelBtn" data-close="true">Cancel</button>
                <button class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Class Modals -->
    <div class="modal" id="createClassModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="createClassTitle">Create New Class</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="createClassForm">
                <div class="form-group">
                    <label for="classNameInput">Class Name</label>
                    <input type="text" id="classNameInput" class="form-control" placeholder="e.g., Grade 10 Physics" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Save Class</button>
            </form>
        </div>
    </div>
    
    <div class="modal" id="manageStudentsModal" data-close="true">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="manageStudentsTitle">Manage Students</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="manageStudentsForm">
                <input type="hidden" id="manageStudentsClassId">
                <p>Select students to add to this class:</p>
                <div class="modal-list" id="studentSelectionList" style="margin-top: 15px;">
                    <!-- Student list populated by JS -->
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">Save Changes</button>
            </form>
        </div>
    </div>
    
    <div class="modal" id="assignExamModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="assignExamTitle">Assign Exam</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="assignExamForm">
                <input type="hidden" id="assignExamClassId">
                <div class="form-group">
                    <label for="assignExamSelect">Select an Exam</label>
                    <select id="assignExamSelect" class="form-control" required>
                        <option value="">-- Select an approved exam --</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Assign Exam</button>
            </form>
        </div>
    </div>


    <script>
        // --- Application State ---
        const state = {
            currentUser: null,
            currentPage: 'dashboard',
            db: null, // Will be initialized in init()
            currentExam: null,
            currentQuestionIndex: 0,
            userAnswers: [],
            examTimer: null,
            timeRemaining: 0,
            editingExamId: null,
            editingQuestionIndex: null,
            editingUserId: null, 
            userFilter: 'all',
            isPreviewMode: false,
            pendingAction: null,
            pendingConfirmation: null, 
            currentChart: null, // NEW: To hold the Chart.js instance
        };

        // --- DOM Element Globals ---
        let authScreen, appScreen, loginForm, registerForm, logoutBtn, authTabs,
            navMenu, pages, dashboardTabs, tabContents, addExamBtn, addExamModal, examForm,
            pendingExamsTableBody, recentExamsTableBody, usersTableBody, manageUsersTableBody,
            resultsTableBody, manageExamsTableBody, examOptionsContainer, prevQuestionBtn,
            nextQuestionBtn, submitExamBtn, backToDashboardBtn, examDoneBtn, examEditorPage,
            examEditorTitle, addQuestionForm, questionList, questionCount,
            editorBackToDashboardBtn, editExamDetailsForm, editQuestionModal,
            editQuestionForm, editUserModal, editUserForm, pdfPreviewModal,
            addResourceModal, securityModal, joinExamModal, joinExamForm,
            joinExamCodeInput, confirmationModal, statsContainer, bulkUploadBtn,
            bulkJsonInput, downloadExamsBtn, mobileNavToggle, sidebar, sidebarClose,
            overlay, usersPageTitle, showAllUsersBtn, showAllManageUsersBtn,
            showAllManageExamsBtn,
            // NEW Elements
            questionTypeSelect, choiceOptionsContainer, trueFalseContainer, shortAnswerContainer,
            editQuestionTypeSelect, editChoiceOptionsContainer, editTrueFalseContainer, editShortAnswerContainer,
            classesPage, classesTableBody, createClassModal, createClassForm, manageStudentsModal,
            manageStudentsForm, studentSelectionList, assignExamModal, assignExamForm,
            assignExamSelect, myExamsPage, assignedExamsTableBody, joinExamByIdBtn,
            reportPage, backToResultsBtn;


        // Mock Database
        class MockDatabase {
            constructor() {
                this.users = JSON.parse(localStorage.getItem('examUsers')) || [];
                this.exams = JSON.parse(localStorage.getItem('examExams')) || [];
                this.results = JSON.parse(localStorage.getItem('examResults')) || [];
                this.classes = JSON.parse(localStorage.getItem('examClasses')) || []; // NEW: Classes
                
                if (this.users.length === 0) {
                    this.initializeDemoData();
                }
                
                this.applyRetentionPolicy();
            }
            
            getRetentionCutoff() {
                const cutoff = new Date();
                cutoff.setFullYear(cutoff.getFullYear() - 2);
                return cutoff;
            }

            applyRetentionPolicy() {
                const cutoffDate = this.getRetentionCutoff();
                const deletedUserIds = [];
                
                const originalUserCount = this.users.length;
                this.users = this.users.filter(user => {
                    if (user.role === 'admin') return true;
                    const joinedDate = new Date(user.joinedDate);
                    if (joinedDate < cutoffDate) {
                        deletedUserIds.push(user.id);
                        return false; 
                    }
                    return true; 
                });
                
                if (deletedUserIds.length > 0) {
                     console.log(`RETENTION POLICY: Removed ${deletedUserIds.length} users.`);
                    this.results = this.results.filter(result => !deletedUserIds.includes(result.studentId));
                    this.exams.forEach(exam => {
                        if (deletedUserIds.includes(exam.teacherId)) {
                            exam.teacher = "Archived User";
                            exam.teacherId = null;
                        }
                    });
                     // NEW: Remove deleted students from classes
                    this.classes.forEach(cls => {
                        cls.studentIds = cls.studentIds.filter(id => !deletedUserIds.includes(id));
                    });
                }
                
                if (this.users.length !== originalUserCount) {
                    this.saveToStorage();
                }
            }
            
            initializeDemoData() {
                const twoYearsAgo = new Date();
                twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                
                this.users = [
                    { id: 1, name: 'Admin User', email: 'admin@examsystem.com', password: 'admin123', role: 'admin', status: 'active', joinedDate: new Date() },
                    { id: 2, name: 'Teacher One (Old)', email: 'teacher@examsystem.com', password: 'teacher123', role: 'teacher', status: 'active', joinedDate: twoYearsAgo },
                    { id: 3, name: 'Student One', email: 'student@examsystem.com', password: 'student123', role: 'student', status: 'active', joinedDate: oneYearAgo },
                    { id: 4, name: 'Teacher Two (New)', email: 'teacher2@examsystem.com', password: 'teacher123', role: 'teacher', status: 'active', joinedDate: new Date() },
                    { id: 5, name: 'Student Two', email: 'student2@examsystem.com', password: 'student123', role: 'student', status: 'active', joinedDate: new Date() }
                ];
                
                this.exams = [
                    { 
                        id: 1, examCode: 'EX-A1B2', title: 'Mathematics Midterm', subject: 'math', 
                        teacher: 'Teacher One (Old)', teacherId: 2, duration: 60, 
                        scheduledDate: '2023-11-15', status: 'pending', 
                        questions: [
                            { type: 'single_choice', question: 'What is 2+2?', options:['3','4','5','6'], correctAnswer: 1 }
                        ],
                        resources: [] 
                    },
                    { 
                        id: 2, examCode: 'EX-C3D4', title: 'Physics Final (Grade 8)', subject: 'physics', 
                        teacher: 'Teacher Two (New)', teacherId: 4, duration: 45, 
                        scheduledDate: '2023-12-20', status: 'approved', 
                        questions: [
                            { type: 'single_choice', question: "What is the unit of force?", options: ["Newton", "Joule", "Watt", "Pascal"], correctAnswer: 0 },
                            { type: 'true_false', question: "The Earth is flat.", correctAnswer: false },
                            { type: 'short_answer', question: "What planet is third from the sun?", correctAnswer: "Earth" },
                            { type: 'multi_choice', question: "Which of these are primary colors?", options: ["Red", "Green", "Blue", "Yellow"], correctAnswer: [0, 2, 3] },
                            { type: 'single_choice', question: "Gravity on Earth is approx?", options: ["9.8 m/s^2", "10.5 m/s^2", "5 m/s^2", "15 m/s^2"], correctAnswer: 0 }
                        ],
                        resources: []
                    }
                ];

                this.results = [
                    { id: 101, studentId: 3, studentName: "Student One", examId: 2, examTitle: "Physics Final (Grade 8)", 
                      score: 4, total: 5, date: new Date().toLocaleString(), status: 'active',
                      // NEW: Store all answers
                      answers: [0, false, "Earth", [0, 2, 3], 0] 
                    }
                ];
                
                // NEW: Demo Class
                this.classes = [
                    { id: 1001, name: "Grade 8 Physics", teacherId: 4, studentIds: [3], assignedExamIds: [2] }
                ];
                
                this.saveToStorage();
            }
            
            saveToStorage() {
                localStorage.setItem('examUsers', JSON.stringify(this.users));
                localStorage.setItem('examExams', JSON.stringify(this.exams));
                localStorage.setItem('examResults', JSON.stringify(this.results));
                localStorage.setItem('examClasses', JSON.stringify(this.classes)); // NEW
            }
            
            findUserByEmail(email) { return this.users.find(user => user.email === email); }
            findUserById(id) { return this.users.find(user => user.id === id); } 
            
            createUser(userData) {
                const newUser = { id: Date.now(), ...userData, status: 'active', joinedDate: new Date() };
                this.users.push(newUser);
                this.saveToStorage();
                return newUser;
            }
            
            updateUser(userId, updates) {
                const user = this.findUserById(userId);
                if (user) { Object.assign(user, updates); this.saveToStorage(); return user; }
                return null;
            }
            
            getExams() { return this.exams; }
            findExamById(id) { return this.exams.find(e => e.id === id); }
            findExamByCode(code) { return this.exams.find(e => e.examCode && e.examCode.toUpperCase() === code.toUpperCase()); } 
            
            generateExamCode() {
                let code;
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ123456789';
                do {
                    code = 'EX-';
                    for(let i=0; i<4; i++) { code += chars.charAt(Math.floor(Math.random() * chars.length)); }
                } while (this.findExamByCode(code));
                return code;
            }
            
            createExam(examData) {
                const newExam = { id: Date.now(), examCode: this.generateExamCode(), resources: [], ...examData, questions: examData.questions || [] };
                this.exams.push(newExam);
                this.saveToStorage();
                return newExam;
            }
            updateExam(examId, updates) {
                 const exam = this.findExamById(examId);
                 if (exam) { Object.assign(exam, updates); this.saveToStorage(); return exam; }
                 return null;
            }
            deleteExam(examId) { 
                this.exams = this.exams.filter(e => e.id !== examId);
                this.results = this.results.filter(r => r.examId !== examId);
                // NEW: Remove from classes
                this.classes.forEach(cls => {
                    cls.assignedExamIds = cls.assignedExamIds.filter(id => id !== examId);
                });
                this.saveToStorage();
            }
            updateExamStatus(examId, status) {
                const exam = this.findExamById(examId);
                if (exam) { exam.status = status; this.saveToStorage(); return exam; }
                return null;
            }
            addQuestionToExam(examId, questionData) {
                const exam = this.findExamById(examId);
                if (exam) { exam.questions.push(questionData); this.saveToStorage(); }
            }
            deleteQuestionFromExam(examId, questionIndex) {
                const exam = this.findExamById(examId);
                if (exam && exam.questions[questionIndex]) { exam.questions.splice(questionIndex, 1); this.saveToStorage(); }
            }
            updateQuestionInExam(examId, questionIndex, questionData) {
                const exam = this.findExamById(examId);
                if (exam && exam.questions[questionIndex]) { exam.questions[questionIndex] = questionData; this.saveToStorage(); }
            }
            addResourceToExam(examId, resource) {
                const exam = this.findExamById(examId);
                if(exam) { if(!exam.resources) exam.resources = []; exam.resources.push(resource); this.saveToStorage(); }
            }
            
            bulkImportExams(examsArray, importingUser) {
                examsArray.forEach(ex => {
                    const newExam = { ...ex, id: Date.now() + Math.floor(Math.random() * 1000), examCode: this.generateExamCode(), status: 'approved', teacher: importingUser.name, teacherId: importingUser.id };
                    this.exams.push(newExam);
                });
                this.saveToStorage();
            }
            
            saveResult(resultData) {
                const newResult = { id: Date.now(), ...resultData, date: new Date().toLocaleString(), status: 'active' };
                this.results.push(newResult);
                this.saveToStorage();
            }
            deleteResult(resultId) {
                this.results = this.results.filter(r => r.id !== resultId);
                this.saveToStorage();
            }
            updateResultStatus(resultId, status) {
                const result = this.results.find(r => r.id === resultId);
                if (result) { result.status = status; this.saveToStorage(); }
            }
            hasStudentTakenExam(studentId, examId) {
                return this.results.some(r => r.studentId === studentId && r.examId === examId && r.status === 'active');
            }
            
            // --- NEW: Class Methods ---
            getClasses(teacherId) {
                if (teacherId) {
                    return this.classes.filter(cls => cls.teacherId === teacherId);
                }
                return this.classes; // Admin gets all
            }
            findClassById(id) { return this.classes.find(cls => cls.id === id); }
            createClass(className, teacherId) {
                const newClass = { id: Date.now(), name: className, teacherId: teacherId, studentIds: [], assignedExamIds: [] };
                this.classes.push(newClass);
                this.saveToStorage();
                return newClass;
            }
            updateClassStudents(classId, studentIds) {
                const cls = this.findClassById(classId);
                if (cls) { cls.studentIds = studentIds; this.saveToStorage(); }
            }
            assignExamToClass(classId, examId) {
                const cls = this.findClassById(classId);
                if (cls && !cls.assignedExamIds.includes(examId)) {
                    cls.assignedExamIds.push(examId);
                    this.saveToStorage();
                }
            }
        }

        // --- Main App Initialization ---
        function init() {
            // Assign all element variables now that the DOM is ready
            authScreen = document.getElementById('authScreen');
            appScreen = document.getElementById('appScreen');
            loginForm = document.getElementById('loginForm');
            registerForm = document.getElementById('registerForm');
            logoutBtn = document.getElementById('logoutBtn');
            authTabs = document.querySelectorAll('.auth-tab');
            navMenu = document.getElementById('navMenu');
            pages = document.querySelectorAll('.page-content');
            dashboardTabs = document.getElementById('dashboardTabs');
            tabContents = document.querySelectorAll('.tab-content');
            addExamBtn = document.getElementById('addExamBtn');
            addExamModal = document.getElementById('addExamModal');
            examForm = document.getElementById('examForm');
            pendingExamsTableBody = document.getElementById('pendingExamsTable').querySelector('tbody');
            recentExamsTableBody = document.getElementById('recentExamsTable').querySelector('tbody');
            usersTableBody = document.getElementById('usersTable').querySelector('tbody');
            manageUsersTableBody = document.getElementById('manageUsersTable').querySelector('tbody');
            resultsTableBody = document.getElementById('resultsTable').querySelector('tbody');
            manageExamsTableBody = document.getElementById('manageExamsTable').querySelector('tbody');
            examOptionsContainer = document.getElementById('examOptionsContainer');
            prevQuestionBtn = document.getElementById('prevQuestion');
            nextQuestionBtn = document.getElementById('nextQuestion');
            submitExamBtn = document.getElementById('submitExam');
            backToDashboardBtn = document.getElementById('backToDashboardBtn');
            examDoneBtn = document.getElementById('examDoneBtn');
            examEditorPage = document.getElementById('examEditorPage');
            examEditorTitle = document.getElementById('examEditorTitle');
            addQuestionForm = document.getElementById('addQuestionForm');
            questionList = document.getElementById('questionList');
            questionCount = document.getElementById('questionCount');
            editorBackToDashboardBtn = document.getElementById('editorBackToDashboardBtn');
            editExamDetailsForm = document.getElementById('editExamDetailsForm');
            editQuestionModal = document.getElementById('editQuestionModal');
            editQuestionForm = document.getElementById('editQuestionForm');
            editUserModal = document.getElementById('editUserModal');
            editUserForm = document.getElementById('editUserForm');
            pdfPreviewModal = document.getElementById('pdfPreviewModal');
            addResourceModal = document.getElementById('addResourceModal');
            securityModal = document.getElementById('securityModal');
            joinExamModal = document.getElementById('joinExamModal');
            joinExamForm = document.getElementById('joinExamForm');
            joinExamCodeInput = document.getElementById('joinExamCodeInput');
            confirmationModal = document.getElementById('confirmationModal');
            statsContainer = document.getElementById('statsContainer');
            bulkUploadBtn = document.getElementById('bulkUploadBtn');
            bulkJsonInput = document.getElementById('bulkJsonInput');
            downloadExamsBtn = document.getElementById('downloadExamsBtn');
            mobileNavToggle = document.getElementById('mobileNavToggle');
            sidebar = document.getElementById('sidebar');
            sidebarClose = document.getElementById('sidebarClose');
            overlay = document.getElementById('overlay');
            usersPageTitle = document.getElementById('usersPageTitle');
            showAllUsersBtn = document.getElementById('showAllUsersBtn');
            showAllManageUsersBtn = document.getElementById('showAllManageUsersBtn');
            showAllManageExamsBtn = document.getElementById('showAllManageExamsBtn');
            
            // NEW Elements
            questionTypeSelect = document.getElementById('questionTypeSelect');
            choiceOptionsContainer = document.getElementById('choiceOptionsContainer');
            trueFalseContainer = document.getElementById('trueFalseContainer');
            shortAnswerContainer = document.getElementById('shortAnswerContainer');
            editQuestionTypeSelect = document.getElementById('editQuestionTypeSelect');
            editChoiceOptionsContainer = document.getElementById('editChoiceOptionsContainer');
            editTrueFalseContainer = document.getElementById('editTrueFalseContainer');
            editShortAnswerContainer = document.getElementById('editShortAnswerContainer');
            classesPage = document.getElementById('classesPage');
            classesTableBody = document.getElementById('classesTable').querySelector('tbody');
            createClassModal = document.getElementById('createClassModal');
            createClassForm = document.getElementById('createClassForm');
            manageStudentsModal = document.getElementById('manageStudentsModal');
            manageStudentsForm = document.getElementById('manageStudentsForm');
            studentSelectionList = document.getElementById('studentSelectionList');
            assignExamModal = document.getElementById('assignExamModal');
            assignExamForm = document.getElementById('assignExamForm');
            assignExamSelect = document.getElementById('assignExamSelect');
            myExamsPage = document.getElementById('myExamsPage');
            assignedExamsTableBody = document.getElementById('assignedExamsTable').querySelector('tbody');
            joinExamByIdBtn = document.getElementById('joinExamByIdBtn');
            reportPage = document.getElementById('reportPage');
            backToResultsBtn = document.getElementById('backToResultsBtn');

            // Initialize database
            state.db = new MockDatabase();

            // Check for saved user
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                state.currentUser = JSON.parse(savedUser);
                if (!state.db.findUserById(state.currentUser.id)) {
                    handleLogout(); 
                    return;
                }
                showApp();
            } else {
                showAuth();
            }
            setupEventListeners();
            updateUI();
        }

        // --- Event Listener Setup ---
        function setupEventListeners() {
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    switchAuthTab(tab.getAttribute('data-tab'));
                });
            });
            
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            logoutBtn.addEventListener('click', handleLogout);
            
            joinExamForm.addEventListener('submit', handleJoinExam);
            joinExamByIdBtn.addEventListener('click', () => { // NEW
                joinExamCodeInput.value = '';
                joinExamModal.style.display = 'flex';
            });

            document.getElementById('confirmCancelBtn').addEventListener('click', () => {
                confirmationModal.style.display = 'none';
                state.pendingConfirmation = null;
            });
            document.getElementById('confirmActionBtn').addEventListener('click', () => {
                if (state.pendingConfirmation) {
                    state.pendingConfirmation();
                }
                confirmationModal.style.display = 'none';
                state.pendingConfirmation = null;
            });
            
            navMenu.addEventListener('click', (e) => {
                const link = e.target.closest('.nav-link');
                if (!link) return;

                e.preventDefault();
                const page = link.dataset.page;
                if (page === 'users') {
                    state.userFilter = 'all';
                    updateTables();
                }
                if (page === 'exams') {
                    renderExamManagementTable();
                }
                if (page === 'classes') { // NEW
                    renderClassesTable();
                }
                if (page === 'myExams') { // NEW
                    renderMyExams();
                }
                handleNavClick(page);
                if (window.innerWidth <= 900) closeSidebar();
            });
            
            dashboardTabs.addEventListener('click', (e) => {
                const tab = e.target.closest('.tab');
                if (!tab) return;
                switchTab(tab.getAttribute('data-tab'));
            });
            
            addExamBtn.addEventListener('click', () => {
                 // MODIFIED: Teachers don't need code
                if (state.currentUser.role === 'teacher') {
                    addExamModal.style.display = 'flex';
                } else {
                    performAdminAction(() => {
                        addExamModal.style.display = 'flex';
                    });
                }
            });
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target.dataset.close === 'true') {
                        modal.style.display = 'none';
                        if(modal.id === 'securityModal') state.pendingAction = null;
                        if(modal.id === 'confirmationModal') state.pendingConfirmation = null;
                    }
                });
            });

            examForm.addEventListener('submit', handleCreateExam);
            
            pendingExamsTableBody.addEventListener('click', handleDashboardTableClick);
            recentExamsTableBody.addEventListener('click', handleDashboardTableClick);
            manageExamsTableBody.addEventListener('click', handleExamManagementClick);
            manageUsersTableBody.addEventListener('click', handleUserManagementClick); 
            resultsTableBody.addEventListener('click', handleResultsTableClick);
            
            submitExamBtn.addEventListener('click', handleSubmitExam);
            nextQuestionBtn.addEventListener('click', handleNextQuestion);
            prevQuestionBtn.addEventListener('click', handlePrevQuestion);
            
            backToDashboardBtn.addEventListener('click', handleBackToDashboard); 
            examDoneBtn.addEventListener('click', handleBackToDashboard); 
            backToResultsBtn.addEventListener('click', () => handleNavClick('results')); // NEW
            
            document.querySelectorAll('.back-to-dashboard-btn').forEach(btn => {
                btn.addEventListener('click', handleBackToDashboard); 
            });
            editorBackToDashboardBtn.addEventListener('click', handleBackToDashboard);

            examOptionsContainer.addEventListener('click', (e) => {
                const clickedOption = e.target.closest('.option');
                if (!clickedOption) return;
                if (state.isPreviewMode) return;

                const q = state.currentExam.questions[state.currentQuestionIndex];
                
                // NEW: Handle multi_choice
                if (q.type === 'multi_choice') {
                    clickedOption.classList.toggle('selected');
                    const checkbox = clickedOption.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                } else {
                    // Single choice (radio or T/F)
                    examOptionsContainer.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                    clickedOption.classList.add('selected');
                    const radio = clickedOption.querySelector('input[type="radio"]');
                    if (radio) radio.checked = true;
                }
                saveAnswer();
            });
            
            // NEW: Save answer on text input change
            examOptionsContainer.addEventListener('input', (e) => {
                if (e.target.id === 'shortAnswerInput') {
                    saveAnswer();
                }
            });
            
            addQuestionForm.addEventListener('submit', handleAddQuestion);
            questionTypeSelect.addEventListener('change', handleQuestionTypeChange); // NEW
            
            questionList.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-question');
                const deleteBtn = e.target.closest('.delete-question');
                if (editBtn) { openEditQuestionModal(state.editingExamId, parseInt(editBtn.dataset.index)); }
                if (deleteBtn) { handleDeleteQuestion(state.editingExamId, parseInt(deleteBtn.dataset.index)); }
            });
            
            editQuestionForm.addEventListener('submit', handleUpdateQuestion);
            editUserForm.addEventListener('submit', handleUpdateUser); 
            editExamDetailsForm.addEventListener('submit', handleUpdateExamDetails);

            mobileNavToggle.addEventListener('click', openSidebar);
            sidebarClose.addEventListener('click', closeSidebar);
            overlay.addEventListener('click', closeSidebar);
            
            statsContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.stat-card.clickable');
                if (!card) return; 
                if (!state.currentUser) return; 

                const page = card.dataset.page;
                const filter = card.dataset.filter;

                if (state.currentUser.role === 'student' && (page === 'users' || page === 'exams' || page === 'results')) return; 
                if (page === 'users') {
                    state.userFilter = filter || 'all';
                    updateTables(); 
                }
                if (page === 'exams') {
                    renderExamManagementTable();
                }
                if (page === 'myExams') { // NEW
                    renderMyExams();
                }
                handleNavClick(page);
            });

            bulkUploadBtn.addEventListener('click', () => {
                performAdminAction(() => {
                    bulkJsonInput.click();
                });
            });
            bulkJsonInput.addEventListener('change', handleBulkUpload);
            downloadExamsBtn.addEventListener('click', exportExams);

            const resourceType = document.getElementById('resourceType');
            resourceType.addEventListener('change', () => {
                if(resourceType.value === 'pdf') {
                    document.getElementById('pdfInputGroup').classList.remove('hidden');
                    document.getElementById('linkInputGroup').classList.add('hidden');
                } else {
                    document.getElementById('pdfInputGroup').classList.add('hidden');
                    document.getElementById('linkInputGroup').classList.remove('hidden');
                }
            });
            document.getElementById('resourceForm').addEventListener('submit', handleAddResource);
            
            document.getElementById('confirmSecurityBtn').addEventListener('click', verifySecurityCode);
            document.getElementById('cancelSecurityBtn').addEventListener('click', () => {
                securityModal.style.display = 'none';
                state.pendingAction = null;
            });

            document.body.addEventListener('click', (e) => {
                const trigger = e.target.closest('.mobile-menu-trigger');
                
                document.querySelectorAll('.action-buttons.show').forEach(el => {
                    if(!trigger || el !== trigger.closest('.action-wrapper').querySelector('.action-buttons')) {
                        el.classList.remove('show');
                        el.classList.remove('drop-up'); 
                    }
                });

                if(trigger) {
                    const container = trigger.closest('.action-wrapper').querySelector('.action-buttons');
                    
                    const rect = trigger.getBoundingClientRect();
                    const isNearBottom = (window.innerHeight - rect.bottom) < 160; 
                    if (isNearBottom) {
                        container.classList.add('drop-up');
                    } else {
                        container.classList.remove('drop-up');
                    }
                    
                    container.classList.toggle('show');
                }
            });
            
            showAllUsersBtn.addEventListener('click', () => {
                document.getElementById('dashboardUserListContainer').classList.toggle('expanded');
                showAllUsersBtn.classList.toggle('active');
                if (showAllUsersBtn.classList.contains('active')) {
                    showAllUsersBtn.innerHTML = `<i class="fas fa-chevron-up"></i> Show fewer`;
                } else {
                    showAllUsersBtn.innerHTML = `<i class="fas fa-chevron-down"></i> Show all...`;
                }
                updateTables(true); 
            });
            
            showAllManageUsersBtn.addEventListener('click', () => {
                document.getElementById('manageUserListContainer').classList.toggle('expanded');
                showAllManageUsersBtn.classList.toggle('active');
                if (showAllManageUsersBtn.classList.contains('active')) {
                    showAllManageUsersBtn.innerHTML = `<i class="fas fa-chevron-up"></i> Show fewer`;
                } else {
                    showAllManageUsersBtn.innerHTML = `<i class="fas fa-chevron-down"></i> Show all users...`;
                }
                updateTables(true); 
            });

            showAllManageExamsBtn.addEventListener('click', () => {
                document.getElementById('manageExamListContainer').classList.toggle('expanded');
                showAllManageExamsBtn.classList.toggle('active');
                if (showAllManageExamsBtn.classList.contains('active')) {
                    showAllManageExamsBtn.innerHTML = `<i class="fas fa-chevron-up"></i> Show fewer`;
                } else {
                    showAllManageExamsBtn.innerHTML = `<i class="fas fa-chevron-down"></i> Show all exams...`;
                }
                renderExamManagementTable(); 
            });
            
            // NEW: Class Management Listeners
            document.getElementById('createClassBtn').addEventListener('click', () => {
                createClassForm.reset();
                createClassModal.style.display = 'flex';
            });
            createClassForm.addEventListener('submit', handleCreateClass);
            classesTableBody.addEventListener('click', handleClassesTableClick);
            manageStudentsForm.addEventListener('submit', handleUpdateClassStudents);
            assignExamForm.addEventListener('submit', handleAssignExamToClass);
            
            // NEW: Student Exam List Listener
            assignedExamsTableBody.addEventListener('click', (e) => {
                const startBtn = e.target.closest('.start-exam-btn');
                if (startBtn) {
                    const examId = parseInt(startBtn.dataset.id);
                    startExam(examId, false);
                }
            });
        }
        
        // --- Toast & Modal ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            toast.innerHTML = `<i class="fas ${icon}" style="color: var(--${type === 'info' ? 'primary' : type});"></i> <span class="toast-message">${message}</span>`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        container.removeChild(toast);
                    }
                }, 300); 
            }, 3000);
        }
        
        function showConfirmation(title, text, onConfirm, type = 'danger') {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmText').textContent = text;
            const iconDiv = document.getElementById('confirmIcon');
            const confirmBtn = document.getElementById('confirmActionBtn');
            iconDiv.className = `modal-icon ${type}`;
            confirmBtn.className = `btn btn-${type}`;
            if(type === 'danger') { iconDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i>`; }
            else if (type === 'warning') { iconDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i>`; }
            else { iconDiv.innerHTML = `<i class="fas fa-question-circle"></i>`; }
            state.pendingConfirmation = onConfirm;
            confirmationModal.style.display = 'flex';
        }
        
        function setButtonLoading(button, isLoading) {
            button.disabled = isLoading;
            button.classList.toggle('loading', isLoading);
        }

        function performAdminAction(callback) {
            if(state.currentUser.role !== 'admin') {
                showToast("This action requires admin privileges.", "error");
                return;
            }
            state.pendingAction = callback;
            document.getElementById('securityCodeInput').value = '';
            securityModal.style.display = 'flex';
        }

        function verifySecurityCode() {
            const code = document.getElementById('securityCodeInput').value;
            if (code === "ADMIN123") {
                securityModal.style.display = 'none';
                if(state.pendingAction) state.pendingAction();
                showToast("Admin action verified.", "success");
            } else {
                showToast("Access Denied: Invalid Code", "error");
            }
            state.pendingAction = null;
        }

        // --- Navigation & UI ---
        function openSidebar() { sidebar.classList.add('open'); overlay.classList.add('open'); }
        function closeSidebar() { sidebar.classList.remove('open'); overlay.classList.remove('open'); }
        
        function handleNavClick(page) {
            // MODIFIED: No longer opens modal directly
            if (page !== 'takeExam') {
                 switchPage(page);
            }
            if(page === 'results') renderResultsTable();
            if(page === 'users') updateTables(); 
            
            navMenu.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.page === page));
        }
        
        function handleBackToDashboard() {
            if (state.examTimer) clearInterval(state.examTimer);
            state.currentExam = null;
            state.editingExamId = null;
            state.isPreviewMode = false;

            // FIX: Add a check for currentUser. If it's null (during logout), just switch to dashboard
            // without trying to read 'role' or update stats.
            if (!state.currentUser) {
                switchPage('dashboard');
                return;
            }

            // NEW: Student goes back to My Exams, others go to Dashboard
            const homePage = state.currentUser.role === 'student' ? 'myExams' : 'dashboard';
            
            if (homePage === 'dashboard') {
                switchPage('dashboard');
                navMenu.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.page === 'dashboard'));
            } else {
                renderMyExams();
                switchPage('myExams');
                navMenu.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.page === 'myExams'));
            }
            
            if (state.currentUser) {
                updateTables(); 
                updateStats(); 
            }
        }
        
        function handleDashboardTableClick(e) {
            const btn = e.target.closest('button');
            if(!btn || btn.classList.contains('mobile-menu-trigger')) return; 
            
            const examId = parseInt(btn.dataset.id);
            const action = btn.classList.contains('approve-exam') ? 'approve' :
                           btn.classList.contains('reject-exam') ? 'reject' :
                           btn.classList.contains('edit-exam') ? 'edit' : null;

            if (!action) return;

            // All are admin actions
            performAdminAction(() => { 
                if (action === 'approve') {
                    state.db.updateExamStatus(examId, 'approved'); 
                    showToast("Exam approved.", "success");
                } else if (action === 'reject') {
                    state.db.updateExamStatus(examId, 'rejected'); 
                    showToast("Exam rejected.", "info");
                } else if (action === 'edit') {
                    openExamEditor(examId); 
                    return; // Don't update tables yet
                }
                updateTables(); 
                updateStats(); 
            });
        }
        
        function handleExamManagementClick(e) {
            const target = e.target.closest('button');
            if(!target || target.classList.contains('mobile-menu-trigger')) return;
            
            const id = parseInt(target.dataset.id);
            const actionCallback = () => {
                if(target.classList.contains('btn-resource')) {
                    document.getElementById('resourceExamId').value = id;
                    document.getElementById('resourceForm').reset();
                    document.getElementById('resourceType').value = 'link';
                    document.getElementById('pdfInputGroup').classList.add('hidden');
                    document.getElementById('linkInputGroup').classList.remove('hidden');
                    addResourceModal.style.display = 'flex';
                } else if (target.classList.contains('edit-exam')) {
                    openExamEditor(id);
                } else if (target.classList.contains('delete-exam')) {
                    const exam = state.db.findExamById(id);
                    showConfirmation("Delete Exam?", `Are you sure you want to delete "${exam.title}"? This will also remove all results. This cannot be undone.`, () => {
                        state.db.deleteExam(id);
                        renderExamManagementTable();
                        updateTables(); 
                        updateStats();
                        showToast("Exam deleted successfully.", "success");
                    });
                }
            };

            if(target.classList.contains('preview-exam-btn')) {
                 startExam(id, true); // Preview doesn't require admin code
            } else if(target.classList.contains('btn-resource') || target.classList.contains('edit-exam') || target.classList.contains('delete-exam')) {
                // MODIFIED: Admin or Teacher can edit/delete their own
                const exam = state.db.findExamById(id);
                if (state.currentUser.role === 'admin' || (state.currentUser.role === 'teacher' && exam.teacherId === state.currentUser.id)) {
                    // Teachers don't need security code for their own exams
                    if (state.currentUser.role === 'teacher') {
                        actionCallback();
                    } else {
                        performAdminAction(actionCallback); // Admin needs code
                    }
                } else {
                    showToast("You can only edit or delete your own exams.", "error");
                }
            } else if(target.classList.contains('btn-preview-resource')) {
                 const url = target.dataset.url;
                 const type = target.dataset.type;
                 if(type === 'pdf') {
                     document.getElementById('pdfContainer').innerHTML = `<iframe class="iframe-preview" src="${url}"></iframe>`;
                     pdfPreviewModal.style.display = 'flex';
                 } else { window.open(url, '_blank'); }
            }
        }
        
        function handleUserManagementClick(e) {
            const target = e.target.closest('button');
            if (!target || target.classList.contains('mobile-menu-trigger')) return;
            
            const userId = parseInt(target.dataset.id);
            const user = state.db.findUserById(userId);
            if (!user) return;
            
            // All user actions are admin-only
            performAdminAction(() => {
                if (target.classList.contains('edit-user')) {
                    openEditUserModal(userId);
                } else if (target.classList.contains('deactivate-user')) {
                    showConfirmation("Deactivate User?", `Are you sure you want to deactivate ${user.name}? They will not be able to log in.`, () => {
                        state.db.updateUser(userId, { status: 'deactivated' });
                        updateTables();
                        showToast("User deactivated.", "success");
                    });
                } else if (target.classList.contains('activate-user')) {
                    showConfirmation("Activate User?", `Are you sure you want to activate ${user.name}? They will be able to log in again.`, () => {
                        state.db.updateUser(userId, { status: 'active' });
                        updateTables();
                        showToast("User activated.", "success");
                    }, 'success'); 
                }
            });
        }

        function openEditUserModal(userId) {
            const user = state.db.findUserById(userId);
            if (!user) { showToast("Could not find user.", "error"); return; }
            state.editingUserId = userId;
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserNameInput').value = user.name;
            document.getElementById('editUserRoleInput').value = user.role;
            editUserModal.style.display = 'flex';
        }
        
        function handleUpdateUser(e) {
            e.preventDefault();
            const userId = parseInt(document.getElementById('editUserId').value);
            const newName = document.getElementById('editUserNameInput').value;
            const newRole = document.getElementById('editUserRoleInput').value;
            state.db.updateUser(userId, { name: newName, role: newRole });
            editUserModal.style.display = 'none';
            updateTables(); 
            showToast("User updated successfully.", "success");
        }

        function handleBulkUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const exams = JSON.parse(event.target.result);
                    if(Array.isArray(exams)) {
                        state.db.bulkImportExams(exams, state.currentUser);
                        showToast(`Bulk upload successful! ${exams.length} exams added.`, "success");
                        renderExamManagementTable();
                        updateTables(); 
                        updateStats();
                    } else { showToast("Invalid JSON format. Expected an array.", "error"); }
                } catch(err) { 
                    showToast("Error parsing JSON file.", "error"); 
                    console.error("JSON Parse Error:", err); 
                }
            };
            reader.readAsText(file);
            e.target.value = ''; 
        }

        function exportExams() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.db.exams));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "exams_export.json");
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast("Exams exported successfully.", "success");
        }

        function handleAddResource(e) {
            e.preventDefault();
            const examId = parseInt(document.getElementById('resourceExamId').value);
            const type = document.getElementById('resourceType').value;
            let resource = { type: type };
            if(type === 'link') {
                resource.url = document.getElementById('resourceLink').value;
                if(!resource.url) { showToast("Please enter a valid URL.", "error"); return; }
                resource.label = "External Link";
            } else {
                const fileInput = document.getElementById('resourcePdf');
                if(fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    resource.url = URL.createObjectURL(file);
                    resource.label = "PDF Document";
                } else {
                    showToast("Please select a PDF file to upload.", "error"); return;
                }
            }
            state.db.addResourceToExam(examId, resource);
            addResourceModal.style.display = 'none';
            renderExamManagementTable();
            showToast("Resource added successfully.", "success");
        }

        function renderExamManagementTable() {
            const examListContainer = document.getElementById('manageExamListContainer');
            const showAllBtn = document.getElementById('showAllManageExamsBtn');
            const isExpanded = examListContainer.classList.contains('expanded');

            manageExamsTableBody.innerHTML = '';
            const isAdmin = state.currentUser.role === 'admin';
            const isTeacher = state.currentUser.role === 'teacher';
            
            const subjectMap = { 'math': 'Math', 'physics': 'Physics', 'chemistry': 'Chemistry', 'biology': 'Biology' };
            const subjectMapMobile = { 'math': 'Mat', 'physics': 'Phy', 'chemistry': 'Chem', 'biology': 'Bio' };

            let exams = state.db.exams;
            // NEW: Filter for teachers
            if (isTeacher) {
                exams = exams.filter(exam => exam.teacherId === state.currentUser.id);
            }
            
            const examsToShow = isExpanded ? exams : exams.slice(0, 3);
            showAllBtn.style.display = (exams.length > 3) ? 'flex' : 'none';

            if (examsToShow.length === 0) {
                manageExamsTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="7"><i class="fas fa-file-excel"></i>No exams found.</td></tr>`;
                return;
            }

            examsToShow.forEach(exam => {
                let resourceButtons = '';
                if(exam.resources && exam.resources.length > 0) {
                    exam.resources.forEach(r => {
                        const icon = r.type === 'pdf' ? 'fa-file-pdf' : 'fa-link';
                        resourceButtons += `<button class="btn-icon btn-preview-resource" data-url="${r.url}" data-type="${r.type}" title="View ${r.label}"><i class="fas ${icon}"></i></button>`;
                    });
                } else {
                    resourceButtons = `<span style="font-size: 0.8rem; color: var(--gray);">None</span>`;
                }

                const editButtons = `
                    <div class="action-wrapper">
                        <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                        <div class="action-buttons">
                            <button class="action-btn preview-exam-btn" data-id="${exam.id}" title="Preview"><i class="fas fa-eye"></i> Preview</button>
                            <button class="action-btn btn-resource" data-id="${exam.id}" title="Add Resource"><i class="fas fa-paperclip"></i> Resource</button>
                            <button class="action-btn edit-exam" data-id="${exam.id}" title="Edit"><i class="fas fa-edit"></i> Edit</button>
                            <button class="action-btn reject-exam delete-exam" data-id="${exam.id}" title="Delete"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                `;
                
                const subLower = exam.subject.toLowerCase();
                const fullSub = subjectMap[subLower] || exam.subject;
                const shortSub = subjectMapMobile[subLower] || exam.subject.substring(0,3);
                const subjectDisplay = `<span class="desktop-text">${fullSub}</span><span class="mobile-text">${shortSub}</span>`;
                
                const statusMap = {
                    'pending': '<span class="status status-pending">Pending</span>',
                    'approved': '<span class="status status-approved">Approved</span>',
                    'rejected': '<span class="status status-deactivated">Rejected</span>'
                };

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Title">${exam.title}</td>
                    <td data-label="Exam ID"><span style="background: #eee; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-weight: bold; user-select: all;">${exam.examCode}</span></td>
                    <td data-label="Subject">${subjectDisplay}</td>
                    <td data-label="Duration">${exam.duration === 0 ? 'Untimed' : exam.duration + ' mins'}</td>
                    <td data-label="Resources" class="resources-cell">${resourceButtons}</td>
                    <td data-label="Status">${statusMap[exam.status] || 'N/A'}</td>
                    <td data-label="Actions">${editButtons}</td>
                `;
                manageExamsTableBody.appendChild(row);
            });
        }
        
        function renderResultsTable() {
            resultsTableBody.innerHTML = '';
            const isAdmin = state.currentUser.role === 'admin';
            const isTeacher = state.currentUser.role === 'teacher';
            
            let results = state.db.results;
            
            // NEW: Filter for teachers
            if (isTeacher) {
                const myExamIds = state.db.exams
                    .filter(exam => exam.teacherId === state.currentUser.id)
                    .map(exam => exam.id);
                results = results.filter(result => myExamIds.includes(result.examId));
            }
            
            if(results.length === 0) {
                resultsTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="6"><i class="fas fa-chart-bar"></i>No results found.</td></tr>`;
                return;
            }
            
            results.forEach(r => {
                 const row = document.createElement('tr');
                 const percentage = Math.round((r.score / r.total) * 100);
                 const status = r.status || 'active';
                 const statusClass = status === 'active' ? 'status-active' : 'status-retaken';
                 const statusText = status === 'active' ? 'Active' : 'Retaken';
                 
                 if (status === 'retaken') {
                     row.classList.add('result-retaken');
                 }
                 
                 // MODIFIED: Admins see all actions, teachers only see View Report
                 const actionButtons = `
                     <div class="action-wrapper">
                         <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                         <div class="action-buttons">
                            <button class="action-btn view-report" data-id="${r.examId}" title="View Report"><i class="fas fa-chart-pie"></i> View Report</button>
                            ${isAdmin && status === 'active' ? `<button class="action-btn reset-result" data-id="${r.id}" title="Reset Attempt"><i class="fas fa-redo"></i> Reset Attempt</button>` : ''}
                            ${isAdmin ? `<button class="action-btn delete-result" data-id="${r.id}" title="Delete"><i class="fas fa-trash"></i> Delete Result</button>` : ''}
                         </div>
                     </div>
                 `;
                 
                 row.innerHTML = `
                     <td data-label="Student">${r.studentName}</td>
                     <td data-label="Exam">${r.examTitle}</td>
                     <td data-label="Score">${r.score} / ${r.total} (${percentage}%)</td>
                     <td data-label="Date">${r.date}</td>
                     <td data-label="Status"><span class="status ${statusClass}">${statusText}</span></td>
                     <td data-label="Actions">${actionButtons}</td>
                 `;
                 resultsTableBody.appendChild(row);
            });
        }
        
        function handleResultsTableClick(e) {
            const btn = e.target.closest('button');
            if(!btn || btn.classList.contains('mobile-menu-trigger')) return;
            
            const id = parseInt(btn.dataset.id);

            // NEW: View Report
            if(btn.classList.contains('view-report')) {
                renderReportPage(id); // id here is examId
                return;
            }
            
            // All other actions are admin-only
            if (state.currentUser.role !== 'admin') return;

            const result = state.db.results.find(r=>r.id===id);
            if(btn.classList.contains('reset-result')) {
                performAdminAction(() => {
                    showConfirmation("Reset Attempt?", `Are you sure you want to mark this result for ${result.studentName} as 'Retaken'? This will allow the student to take the exam again.`, () => {
                        state.db.updateResultStatus(id, 'retaken');
                        renderResultsTable();
                        showToast("Result marked as retaken.", "success");
                    }, 'warning'); 
                });
            }
            else if(btn.classList.contains('delete-result')) {
                performAdminAction(() => {
                    showConfirmation("Delete Result?", `Are you sure you want to PERMANENTLY delete this exam result for ${result.studentName}? This cannot be undone.`, () => {
                        state.db.deleteResult(id);
                        renderResultsTable();
                        updateStats();
                        showToast("Result deleted.", "success");
                    }, 'danger'); 
                });
            }
        }

        // --- Auth functions ---
        function switchAuthTab(tabName) {
            authTabs.forEach(tab => tab.classList.toggle('active', tab.getAttribute('data-tab') === tabName));
            if (tabName === 'login') { loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); } 
            else { loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); }
        }

        function handleLogin(e) {
            e.preventDefault();
            const button = document.getElementById('loginButton');
            setButtonLoading(button, true);
            
            setTimeout(() => {
                const user = state.db.findUserByEmail(document.getElementById('loginEmail').value);
                setButtonLoading(button, false);
                
                if (user && user.password === document.getElementById('loginPassword').value) {
                    if (user.status === 'deactivated') {
                        showToast('Your account is deactivated. Please contact an admin.', 'error');
                        return;
                    }
                    state.currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showApp(); 
                    updateUI();
                    // NEW: Go to correct dashboard
                    const homePage = state.currentUser.role === 'student' ? 'myExams' : 'dashboard';
                    handleNavClick(homePage);
                } else { 
                    showToast('Invalid email or password', 'error');
                }
            }, 500);
        }

        function handleRegister(e) {
            e.preventDefault();
            const button = document.getElementById('registerButton');
            setButtonLoading(button, true);

            setTimeout(() => {
                const email = document.getElementById('registerEmail').value;
                setButtonLoading(button, false);

                if (state.db.findUserByEmail(email)) { 
                    showToast('User with this email already exists', 'error');
                    return; 
                }
                state.db.createUser({
                    name: document.getElementById('registerName').value,
                    email: email,
                    password: document.getElementById('registerPassword').value,
                    role: document.getElementById('registerRole').value
                });
                showToast('Registration successful! Please log in.', 'success');
                registerForm.reset(); 
                switchAuthTab('login');
            }, 500);
        }

        function handleLogout() {
            state.currentUser = null; 
            localStorage.removeItem('currentUser');
            handleBackToDashboard(); 
            closeSidebar(); 
            showAuth();
        }

        function showAuth() { authScreen.classList.remove('hidden'); appScreen.classList.add('hidden'); }
        function showApp() { authScreen.classList.add('hidden'); appScreen.classList.remove('hidden'); }

        function updateUI() {
            if (state.currentUser) {
                document.getElementById('userName').textContent = state.currentUser.name;
                document.getElementById('userEmail').textContent = state.currentUser.email;
                document.getElementById('userAvatar').textContent = state.currentUser.name.charAt(0).toUpperCase();
                
                const roleBadge = document.getElementById('userRoleBadge');
                roleBadge.textContent = state.currentUser.role.toUpperCase();
                roleBadge.className = `role-badge role-${state.currentUser.role}`;
                
                const isAdmin = state.currentUser.role === 'admin';
                const isTeacher = state.currentUser.role === 'teacher';
                const isStudent = state.currentUser.role === 'student';
                
                document.body.classList.toggle('is-admin', isAdmin);
                document.body.classList.toggle('is-teacher', isTeacher);
                document.body.classList.toggle('is-student', isStudent);
                
                updateStats(); 
                updateTables();
            }
        }

        function switchPage(page) {
            state.currentPage = page;
            pages.forEach(p => p.classList.add('hidden'));
            const pageElement = document.getElementById(`${page}Page`);
            if (pageElement) pageElement.classList.remove('hidden');
            else document.getElementById('dashboardPage').classList.remove('hidden');
            
             // NEW: Destroy chart if we leave the report page
            if (page !== 'reportPage' && state.currentChart) {
                state.currentChart.destroy();
                state.currentChart = null;
            }
        }

        function switchTab(tabId) {
            dashboardTabs.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            dashboardTabs.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }

        function updateStats() {
            const isAdmin = state.currentUser.role === 'admin';
            const isTeacher = state.currentUser.role === 'teacher';
            const isStudent = state.currentUser.role === 'student';
            
            if (isAdmin) {
                document.getElementById('totalUsers').textContent = state.db.users.length;
                document.getElementById('totalTeachers').textContent = state.db.users.filter(u => u.role === 'teacher').length;
                document.getElementById('totalStudents').textContent = state.db.users.filter(u => u.role === 'student').length;
                document.getElementById('totalExams').textContent = state.db.exams.length;
                document.getElementById('completedExams').textContent = state.db.results.filter(r => r.status === 'active').length;
            } else if (isTeacher) {
                const myExamIds = state.db.exams.filter(e => e.teacherId === state.currentUser.id).map(e => e.id);
                document.getElementById('totalExams').textContent = myExamIds.length;
                document.getElementById('completedExams').textContent = state.db.results.filter(r => myExamIds.includes(r.examId) && r.status === 'active').length;
            } else if (isStudent) {
                // NEW: Student stats
                const myClasses = state.db.getClasses().filter(cls => cls.studentIds.includes(state.currentUser.id));
                const myExamIds = myClasses.flatMap(cls => cls.assignedExamIds);
                const myResults = state.db.results.filter(r => r.studentId === state.currentUser.id && myExamIds.includes(r.examId));
                
                document.getElementById('assignedExamsStat').textContent = myExamIds.length;
                document.getElementById('completedExamsStat').textContent = myResults.filter(r => r.status === 'active').length;
            }
        }

        function updateTables(forceRedraw = false) {
            if (state.currentPage === 'dashboard' || forceRedraw) {
                renderDashboardPendingTable();
                renderDashboardRecentTable();
                renderDashboardUserTable();
            }
            if (state.currentPage === 'users' || forceRedraw) {
                renderManageUserTable();
            }
            if (state.currentPage === 'exams' || forceRedraw) {
                renderExamManagementTable();
            }
        }
        
        function renderDashboardPendingTable() {
            pendingExamsTableBody.innerHTML = '';
            const isAdmin = state.currentUser.role === 'admin';
            
            let pendingExams = state.db.exams.filter(exam => exam.status === 'pending');
            
            // NEW: Filter for teacher
            if (state.currentUser.role === 'teacher') {
                pendingExams = pendingExams.filter(exam => exam.teacherId === state.currentUser.id);
            }
            
            if (pendingExams.length === 0) {
                pendingExamsTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="5"><i class="fas fa-check-circle"></i>No pending exams.</td></tr>`;
            } else {
                pendingExams.forEach(exam => {
                    const editButtons = `
                        <div class="action-wrapper">
                            <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                            <div class="action-buttons">
                                <button class="action-btn edit-exam" data-id="${exam.id}"><i class="fas fa-edit"></i> Edit</button>
                                <button class="action-btn approve-exam" data-id="${exam.id}"><i class="fas fa-check"></i> Approve</button>
                                <button class="action-btn reject-exam" data-id="${exam.id}"><i class="fas fa-times"></i> Reject</button>
                            </div>
                        </div>
                    `;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `<td data-label="Title">${exam.title}</td><td data-label="Teacher">${exam.teacher}</td><td data-label="Questions">${exam.questions.length}</td><td data-label="Status"><span class="status status-pending">Pending</span></td><td data-label="Actions" class="admin-action-cell">${editButtons}</td>`;
                    pendingExamsTableBody.appendChild(row);
                });
            }
        }
        
        function renderDashboardRecentTable() {
             recentExamsTableBody.innerHTML = '';
             const subjectMap = { 'math': 'Math', 'physics': 'Physics', 'chemistry': 'Chemistry', 'biology': 'Biology' };
             const subjectMapMobile = { 'math': 'Mat', 'physics': 'Phy', 'chemistry': 'Chem', 'biology': 'Bio' };

             let recentExams = state.db.exams.filter(exam => exam.status === 'approved');
             
             // NEW: Filter for teacher
             if (state.currentUser.role === 'teacher') {
                recentExams = recentExams.filter(exam => exam.teacherId === state.currentUser.id);
             }
             
             if (recentExams.length === 0) {
                 recentExamsTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="5"><i class="fas fa-file-alt"></i>No approved exams.</td></tr>`;
             } else {
                 recentExams.forEach(exam => {
                     const row = document.createElement('tr');
                     const participantCount = state.db.results.filter(r => r.examId === exam.id && r.status === 'active').length;
                     const subLower = exam.subject.toLowerCase();
                     const fullSub = subjectMap[subLower] || exam.subject;
                     const shortSub = subjectMapMobile[subLower] || exam.subject.substring(0,3);
                     const subjectDisplay = `<span class="desktop-text">${fullSub}</span><span class="mobile-text">${shortSub}</span>`;
                     
                     row.innerHTML = `<td data-label="Title">${exam.title}</td><td data-label="Subject">${subjectDisplay}</td><td data-label="Questions">${exam.questions.length}</td><td data-label="Participants">${participantCount}</td><td style="min-width: 60px;" data-label="Actions" class="admin-action-cell"></td>`;
                     recentExamsTableBody.appendChild(row);
                 });
             }
        }

        function renderUserTable(tbody, userList, showAll) {
            tbody.innerHTML = '';
            const usersToShow = showAll ? userList : userList.slice(0, 3);

            if (usersToShow.length === 0) {
                const colSpan = (tbody.id === "usersTableBody") ? 4 : 5;
                tbody.innerHTML = `<tr class="empty-state-row"><td colspan="${colSpan}"><i class="fas fa-user-slash"></i>No users found.</td></tr>`;
                return;
            }
            
            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
            };

            usersToShow.forEach(user => {
                const row = document.createElement('tr');
                const userStatus = user.status || 'active';
                const statusClass = userStatus === 'active' ? 'status-approved' : 'status-deactivated';
                const statusText = userStatus === 'active' ? 'Active' : 'Deactivated';
                
                if (tbody.id === "usersTableBody") {
                    row.innerHTML = `
                        <td data-label="Name">${user.name}</td>
                        <td data-label="Role">${user.role}</td>
                        <td data-label="Joined">${formatDate(user.joinedDate)}</td>
                        <td data-label="Status"><span class="status ${statusClass}">${statusText}</span></td>
                    `;
                } 
                else {
                    let statusButton;
                    if (userStatus === 'active') {
                        statusButton = `<button class="action-btn deactivate-user" data-id="${user.id}" title="Deactivate User"><i class="fas fa-user-slash"></i> Deactivate</button>`;
                    } else {
                        statusButton = `<button class="action-btn activate-user" data-id="${user.id}" title="Activate User"><i class="fas fa-user-check"></i> Activate</button>`;
                    }

                    const adminButton = (state.currentUser.role === 'admin' && user.id !== state.currentUser.id) ? `
                        <div class="action-wrapper">
                             <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                             <div class="action-buttons">
                                 <button class="action-btn edit-user" data-id="${user.id}" title="Edit User"><i class="fas fa-edit"></i> Edit User</button>
                                 ${statusButton}
                             </div>
                         </div>
                    ` : '';
                    
                    row.innerHTML = `
                        <td data-label="Name" style="font-weight: 600;">${user.name} ${user.id === state.currentUser.id ? '(You)' : ''}</td>
                        <td data-label="Email"><span style="font-size: 0.85rem;">${user.email}</span></td>
                        <td data-label="Role"><span class="role-badge role-${user.role}">${user.role}</span></td>
                        <td data-label="Status"><span class="status ${statusClass}">${statusText}</span></td>
                        <td data-label="Actions" class="admin-action-cell">${adminButton}</td>
                    `;
                }
                tbody.appendChild(row);
            });
        }
        
        function renderDashboardUserTable() {
            const allUsers = state.db.users.sort((a, b) => new Date(b.joinedDate) - new Date(a.joinedDate)); 
            const isExpanded = document.getElementById('dashboardUserListContainer').classList.contains('expanded');
            renderUserTable(usersTableBody, allUsers, isExpanded);
            showAllUsersBtn.style.display = (allUsers.length > 3) ? 'flex' : 'none';
        }
        
        function renderManageUserTable() {
            let filteredUsers = state.db.users;
            let titleText = "User Management";
            
            if (state.userFilter === 'teacher') { filteredUsers = state.db.users.filter(u => u.role === 'teacher'); titleText += ": Teachers"; }
            else if (state.userFilter === 'student') { filteredUsers = state.db.users.filter(u => u.role === 'student'); titleText += ": Students"; }
            else { titleText += ": All Users"; }
            
            usersPageTitle.textContent = titleText;
            const isExpanded = document.getElementById('manageUserListContainer').classList.contains('expanded');
            renderUserTable(manageUsersTableBody, filteredUsers, isExpanded);
            showAllManageUsersBtn.style.display = (filteredUsers.length > 3) ? 'flex' : 'none';
        }

        // --- Exam Functions ---
        function handleCreateExam(e) {
            e.preventDefault();
            const newExam = state.db.createExam({
                title: document.getElementById('examTitleInput').value,
                subject: document.getElementById('examSubject').value,
                scheduledDate: document.getElementById('examDate').value,
                duration: parseInt(document.getElementById('examDurationInput').value),
                teacher: state.currentUser.name,
                teacherId: state.currentUser.id, 
                // NEW: Teachers default to pending, admin defaults to approved
                status: state.currentUser.role === 'admin' ? 'approved' : 'pending',
            });
            addExamModal.style.display = 'none'; examForm.reset();
            updateTables(); updateStats();
            showToast("Exam created! Add questions now.", "success");
            openExamEditor(newExam.id);
        }

        function handleJoinExam(e) {
            e.preventDefault();
            const button = document.getElementById('joinExamButton');
            setButtonLoading(button, true);
            
            setTimeout(() => {
                const examCode = joinExamCodeInput.value.trim();
                const exam = state.db.findExamByCode(examCode);
                setButtonLoading(button, false);

                if (!exam) { showToast("Invalid Exam ID. Please try again.", "error"); return; }
                if (exam.status !== 'approved') { showToast("This exam is not yet approved or is pending.", "error"); return; }
                if (exam.questions.length === 0) { showToast("This exam has no questions.", "error"); return; }
                if (state.db.hasStudentTakenExam(state.currentUser.id, exam.id)) { showToast("You have already completed this exam.", "error"); return; }
                
                joinExamModal.style.display = 'none';
                startExam(exam.id);
            }, 500);
        }

        function startExam(examId, isPreview = false) {
            const exam = state.db.findExamById(examId);
            if (!exam) return;
            
            state.currentExam = exam; 
            state.currentQuestionIndex = 0; 
            // NEW: Initialize answers based on question type
            state.userAnswers = exam.questions.map(q => {
                if (q.type === 'multi_choice') return [];
                if (q.type === 'short_answer') return "";
                return null;
            }); 
            state.timeRemaining = exam.duration * 60;
            state.isPreviewMode = isPreview;
            
            document.getElementById('examTitle').textContent = exam.title + (isPreview ? " (Preview Mode)" : "");
            document.getElementById('examDuration').textContent = exam.duration === 0 ? "Unlimited" : exam.duration;
            document.getElementById('totalQuestions').textContent = exam.questions.length;
            
            document.getElementById('resultDisplay').classList.add('hidden');
            document.getElementById('questionContainer').classList.remove('hidden');
            document.getElementById('activeExamControls').classList.remove('hidden');
            document.getElementById('submitExam').innerText = isPreview ? "Finish Preview" : "Submit Exam";

            loadQuestion(state.currentQuestionIndex); 
            if(!isPreview && exam.duration > 0) startTimer();
            else document.getElementById('timeRemaining').textContent = isPreview ? "N/A (Preview)" : "Unlimited";
            
            switchPage('takeExam');
        }

        // NEW: Reworked to handle all question types
        function loadQuestion(index) {
            if (!state.currentExam) return;
            const q = state.currentExam.questions[index];
            document.getElementById('questionText').textContent = q.question;
            document.getElementById('currentQuestion').textContent = index + 1;
            examOptionsContainer.innerHTML = '';
            
            const savedAnswer = state.userAnswers[index];

            switch(q.type) {
                case 'single_choice':
                    q.options.forEach((optionText, i) => {
                        const div = document.createElement('div');
                        div.className = 'option single-choice';
                        div.dataset.index = i;
                        div.innerHTML = `<span class="check-icon"></span><input type="radio" name="answer" value="${i}" id="option${i}"><label for="option${i}">${optionText}</label>`;
                        if (savedAnswer === i) {
                            div.querySelector('input').checked = true;
                            div.classList.add('selected');
                        }
                        examOptionsContainer.appendChild(div);
                    });
                    break;
                case 'multi_choice':
                    q.options.forEach((optionText, i) => {
                        const div = document.createElement('div');
                        div.className = 'option multi-choice';
                        div.dataset.index = i;
                        div.innerHTML = `<span class="check-icon"></span><input type="checkbox" name="answer" value="${i}" id="option${i}"><label for="option${i}">${optionText}</label>`;
                        if (savedAnswer.includes(i)) {
                            div.querySelector('input').checked = true;
                            div.classList.add('selected');
                        }
                        examOptionsContainer.appendChild(div);
                    });
                    break;
                case 'true_false':
                    ['True', 'False'].forEach((optionText, i) => {
                        const value = (optionText === 'True');
                        const div = document.createElement('div');
                        div.className = 'option true-false';
                        div.dataset.value = value;
                        div.innerHTML = `<span class="check-icon"></span><input type="radio" name="answer" value="${value}" id="option${i}"><label for="option${i}">${optionText}</label>`;
                        if (savedAnswer === value) {
                            div.querySelector('input').checked = true;
                            div.classList.add('selected');
                        }
                        examOptionsContainer.appendChild(div);
                    });
                    break;
                case 'short_answer':
                    examOptionsContainer.innerHTML = `
                        <div class="form-group">
                            <label for="shortAnswerInput">Your Answer:</label>
                            <input type="text" id="shortAnswerInput" class="form-control" value="${savedAnswer || ''}">
                        </div>`;
                    break;
            }
            
            prevQuestionBtn.disabled = index === 0;
            const isLast = index === state.currentExam.questions.length - 1;
            nextQuestionBtn.classList.toggle('hidden', isLast);
            submitExamBtn.classList.toggle('hidden', !isLast);
        }
        
        // NEW: Reworked to save all answer types
        function saveAnswer() {
            if(state.isPreviewMode) return;
            
            const q = state.currentExam.questions[state.currentQuestionIndex];
            
            switch(q.type) {
                case 'single_choice':
                    const selectedRadio = document.querySelector('#examOptionsContainer input[type="radio"]:checked');
                    state.userAnswers[state.currentQuestionIndex] = selectedRadio ? parseInt(selectedRadio.value) : null;
                    break;
                case 'multi_choice':
                    const selectedChecks = Array.from(document.querySelectorAll('#examOptionsContainer input[type="checkbox"]:checked'));
                    state.userAnswers[state.currentQuestionIndex] = selectedChecks.map(cb => parseInt(cb.value));
                    break;
                case 'true_false':
                    const selectedTF = document.querySelector('#examOptionsContainer input[type="radio"]:checked');
                    state.userAnswers[state.currentQuestionIndex] = selectedTF ? (selectedTF.value === 'true') : null;
                    break;
                case 'short_answer':
                    const shortAnswer = document.getElementById('shortAnswerInput');
                    state.userAnswers[state.currentQuestionIndex] = shortAnswer ? shortAnswer.value : "";
                    break;
            }
        }
        
        // NEW: Helper function to check correctness for all types
        function isAnswerCorrect(userAnswer, question) {
            const correctAnswer = question.correctAnswer;
            switch(question.type) {
                case 'single_choice':
                    return userAnswer === correctAnswer;
                case 'true_false':
                    return userAnswer === correctAnswer;
                case 'short_answer':
                    return typeof userAnswer === 'string' && userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase();
                case 'multi_choice':
                    if (!Array.isArray(userAnswer) || !Array.isArray(correctAnswer)) return false;
                    return userAnswer.length === correctAnswer.length && 
                           userAnswer.sort().toString() === correctAnswer.sort().toString();
                default:
                    return false;
            }
        }

        function handleNextQuestion() { saveAnswer(); if (state.currentQuestionIndex < state.currentExam.questions.length - 1) { state.currentQuestionIndex++; loadQuestion(state.currentQuestionIndex); }}
        function handlePrevQuestion() { saveAnswer(); if (state.currentQuestionIndex > 0) { state.currentQuestionIndex--; loadQuestion(state.currentQuestionIndex); }}
        
        function startTimer() {
            if (state.examTimer) clearInterval(state.examTimer);
            const el = document.getElementById('timeRemaining');
            state.examTimer = setInterval(() => {
                state.timeRemaining--;
                const m = Math.floor(state.timeRemaining / 60), s = state.timeRemaining % 60;
                el.textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (state.timeRemaining <= 0) { 
                    clearInterval(state.examTimer); 
                    showToast("Time's up! Submitting exam.", "warning");
                    handleSubmitExam(); 
                }
            }, 1000);
        }

        // NEW: Reworked to use helper function for grading
        function handleSubmitExam() {
            saveAnswer(); 
            if (state.examTimer) clearInterval(state.examTimer);
            if (!state.currentExam) return;
            
            if(state.isPreviewMode) {
                handleBackToDashboard();
                showToast("Preview finished.", "info");
                return;
            }

            let score = 0; 
            state.userAnswers.forEach((answer, i) => {
                if (isAnswerCorrect(answer, state.currentExam.questions[i])) {
                    score++;
                }
            });
            
            state.db.saveResult({
                studentId: state.currentUser.id,
                studentName: state.currentUser.name,
                examId: state.currentExam.id,
                examTitle: state.currentExam.title,
                score: score,
                total: state.currentExam.questions.length,
                answers: state.userAnswers // NEW: Save all answers
            });
            
            document.getElementById('questionContainer').classList.add('hidden');
            document.getElementById('activeExamControls').classList.add('hidden');
            document.getElementById('resultDisplay').classList.remove('hidden');
            document.getElementById('finalScoreDisplay').textContent = `${score} / ${state.currentExam.questions.length}`;
            showToast("Exam submitted successfully!", "success");
        }
        
        // --- Exam Editor ---
        function openExamEditor(examId) {
            const exam = state.db.findExamById(examId); if (!exam) return;
            console.log('Opening editor for exam:', exam); 
            state.editingExamId = examId; 
            examEditorTitle.textContent = `Edit Exam: ${exam.title}`;
            document.getElementById('editExamTitleInput').value = exam.title;
            document.getElementById('editExamSubjectInput').value = exam.subject;
            document.getElementById('editExamDurationInput').value = exam.duration;
            renderQuestionList(); 
            handleNavClick('examEditor');
        }
        
        function handleUpdateExamDetails(e) {
            e.preventDefault();
            state.db.updateExam(state.editingExamId, {
                title: document.getElementById('editExamTitleInput').value,
                subject: document.getElementById('editExamSubjectInput').value,
                duration: parseInt(document.getElementById('editExamDurationInput').value)
            });
            showToast("Exam details updated.", "success");
        }

        function renderQuestionList() {
            const exam = state.db.findExamById(state.editingExamId); if (!exam) return;
            questionList.innerHTML = ''; 
            questionCount.textContent = exam.questions.length;
            
            if(exam.questions.length === 0) {
                questionList.classList.add('empty-list');
                return;
            }
            questionList.classList.remove('empty-list');

            exam.questions.forEach((q, index) => {
                const li = document.createElement('li'); li.className = 'question-list-item';
                
                let optionsHtml = '';
                switch(q.type) {
                    case 'single_choice':
                    case 'multi_choice':
                        optionsHtml = q.options.map((opt, i) => {
                            const isCorrect = (q.type === 'single_choice') ? (i === q.correctAnswer) : q.correctAnswer.includes(i);
                            return `<li class="${isCorrect ? 'correct' : ''}">${i+1}. ${opt}</li>`;
                        }).join('');
                        break;
                    case 'true_false':
                        optionsHtml = `<li class="correct">Correct Answer: ${q.correctAnswer ? 'True' : 'False'}</li>`;
                        break;
                    case 'short_answer':
                         optionsHtml = `<li class="correct">Correct Answer: ${q.correctAnswer}</li>`;
                        break;
                }
                
                li.innerHTML = `
                    <div class="question-list-item-header">
                        <h4>${index + 1}. ${q.question} <small>(${q.type.replace('_', ' ')})</small></h4>
                        <div>
                            <button class="btn-icon edit-question" data-index="${index}"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon danger delete-question" data-index="${index}"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <ul class="question-list-item-options">${optionsHtml}</ul>
                `;
                questionList.appendChild(li);
            });
        }
        
        // NEW: Show/hide correct form fields for question type
        function handleQuestionTypeChange(e, formType = 'add') {
            const type = e.target.value;
            const choiceContainer = (formType === 'add') ? choiceOptionsContainer : editChoiceOptionsContainer;
            const tfContainer = (formType === 'add') ? trueFalseContainer : editTrueFalseContainer;
            const saContainer = (formType === 'add') ? shortAnswerContainer : editShortAnswerContainer;
            const correctInputs = (formType === 'add') ? 
                addQuestionForm.querySelectorAll('.correct-answer-input') :
                editQuestionForm.querySelectorAll('.edit-correct-answer-input');

            // Hide all
            choiceContainer.classList.add('hidden');
            tfContainer.classList.add('hidden');
            saContainer.classList.add('hidden');
            
            // Disable all inputs
            correctInputs.forEach(i => i.disabled = true);
            choiceContainer.querySelectorAll('input[type="text"]').forEach(i => i.disabled = true);

            if (type === 'single_choice' || type === 'multi_choice') {
                choiceContainer.classList.remove('hidden');
                choiceContainer.querySelectorAll('input').forEach(i => i.disabled = false);
                
                // Switch between radio and checkbox
                const inputType = (type === 'single_choice') ? 'radio' : 'checkbox';
                const inputName = (formType === 'add') ? 'correctAnswer' : 'editCorrectAnswer';
                
                choiceContainer.querySelectorAll('.correct-answer-input').forEach(input => {
                    input.type = inputType;
                    input.name = inputName;
                });
                
            } else if (type === 'true_false') {
                tfContainer.classList.remove('hidden');
                tfContainer.querySelectorAll('input').forEach(i => i.disabled = false);
            } else if (type === 'short_answer') {
                saContainer.classList.remove('hidden');
                saContainer.querySelectorAll('input').forEach(i => i.disabled = false);
            }
        }
        
        // NEW: Reworked to handle all question types
        function handleAddQuestion(e) {
            e.preventDefault();
            const type = questionTypeSelect.value;
            const q = {
                type: type,
                question: document.getElementById('questionTextInput').value,
            };

            if (type === 'single_choice') {
                const correctInput = addQuestionForm.querySelector('input[name="correctAnswer"]:checked');
                if (!correctInput) { showToast("Please select a correct answer.", "error"); return; }
                q.options = [1,2,3,4].map(i => document.getElementById(`option${i}Input`).value).filter(o => o);
                q.correctAnswer = parseInt(correctInput.value);
            } else if (type === 'multi_choice') {
                const correctInputs = Array.from(addQuestionForm.querySelectorAll('input[name="correctAnswer"]:checked'));
                if (correctInputs.length === 0) { showToast("Please select at least one correct answer.", "error"); return; }
                q.options = [1,2,3,4].map(i => document.getElementById(`option${i}Input`).value).filter(o => o);
                q.correctAnswer = correctInputs.map(i => parseInt(i.value));
            } else if (type === 'true_false') {
                const correctInput = addQuestionForm.querySelector('input[name="trueFalseAnswer"]:checked');
                if (!correctInput) { showToast("Please select True or False.", "error"); return; }
                q.correctAnswer = (correctInput.value === 'true');
            } else if (type === 'short_answer') {
                const correctInput = document.getElementById('shortAnswerInput');
                if (!correctInput.value) { showToast("Please enter a correct answer.", "error"); return; }
                q.correctAnswer = correctInput.value;
            }

            state.db.addQuestionToExam(state.editingExamId, q); 
            renderQuestionList(); 
            addQuestionForm.reset();
            questionTypeSelect.value = 'single_choice'; // Reset dropdown
            handleQuestionTypeChange({ target: questionTypeSelect }); // Reset form fields
            showToast("Question added.", "success");
        }
        
        function handleDeleteQuestion(examId, qIndex) { 
             showConfirmation("Delete Question?", `Are you sure you want to delete question ${qIndex + 1}?`, () => {
                state.db.deleteQuestionFromExam(examId, qIndex); 
                renderQuestionList(); 
                showToast("Question deleted.", "success");
             });
        }
        
        // NEW: Reworked to load all question types
        function openEditQuestionModal(examId, qIndex) {
            const q = state.db.findExamById(examId).questions[qIndex]; if (!q) return;
            
            // Reset form
            editQuestionForm.reset();
            editChoiceOptionsContainer.classList.add('hidden');
            editTrueFalseContainer.classList.add('hidden');
            editShortAnswerContainer.classList.add('hidden');

            state.editingQuestionIndex = qIndex;
            document.getElementById('editQuestionExamId').value = examId;
            document.getElementById('editQuestionIndex').value = qIndex;
            
            document.getElementById('editQuestionTextInput').value = q.question;
            editQuestionTypeSelect.value = q.type;
            
            // Show correct fields based on type
            if (q.type === 'single_choice' || q.type === 'multi_choice') {
                editChoiceOptionsContainer.classList.remove('hidden');
                const inputType = (q.type === 'single_choice') ? 'radio' : 'checkbox';
                editChoiceOptionsContainer.querySelectorAll('.edit-correct-answer-input').forEach((input, i) => {
                    input.type = inputType;
                    input.name = 'editCorrectAnswer'; // Ensure name is set
                    document.getElementById(`editOption${i+1}Input`).value = q.options[i] || '';
                    
                    if (q.type === 'single_choice' && i === q.correctAnswer) {
                        input.checked = true;
                    } else if (q.type === 'multi_choice' && q.correctAnswer.includes(i)) {
                        input.checked = true;
                    }
                });
            } else if (q.type === 'true_false') {
                editTrueFalseContainer.classList.remove('hidden');
                editQuestionForm.querySelector(`input[name="editTrueFalseAnswer"][value="${q.correctAnswer}"]`).checked = true;
            } else if (q.type === 'short_answer') {
                editShortAnswerContainer.classList.remove('hidden');
                document.getElementById('editShortAnswerInput').value = q.correctAnswer;
            }

            editQuestionModal.style.display = 'flex';
        }
        
        // NEW: Reworked to update all question types
        function handleUpdateQuestion(e) {
            e.preventDefault();
            const examId = parseInt(document.getElementById('editQuestionExamId').value);
            const qIndex = parseInt(document.getElementById('editQuestionIndex').value);
            const type = editQuestionTypeSelect.value;
            
            const q = {
                type: type,
                question: document.getElementById('editQuestionTextInput').value,
            };

            if (type === 'single_choice') {
                const correctInput = editQuestionForm.querySelector('input[name="editCorrectAnswer"]:checked');
                if (!correctInput) { showToast("Please select a correct answer.", "error"); return; }
                q.options = [1,2,3,4].map(i => document.getElementById(`editOption${i}Input`).value).filter(o => o);
                q.correctAnswer = parseInt(correctInput.value);
            } else if (type === 'multi_choice') {
                const correctInputs = Array.from(editQuestionForm.querySelectorAll('input[name="editCorrectAnswer"]:checked'));
                if (correctInputs.length === 0) { showToast("Please select at least one correct answer.", "error"); return; }
                q.options = [1,2,3,4].map(i => document.getElementById(`editOption${i}Input`).value).filter(o => o);
                q.correctAnswer = correctInputs.map(i => parseInt(i.value));
            } else if (type === 'true_false') {
                const correctInput = editQuestionForm.querySelector('input[name="editTrueFalseAnswer"]:checked');
                if (!correctInput) { showToast("Please select True or False.", "error"); return; }
                q.correctAnswer = (correctInput.value === 'true');
            } else if (type === 'short_answer') {
                const correctInput = document.getElementById('editShortAnswerInput');
                if (!correctInput.value) { showToast("Please enter a correct answer.", "error"); return; }
                q.correctAnswer = correctInput.value;
            }

            state.db.updateQuestionInExam(examId, qIndex, q);
            renderQuestionList(); 
            editQuestionModal.style.display = 'none';
            showToast("Question updated.", "success");
        }
        
        // --- NEW: Class Management Functions ---
        function renderClassesTable() {
            classesTableBody.innerHTML = '';
            const isAdmin = state.currentUser.role === 'admin';
            const teacherId = isAdmin ? null : state.currentUser.id;
            
            const classes = state.db.getClasses(teacherId);
            
            if (classes.length === 0) {
                 classesTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="4"><i class="fas fa-school"></i>No classes found. Create one!</td></tr>`;
                 return;
            }
            
            classes.forEach(cls => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Class Name">${cls.name}</td>
                    <td data-label="Students">${cls.studentIds.length}</td>
                    <td data-label="Assigned Exams">${cls.assignedExamIds.length}</td>
                    <td data-label="Actions">
                        <div class="action-wrapper">
                            <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                            <div class="action-buttons">
                                <button class="action-btn" data-action="manage" data-id="${cls.id}"><i class="fas fa-users"></i> Manage Students</button>
                                <button class="action-btn" data-action="assign" data-id="${cls.id}"><i class="fas fa-file-import"></i> Assign Exam</button>
                            </div>
                        </div>
                    </td>
                `;
                classesTableBody.appendChild(row);
            });
        }
        
        function handleCreateClass(e) {
            e.preventDefault();
            const className = document.getElementById('classNameInput').value;
            state.db.createClass(className, state.currentUser.id);
            createClassModal.style.display = 'none';
            renderClassesTable();
            showToast("Class created successfully.", "success");
        }
        
        function handleClassesTableClick(e) {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;
            
            const classId = parseInt(btn.dataset.id);
            const action = btn.dataset.action;
            
            if (action === 'manage') {
                openManageStudentsModal(classId);
            } else if (action === 'assign') {
                openAssignExamModal(classId);
            }
        }
        
        function openManageStudentsModal(classId) {
            const cls = state.db.findClassById(classId);
            if (!cls) return;
            
            document.getElementById('manageStudentsClassId').value = classId;
            document.getElementById('manageStudentsTitle').textContent = `Manage Students: ${cls.name}`;
            
            const allStudents = state.db.users.filter(u => u.role === 'student');
            studentSelectionList.innerHTML = '';
            
            if (allStudents.length === 0) {
                studentSelectionList.innerHTML = `<p style="text-align: center; color: var(--gray); padding: 20px;">No students in the system.</p>`;
            } else {
                allStudents.forEach(student => {
                    const isChecked = cls.studentIds.includes(student.id);
                    const item = document.createElement('div');
                    item.className = 'form-check';
                    item.innerHTML = `
                        <input type="checkbox" value="${student.id}" id="student-${student.id}" ${isChecked ? 'checked' : ''}>
                        <label for="student-${student.id}">${student.name} (${student.email})</label>
                    `;
                    studentSelectionList.appendChild(item);
                });
            }
            manageStudentsModal.style.display = 'flex';
        }
        
        function handleUpdateClassStudents(e) {
            e.preventDefault();
            const classId = parseInt(document.getElementById('manageStudentsClassId').value);
            const selectedInputs = studentSelectionList.querySelectorAll('input[type="checkbox"]:checked');
            const studentIds = Array.from(selectedInputs).map(input => parseInt(input.value));
            
            state.db.updateClassStudents(classId, studentIds);
            manageStudentsModal.style.display = 'none';
            renderClassesTable();
            showToast("Student list updated.", "success");
        }
        
        function openAssignExamModal(classId) {
            const cls = state.db.findClassById(classId);
            if (!cls) return;
            
            document.getElementById('assignExamClassId').value = classId;
            document.getElementById('assignExamTitle').textContent = `Assign Exam to: ${cls.name}`;
            
            const teacherId = (state.currentUser.role === 'admin') ? null : state.currentUser.id;
            const exams = state.db.getExams().filter(e => e.status === 'approved' && (!teacherId || e.teacherId === teacherId));
            
            assignExamSelect.innerHTML = '<option value="">-- Select an approved exam --</option>';
            if (exams.length === 0) {
                 assignExamSelect.innerHTML = '<option value="">No approved exams found.</option>';
            } else {
                exams.forEach(exam => {
                    const isAssigned = cls.assignedExamIds.includes(exam.id);
                    assignExamSelect.innerHTML += `<option value="${exam.id}" ${isAssigned ? 'disabled' : ''}>${exam.title} ${isAssigned ? '(Assigned)' : ''}</option>`;
                });
            }
            
            assignExamModal.style.display = 'flex';
        }
        
        function handleAssignExamToClass(e) {
            e.preventDefault();
            const classId = parseInt(document.getElementById('assignExamClassId').value);
            const examId = parseInt(assignExamSelect.value);
            
            if (!examId) {
                showToast("Please select an exam.", "error");
                return;
            }
            
            state.db.assignExamToClass(classId, examId);
            assignExamModal.style.display = 'none';
            renderClassesTable();
            showToast("Exam assigned successfully.", "success");
        }
        
        // --- NEW: Student "My Exams" Page ---
        function renderMyExams() {
            assignedExamsTableBody.innerHTML = '';
            const myClasses = state.db.getClasses().filter(cls => cls.studentIds.includes(state.currentUser.id));
            const myExamIds = myClasses.flatMap(cls => cls.assignedExamIds);
            const myExams = state.db.getExams().filter(exam => myExamIds.includes(exam.id) && exam.status === 'approved');
            
            if (myExams.length === 0) {
                 assignedExamsTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="5"><i class="fas fa-file-excel"></i>No exams assigned to you.</td></tr>`;
                 return;
            }
            
            myExams.forEach(exam => {
                const row = document.createElement('tr');
                const hasTaken = state.db.hasStudentTakenExam(state.currentUser.id, exam.id);
                const result = hasTaken ? state.db.results.find(r => r.studentId === state.currentUser.id && r.examId === exam.id && r.status === 'active') : null;
                
                row.innerHTML = `
                    <td data-label="Title">${exam.title}</td>
                    <td data-label="Subject">${exam.subject}</td>
                    <td data-label="Questions">${exam.questions.length}</td>
                    <td data-label="Status">
                        ${hasTaken ? `<span class="status status-completed">Completed (${result.score}/${result.total})</span>` : '<span class="status status-not-started">Not Started</span>'}
                    </td>
                    <td data-label="Actions">
                        ${!hasTaken ? `<button class="btn btn-sm start-exam-btn" data-id="${exam.id}" style="width: auto;">Start Exam</button>` : 'N/A'}
                    </td>
                `;
                assignedExamsTableBody.appendChild(row);
            });
        }
        
        // --- NEW: Analytics & Report Page ---
        function renderReportPage(examId) {
            const exam = state.db.findExamById(examId);
            if (!exam) {
                showToast("Could not find exam data.", "error");
                return;
            }
            
            const results = state.db.results.filter(r => r.examId === examId && r.status === 'active');
            document.getElementById('reportExamTitle').textContent = `Report: ${exam.title}`;
            
            if (results.length === 0) {
                showToast("No results found for this exam to generate a report.", "info");
                handleNavClick('results');
                return;
            }
            
            // 1. Calculate Key Stats
            const scores = results.map(r => r.score);
            const total = exam.questions.length;
            const high = Math.max(...scores);
            const low = Math.min(...scores);
            const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
            
            document.getElementById('reportAvgScore').textContent = `${((avg/total) * 100).toFixed(1)}%`;
            document.getElementById('reportHighScore').textContent = `${high}/${total}`;
            document.getElementById('reportLowScore').textContent = `${low}/${total}`;
            
            // 2. Calculate Question Analysis
            const questionAnalysisBody = document.getElementById('questionAnalysisTable').querySelector('tbody');
            questionAnalysisBody.innerHTML = '';
            const correctCounts = new Array(total).fill(0);
            
            results.forEach(result => {
                // Ensure 'answers' exists; fallback for old data
                if (result.answers && result.answers.length === exam.questions.length) {
                    result.answers.forEach((userAnswer, i) => {
                        if (isAnswerCorrect(userAnswer, exam.questions[i])) {
                            correctCounts[i]++;
                        }
                    });
                }
            });
            
            exam.questions.forEach((q, i) => {
                const correctPercent = ((correctCounts[i] / results.length) * 100).toFixed(0);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Question">Q${i+1}: ${q.question.substring(0, 30)}...</td>
                    <td data-label="Correct" style="font-weight: bold; color: ${correctPercent < 50 ? 'var(--danger)' : 'var(--secondary)'};">
                        ${correctPercent}%
                    </td>
                `;
                questionAnalysisBody.appendChild(row);
            });

            // 3. Render Chart
            const scoreDistribution = new Array(total + 1).fill(0);
            scores.forEach(score => {
                scoreDistribution[score]++;
            });
            
            const ctx = document.getElementById('scoreDistributionChart').getContext('2d');
            if (state.currentChart) {
                state.currentChart.destroy(); // Clear old chart
            }
            state.currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: scoreDistribution.map((_, i) => `${i} / ${total}`), // "0/5", "1/5", etc.
                    datasets: [{
                        label: '# of Students',
                        data: scoreDistribution,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0 // Ensure y-axis shows whole numbers
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            switchPage('reportPage');
        }


        // --- Start the App ---
        (function() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>


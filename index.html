<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWA</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Global Font Size Reduction */
        html {
            font-size: 85%;
        }

        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #f5f7fa;
            --gray: #95a5a6;
            --admin: #3498db;
            --teacher: #9b59b6;
            --student: #2ecc71;
            --parent: #e67e22;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            color: #333;
            min-height: 100vh;
        }
        
        /* --- NEW: Editor Specific Styles (Screenshot Match) --- */
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .editor-card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
        }

        .editor-section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 20px;
        }

        .option-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        /* Styling for radio/checkboxes in editor */
        .option-selector {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .btn-grey {
            background-color: #e0e0e0;
            color: #333;
            border: 1px solid #ccc;
            font-weight: 600;
        }
        .btn-grey:hover {
            background-color: #d0d0d0;
        }
        
        .btn-remove-option {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
        }
        .btn-remove-option:hover {
            color: #c0392b;
        }

        /* End Editor Specific */

        body.is-admin .admin-only {
            display: flex;
        }
        body:not(.is-admin) .admin-only {
            display: none;
        }
        body:not(.is-admin) .admin-action-header,
        body:not(.is-admin) .admin-action-cell {
            display: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px; 
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            height: 80px; 
            width: 100%;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px; 
        }
        
        .mobile-nav-toggle {
            display: none; 
            font-size: 1.5rem;
            margin-right: 0; 
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon-wrapper {
            width: 45px;
            height: 45px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .logo h1 {
            color: var(--dark);
            font-weight: 700;
            font-size: 1.5rem;
            line-height: 1.2;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            height: 100%;
        }
        
        .user-details-text {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .user-email {
            display: none;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .logout-btn {
            background: transparent;
            color: var(--gray);
            border: 1px solid #e0e0e0;
            padding: 8px 15px;
            border-radius: 6px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            font-weight: 600;
            height: 40px;
        }

        .logout-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* Auth Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            margin-top: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            position: relative; 
            overflow: hidden; 
        }
        
        .auth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px 15px 15px;
            margin-bottom: 10px;
        }
        
        .auth-header-title {
            flex-grow: 1;
            text-align: center;
            color: var(--dark);
            font-weight: 700;
            font-size: 1.5rem;
            line-height: 1.2;
        }

        .awa-logo-auth {
            font-weight: 900;
            color: var(--primary);
            font-size: 1.2rem;
            border: 2px solid var(--primary);
            padding: 5px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.9);
            line-height: 1;
        }
        
        .auth-card .logo-icon-wrapper {
            width: 45px; 
            height: 45px;
            flex-shrink: 0; 
        }
        
        .awa-logo-header {
            font-weight: 900;
            color: var(--primary);
            font-size: 1.2rem;
            border: 2px solid var(--primary);
            padding: 2px 5px;
            border-radius: 4px;
            margin-right: 10px;
            display: none; 
        }
        
        .auth-card .logo {
            display: none; 
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }

        .auth-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            width: 100%;
            position: relative; 
            min-height: 44px; 
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }
        
        .btn .btn-text {
            transition: opacity 0.2s ease;
        }
        .btn .spinner {
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            margin-left: -8px;
            margin-top: -8px;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .btn.loading .btn-text {
            opacity: 0;
        }
        .btn.loading .spinner {
            display: block;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-danger {
            background: var(--danger);
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-success {
            background: var(--secondary);
        }
        .btn-success:hover {
            background: #27ae60;
        }
        .btn-warning {
            background: var(--warning);
        }
        .btn-warning:hover {
            background: #d35400;
        }

        .btn i {
            font-size: 0.9rem;
        }

        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
        }

        /* Sidebar Styles */
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            height: 100%; 
            position: relative; 
        }
        
        .sidebar-close {
            display: none; 
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
        }

        .user-role {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .role-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        .role-admin { background: var(--admin); }
        .role-teacher { background: var(--teacher); }
        .role-student { background: var(--student); }
        .role-parent { background: var(--parent); }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border-radius: 8px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--light);
            color: var(--primary);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            min-height: 60vh;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .content-header-actions {
            display: flex;
            gap: 10px;
        }

        .content-header h2 {
            color: var(--dark);
            font-weight: 600;
        }

        .btn-sm {
            width: auto;
            padding: 10px 20px;
        }
        
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--gray);
            transition: color 0.2s ease;
        }
        .btn-icon:hover {
            color: var(--primary);
        }
        .btn-icon.danger:hover {
            color: var(--danger);
        }

        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary);
        }
        
        .stat-card.clickable {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .stat-card.clickable:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .stat-card.teacher { border-left-color: var(--teacher); }
        .stat-card.student { border-left-color: var(--student); }
        .stat-card.parent { border-left-color: var(--parent); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        
        .table-container.scrollable-list {
            max-height: 250px;
            overflow-y: visible;
            border: none;
        }
        .table-container.scrollable-list.expanded {
            max-height: none;
            overflow-y: visible;
        }
        .table-container.scrollable-list table {
           border: none;
        }
        .table-container.scrollable-list tr {
            min-height: 60px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: normal; 
            word-break: break-word;
            vertical-align: middle; 
        }
        
        tr td:first-child,
        tr th:first-child {
            padding-left: 20px;
        }
        tr td:last-child,
        tr th:last-child {
            padding-right: 20px;
        }

        th {
            background: var(--light);
            color: var(--dark);
            font-weight: 600;
            white-space: nowrap; 
        }
        
        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: #f9f9f9;
        }
        
        .empty-state-row {
            text-align: center;
            color: var(--gray);
            font-style: italic;
        }
        .empty-state-row td {
            padding: 40px;
        }
        .empty-state-row i {
            display: block;
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #ddd;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-deactivated { background: #fff3cd; color: #856404; }
        .status-retaken { background: #f8d7da; color: #721c24; }
        tr.retaken { background-color: #fff8f8; }


        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary);
            margin-right: 10px;
            font-size: 1rem;
        }
        .action-btn:hover { color: #2980b9; }
        .action-btn.reject-exam { color: var(--danger); }
        .action-btn.reject-exam:hover { color: #c0392b; }
        .action-btn.edit-exam { color: var(--warning); }
        .action-btn.edit-exam:hover { color: #d35400; }
        
        .action-btn.deactivate-user { color: var(--danger); }
        .action-btn.deactivate-user:hover { color: #c0392b; }
        .action-btn.activate-user { color: var(--secondary); }
        .action-btn.activate-user:hover { color: #27ae60; }
        .action-btn.reset-result { color: var(--warning); }
        .action-btn.reset-result:hover { color: #d35400; }
        .action-btn.delete-result { color: var(--danger); }
        .action-btn.delete-result:hover { color: #c0392b; }


        .resources-cell {
            text-align: right;
        }

        /* Exam Interface */
        .exam-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .exam-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .exam-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
        }
        
        #timeRemaining {
            background: #e3f2fd;
            color: var(--primary);
            padding: 5px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .question-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.1rem;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option:hover {
            background: #f5f5f5;
        }

        .option.selected {
            border-color: var(--primary);
            background: #e3f2fd;
        }
        
        .option input[type="radio"],
        .option input[type="checkbox"] {
            display: inline-block;
            flex-shrink: 0;
            width: 1.15em;
            height: 1.15em;
            margin-right: 5px;
            cursor: pointer;
        }
        
        .answer-textarea {
            width: 100%;
            min-height: 120px;
        }
        .answer-input {
            width: 100%;
        }

        .exam-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .result-card {
            text-align: center; 
            padding: 40px; 
            background: #f8f9fa; 
            border-radius: 12px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto; 
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px; 
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-content.mini {
            max-width: 400px;
            text-align: center;
        }
        
        .modal-body {
            overflow-y: auto;
            flex-grow: 1;
            padding-top: 10px;
        }
        
        .student-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .student-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        .student-list-item:last-child {
            border-bottom: none;
        }
        .student-list-item.empty {
            justify-content: center;
            color: var(--gray);
            font-style: italic;
            padding: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        #confirmationModal .modal-icon {
            font-size: 3rem;
            color: var(--warning);
            margin-bottom: 15px;
        }
        #confirmationModal .modal-icon.danger {
            color: var(--danger);
        }
        #confirmationModal h3 {
            margin-bottom: 10px;
        }
        #confirmationModal p {
            margin-bottom: 20px;
            color: var(--dark);
        }
        #confirmationModal .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        #confirmationModal .modal-actions .btn {
            width: 100%;
        }


        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        /* Exam Editor Styles */
        .question-editor-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        .question-list {
            list-style: none;
            padding: 0;
        }
        
        .question-list-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #questionList.empty-list {
            padding: 40px 20px;
            background: #f9f9f9;
            border-radius: 8px;
            text-align: center;
            color: var(--gray);
            border: 2px dashed #eee;
        }
        #questionList.empty-list::before {
            content: "\f055";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 2rem;
            display: block;
            margin-bottom: 10px;
            color: #ccc;
        }
        #questionList.empty-list::after {
            content: "No questions added. Use the form to add your first question.";
            font-style: italic;
            display: block;
        }
        
        /* Overlay for mobile menu */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            transition: opacity 0.3s ease-in-out;
        }
        .overlay.open {
            display: block;
            opacity: 1;
        }

        /* NEW STYLES FOR BULK UPLOAD */
        .bulk-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 20px;
            flex-direction: column;
            align-items: center;
            width: 220px;
            margin-left: auto;
            margin-right: auto;
            margin-top: -10px;
        }
        .bulk-actions .btn {
            width: 100%;
        }
        .iframe-preview {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        /* NEW: Toast Notification */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: white;
            color: var(--dark);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid var(--primary);
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success { border-left-color: var(--secondary); }
        .toast.error { border-left-color: var(--danger); }
        .toast.info i { color: var(--primary); }

        /* Responsive Utilities */
        .desktop-text { display: inline; }
        .mobile-text { display: none; }
        
        /* --- ACTION MENU (ALWAYS DROPDOWN) --- */
        .action-wrapper {
            display: flex; 
            align-items: center; 
            justify-content: flex-end;
            width: 100%; 
            position: relative; 
            z-index: 5;
        }
        .mobile-menu-trigger {
            background: none;
            border: none;
            font-size: 1.5rem; 
            color: var(--dark);
            padding: 0 5px; 
            cursor: pointer;
            display: block;
            margin-left: auto;
        }
        .action-buttons {
            display: none;
            position: absolute;
            top: 100%; 
            right: 0;
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            flex-direction: column;
            padding: 5px;
            z-index: 10;
            min-width: 130px;
            align-items: flex-start;
        }
        .action-buttons .action-btn {
            width: 100%;
            text-align: left;
            justify-content: flex-start;
            padding: 8px 10px;
            color: var(--dark);
            margin: 0; 
            gap: 10px;
        }
        .action-buttons .action-btn:hover {
            background: var(--light);
            color: var(--primary);
        }
        
        .action-buttons.show {
            display: flex;
        }
        
        .action-buttons.drop-up {
            bottom: 100%;
            top: auto;
        }

        /* --- RESPONSIVE STYLES --- */
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                height: 100vh;
                z-index: 2000;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                width: 280px;
                overflow-y: auto;
                box-shadow: 0 0 20px rgba(0,0,0,0.2);
                border-radius: 0; 
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .sidebar-close {
                display: block;
            }
            .mobile-nav-toggle {
                display: block;
            }
            
            .awa-logo-header {
                display: inline-block;
            }
        }
        
        @media (max-width: 640px) {
            .container { padding: 10px; }
            
            header { 
                padding: 10px 15px; 
                margin-bottom: 20px; 
                height: auto; 
                flex-wrap: nowrap; 
                overflow-x: hidden; 
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .logo h1 { display: none; } 
            .user-info .user-details-text { display: none; } 
            .logout-btn span { display: none; }
            .logout-btn { padding: 8px; margin-left: auto; } 
            .main-content { padding: 15px; }
            .auth-card { padding: 20px; }
            .modal-content { padding: 20px; }
            
            .content-header { 
                margin-bottom: 20px; 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 10px;
            }
            .content-header h2 {
                font-size: 1.3rem; 
            }
            .content-header .content-header-actions {
                flex-direction: column;
                width: 100%;
            }

            .stats-container { 
                grid-template-columns: repeat(2, 1fr);
                gap: 15px; 
            } 
            
            .desktop-text { display: none; }
            .mobile-text { display: inline; }

            table, thead, tbody, th, td, tr {
                display: block;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                margin-bottom: 15px;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                padding: 5px;
            }
            
            tr.empty-state-row {
                border: 1px dashed #ddd;
                box-shadow: none;
                background: #f9f9f9;
            }
            tr.empty-state-row td {
                justify-content: center;
                text-align: center;
                border: none;
                padding: 30px 15px !important;
            }
            tr.empty-state-row td:before {
                display: none;
            }

            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding: 10px 15px !important;
                text-align: right;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.9rem;
            }
            
            td:before {
                content: attr(data-label);
                font-weight: 600;
                text-align: left;
                color: var(--dark);
                margin-right: 15px;
            }

            tr td:last-child {
                border-bottom: none;
                justify-content: space-between; 
                padding-left: 15px !important;
                padding-right: 15px !important; 
            }
            
            tr td:last-child:before {
                display: inline-block !important;
                white-space: nowrap;
            }
            
            tr td:first-child, tr th:first-child { padding-left: 15px; }
            
            .add-question-form { padding: 20px; }
        }
        @media (max-width: 480px) {
            .exam-controls { flex-direction: column; gap: 10px; }
            .exam-controls .btn-sm { width: 100%; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<!-- part -1 start here and below xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
<body>

    <div id="login-section" class="hidden" style="text-align: center; margin-top: 100px;">
    <h2>Please log in to access the Dashboard</h2>
    <button id="login-btn" style="padding: 15px 30px; background-color: #4285F4; color: white; border: none; font-size: 16px; cursor: pointer;">
        Sign in with Google
    </button>
</div>

<div id="quiz-container" style="display: none;">
    </div>
    <div class="overlay" id="overlay"></div>

    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            
            <div class="auth-header">
                <div class="awa-logo-auth">AWA</div> 
                <h1 class="auth-header-title">WELCOME!</h1>
                <div class="logo-icon-wrapper"><i class="fas fa-graduation-cap"></i></div>
            </div>
            
            <div class="logo">
                <div class="logo-icon-wrapper"><i class="fas fa-graduation-cap"></i></div>
                <h1>AWA</h1>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">Login</div>
                <div class="auth-tab" data-tab="register">Register</div>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" value="admin@examsystem.com" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" value="admin123" required>
                </div>
                <button type="submit" class="btn" id="loginButton">
                    <span class="btn-text">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </span>
                    <div class="spinner"></div>
                </button>
            </form>
            <form id="registerForm" class="hidden">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" class="form-control" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="Enter your password" required>
                </div>
                <div class="form-group">
                    <label for="registerRole">Role</label>
                    <select id="registerRole" class="form-control" required>
                        <option value="">Select Role</option>
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                        <option value="admin">Admin</option>
                        <option value="parent">Parent</option>
                    </select>
                </div>
                <button type="submit" class="btn" id="registerButton">
                    <span class="btn-text">
                        <i class="fas fa-user-plus"></i> Register
                    </span>
                    <div class="spinner"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appScreen" class="hidden">
        <div class="container"> 
            <header>
                <div class="header-left">
                    <button class="btn-icon mobile-nav-toggle" id="mobileNavToggle"><i class="fas fa-bars"></i></button>
                    <div class="awa-logo-header">AWA</div>
                    <div class="logo">
                        <div class="logo-icon-wrapper"><i class="fas fa-graduation-cap"></i></div>
                        <h1>AWA</h1>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">AD</div>
                    <div class="user-details-text"> 
                        <div class="user-name" id="userName">Admin User</div>
                        <div class="user-email" id="userEmail">admin@examsystem.com</div>
                    </div>
                    <button class="logout-btn" id="logoutBtn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                    </button>
                </div>
            </header>

            <div class="dashboard">
                <div class="sidebar" id="sidebar">
                    <button class="btn-icon sidebar-close" id="sidebarClose"><i class="fas fa-times"></i></button>
                    <div class="user-role">
                        <div class="role-badge role-admin" id="userRoleBadge">Admin</div>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-item"><a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                        <li class="nav-item"><a href="#" class="nav-link" data-page="users"><i class="fas fa-users"></i> User Management</a></li>
                        <li class="nav-item admin-only"><a href="#" class="nav-link" data-page="classes"><i class="fas fa-chalkboard-teacher"></i> Class Management</a></li>
                        <li class="nav-item"><a href="#" class="nav-link" data-page="exams"><i class="fas fa-file-alt"></i> Exam Management</a></li>
                        <li class="nav-item"><a href="#" class="nav-link" data-page="results"><i class="fas fa-chart-bar"></i> Results & Analytics</a></li>
                        <li class="nav-item"><a href="#" class="nav-link" data-page="takeExam"><i class="fas fa-pencil-alt"></i> Take Exam</a></li>
                    </ul>
                </div>

                <div class="main-content">
                    <!-- Dashboard Page -->
                    <div id="dashboardPage" class="page-content">
                        <div class="content-header">
                            <h2>Dashboard Overview</h2>
                        </div>

                        <div class="stats-container" id="statsContainer">
                            <div class="stat-card clickable" data-page="users" data-filter="all">
                                <div class="stat-value" id="totalUsers">0</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                            <div class="stat-card teacher clickable" data-page="users" data-filter="teacher">
                                <div class="stat-value" id="totalTeachers">0</div>
                                <div class="stat-label">Teachers</div>
                            </div>
                            <div class="stat-card student clickable" data-page="users" data-filter="student">
                                <div class="stat-value" id="totalStudents">0</div>
                                <div class="stat-label">Students</div>
                            </div>
                            <div class="stat-card parent clickable" data-page="users" data-filter="parent">
                                <div class="stat-value" id="totalParents">0</div>
                                <div class="stat-label">Parents</div>
                            </div>
                            <div class="stat-card clickable" data-page="exams">
                                <div class="stat-value" id="totalExams">0</div>
                                <div class="stat-label">Exams Created</div>
                            </div>
                            <div class="stat-card clickable" data-page="results">
                                <div class="stat-value" id="completedExams">0</div>
                                <div class="stat-label">Exams Completed</div>
                            </div>
                        </div>

                        <div class="tabs">
                            <div class="tab active" data-tab="pending">Pending Approval</div>
                            <div class="tab" data-tab="recent">Recent Exams</div>
                            <div class="tab" data-tab="users">User Activity</div>
                        </div>

                        <div class="tab-content active" id="pending-tab">
                            <div class="table-container">
                                <table id="pendingExamsTable">
                                    <thead>
                                        <tr>
                                            <th>Exam Title</th>
                                            <th>Teacher</th>
                                            <th>Questions</th>
                                            <th>Status</th>
                                            <th class="admin-action-header">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-content" id="recent-tab">
                            <div class="table-container">
                                <table id="recentExamsTable">
                                    <thead>
                                        <tr>
                                            <th>Exam Title</th>
                                            <th>Subject</th>
                                            <th>Questions</th>
                                            <th>Participants</th>
                                            <th class="admin-action-header">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-content" id="users-tab">
                            <div class="table-container scrollable-list" id="dashboardUserListContainer">
                                <table id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Role</th>
                                            <th>Joined</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <button class="btn btn-sm" id="showAllUsersBtn" style="width: auto; margin-top: 10px; display: none;">
                                <i class="fas fa-chevron-down"></i> Show all...
                            </button>
                        </div>
                    </div>

                    <!-- Take Exam Page -->
                    <div id="takeExamPage" class="page-content hidden">
                        <div class="exam-container">
                            <div class="exam-header">
                                <button class="btn-icon" id="backToDashboardBtn" style="float: left;" title="Back to Dashboard"><i class="fas fa-arrow-left"></i></button>
                                <h2 id="examTitle">Mathematics Final Exam</h2>
                                <p>Duration: <span id="examDuration">60</span> minutes</p>
                            </div>
                            <div class="exam-info">
                                <div>Time Remaining: <span id="timeRemaining">60:00</span></div>
                                <div>Question: <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span></div>
                            </div>
                            <div class="question-card" id="questionContainer">
                                <div class="question-text" id="questionText">Question Text</div>
                                <div class="options" id="examOptionsContainer"></div>
                            </div>
                            <div id="resultDisplay" class="result-card hidden">
                                <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--secondary); margin-bottom: 20px;"></i>
                                <h3>Exam Submitted!</h3>
                                <p style="font-size: 1.5rem; margin: 20px 0;">Your Score: <span id="finalScoreDisplay" style="font-weight: bold;"></span></p>
                                <button class="btn" id="examDoneBtn" style="width: auto; margin: 0 auto;">Back to Dashboard</button>
                            </div>
                            
                            <div class="exam-controls" id="activeExamControls">
                                <button class="btn btn-sm" id="prevQuestion"><i class="fas fa-arrow-left"></i> Previous</button>
                                <button class="btn btn-sm" id="nextQuestion">Next <i class="fas fa-arrow-right"></i></button>
                                <button class="btn btn-sm hidden" id="submitExam" style="background: var(--secondary);">Submit Exam</button>
                            </div>
                        </div>
                    </div>
                    <!--Part -2  UUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUU-->
                    <!-- NEW MANUAL EXAM PAGE (MATCHING SCREENSHOT) -->
                    <div id="examEditorPage" class="page-content hidden" style="background: transparent; box-shadow: none; padding: 0;">
                        
                        <!-- Header with Title and Back Button -->
                        <div class="editor-header">
                            <h2>Edit Exam</h2>
                            <!-- Blue Back Button -->
                            <button class="btn btn-primary" id="editorBackToDashboardBtn">
                                <i class="fas fa-arrow-left" style="margin-right: 5px;"></i> Back
                            </button>
                        </div>

                        <!-- White Card Container -->
                        <div class="editor-card">
                            <h3 class="editor-section-title">Add New Question</h3>
                            
                            <!-- Form -->
                            <form id="addQuestionForm">
                                <div class="form-group">
                                    <label>Question Type</label>
                                    <select id="questionTypeInput" class="form-control">
                                        <option value="single">Single Choice</option>
                                        <option value="multiple">Multiple Choice (Checkbox)</option>
                                        <option value="truefalse">True / False</option>
                                        <option value="essay">Essay (Text Space)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Question Text</label>
                                    <textarea id="questionTextInput" class="form-control" rows="4" required></textarea>
                                </div>

                                <!-- Options Section -->
                                <div id="add-options-container">
                                    <!-- Options will be injected here dynamically -->
                                </div>

                                <!-- Add Option Button (Grey) -->
                                <div style="margin-bottom: 20px;" id="addOptionBtnContainer">
                                    <button type="button" class="btn btn-grey" id="add-option-btn">
                                        <i class="fas fa-plus" style="margin-right: 5px;"></i> Add Option
                                    </button>
                                </div>

                                <!-- Add Question Button (Blue) -->
                                <button type="submit" class="btn btn-primary">
                                    Add Question
                                </button>
                            </form>
                        </div>

                        <!-- Existing Questions Section -->
                        <div style="margin-top: 20px;">
                            <h3 class="editor-section-title">Existing Questions (<span id="questionCount">0</span>)</h3>
                            <ul id="questionList" class="question-list">
                                <!-- Items go here -->
                            </ul>
                            
                            <!-- Save and Exit Button (Green) -->
                            <button class="btn btn-success" id="saveAndExitExamBtn">
                                <i class="fas fa-save" style="margin-right: 5px;"></i> Save and Exit
                            </button>
                        </div>
                    </div>

                    <!-- User Management Page -->
                    <div id="usersPage" class="page-content hidden">
                         <div class="content-header">
                             <h2 id="usersPageTitle">User Management</h2>
                             <button class="btn btn-sm back-to-dashboard-btn"><i class="fas fa-arrow-left"></i> Back</button>
                         </div>
                         <div class="table-container scrollable-list" id="manageUserListContainer">
                             <table id="manageUsersTable">
                                 <thead>
                                     <tr>
                                         <th>Name</th>
                                         <th>Email</th>
                                         <th>Role</th>
                                         <th>Status</th>
                                         <th class="admin-action-header">Actions</th>
                                     </tr>
                                 </thead>
                                 <tbody></tbody>
                             </table>
                         </div>
                         <button class="btn btn-sm" id="showAllManageUsersBtn" style="width: auto; margin-top: 10px; display: none;">
                             <i class="fas fa-chevron-down"></i> Show all users...
                         </button>
                    </div>

                    <!-- Exam Management Page -->
                    <div id="examsPage" class="page-content hidden">
                         <div class="content-header">
                             <h2>Exam Management</h2>
                             <button class="btn btn-sm back-to-dashboard-btn"><i class="fas fa-arrow-left"></i> Back</button>
                         </div>
                         
                         <div class="bulk-actions" id="bulkUploadSection">
                             <button class="btn btn-sm btn-success admin-only" id="downloadExamsBtn" title="Download All Exams">
                                 <i class="fas fa-download"></i> Export JSON
                             </button>
                             <button class="btn btn-sm admin-only" id="bulkUploadBtn" title="Upload JSON File">
                                <i class="fas fa-upload"></i> Bulk Upload JSON
                             </button>
                             <input type="file" id="bulkJsonInput" accept=".json" style="display: none;">
                             <button class="btn btn-sm admin-only" id="addExamBtn">
                                 <i class="fas fa-plus"></i> Add New Exam
                             </button>
                         </div>

                         <div class="table-container scrollable-list" id="manageExamListContainer">
                             <table id="manageExamsTable">
                                 <thead>
                                     <tr>
                                         <th>Exam Title</th>
                                         <th>Exam ID</th> 
                                         <th>Subject</th>
                                         <th>Duration</th>
                                         <th class="resources-cell">Resources</th>
                                         <th class="admin-action-header">Actions</th>
                                     </tr>
                                 </thead>
                                 <tbody></tbody>
                             </table>
                         </div>
                         <button class="btn btn-sm" id="showAllManageExamsBtn" style="width: auto; margin-top: 10px; display: none;">
                             <i class="fas fa-chevron-down"></i> Show all exams...
                         </button>
                    </div>

                    <!-- Class Management Page -->
                    <div id="classesPage" class="page-content hidden">
                         <div class="content-header">
                             <h2>Class Management</h2>
                             <div class="content-header-actions admin-only">
                                <button class="btn btn-sm" id="createClassBtn"><i class="fas fa-plus"></i> Create Class</button>
                                <button class="btn btn-sm back-to-dashboard-btn"><i class="fas fa-arrow-left"></i> Back</button>
                             </div>
                         </div>
                         
                         <div class="table-container scrollable-list" id="manageClassListContainer">
                             <table id="manageClassesTable">
                                 <thead>
                                     <tr>
                                         <th>Class Name</th>
                                         <th>Teacher</th>
                                         <th>Students</th>
                                         <th>Exams</th>
                                         <th class="admin-action-header">Actions</th>
                                     </tr>
                                 </thead>
                                 <tbody></tbody>
                             </table>
                         </div>
                         <button class="btn btn-sm admin-only" id="showAllManageClassesBtn" style="width: auto; margin-top: 10px; display: none;">
                             <i class="fas fa-chevron-down"></i> Show all classes...
                         </button>
                    </div>

                    <div id="resultsPage" class="page-content hidden">
                         <div class="content-header">
                             <h2>Results & Analytics</h2>
                             <button class="btn btn-sm back-to-dashboard-btn"><i class="fas fa-arrow-left"></i> Back</button>
                         </div>
                         <div class="table-container">
                             <table id="resultsTable">
                                 <thead>
                                     <tr>
                                         <th>Student</th>
                                         <th>Exam</th>
                                         <th>Score</th>
                                         <th>Date</th>
                                         <th>Status</th>
                                         <th class="admin-action-header">Actions</th>
                                     </tr>
                                 </thead>
                                 <tbody></tbody>
                             </table>
                         </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="toastContainer"></div>
    </div>

    <!-- MODALS -->
    
    <!-- CREATE NEW EXAM MODAL (MATCHING SCREENSHOT 1) -->
    <div class="modal" id="addExamModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Exam</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="examForm">
                <div class="form-group">
                    <label for="examTitleInput">Exam Title</label>
                    <input type="text" id="examTitleInput" class="form-control" placeholder="Enter exam title" required>
                </div>
                <div class="form-group">
                    <label for="examSubject">Subject</label>
                    <input type="text" id="examSubject" class="form-control" placeholder="e.g., Biology 101" required>
                </div>
                <div class="form-group">
                    <label for="examDate">Exam Date</label>
                    <input type="date" id="examDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="examDurationInput">Duration (minutes) <small style="font-weight:400; color:#777">(0 for untimed)</small></label>
                    <input type="number" id="examDurationInput" class="form-control" value="60" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn" style="width: 100%;">Create & Add Questions</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="editUserModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit User</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label for="editUserNameInput">Full Name</label>
                    <input type="text" id="editUserNameInput" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editUserRoleInput">Role</label>
                    <select id="editUserRoleInput" class="form-control" required>
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                        <option value="admin">Admin</option>
                        <option value="parent">Parent</option> 
                    </select>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <div class="modal" id="pdfPreviewModal" data-close="true">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Resource Preview</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <div id="pdfContainer">
            </div>
        </div>
    </div>

    <div class="modal" id="addResourceModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Attach Resource</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="resourceForm">
                <input type="hidden" id="resourceExamId">
                <div class="form-group">
                    <label>Resource Type</label>
                    <select id="resourceType" class="form-control">
                        <option value="link">External Link (Reference)</option>
                        <option value="pdf">PDF File</option>
                    </select>
                </div>
                
                <div id="linkInputGroup" class="form-group">
                    <label for="resourceLink">URL</label>
                    <input type="url" id="resourceLink" class="form-control" placeholder="https://example.com">
                </div>

                <div id="pdfInputGroup" class="form-group hidden">
                    <label for="resourcePdf">Upload PDF</label>
                    <input type="file" id="resourcePdf" class="form-control" accept="application/pdf">
                    <p style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">Note: For simulation, PDF is viewable only during this session.</p>
                </div>

                <button type="submit" class="btn">Attach Resource</button>
            </form>
        </div>
    </div>

    <div class="modal" id="securityModal" data-close="true"> 
        <div class="modal-content mini">
            <i class="fas fa-shield-alt" style="font-size: 3rem; color: var(--warning); margin-bottom: 15px;"></i>
            <h3 style="margin-bottom: 10px;">Admin Access Required</h3>
            <p style="margin-bottom: 20px;">Please enter the admin security code.</p>
            <input type="password" id="securityCodeInput" class="form-control" placeholder="Enter Code" style="text-align: center; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" id="cancelSecurityBtn" data-close="true">Cancel</button> 
                <button class="btn" id="confirmSecurityBtn">Verify</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="joinExamModal" data-close="true">
        <div class="modal-content mini">
            <div class="modal-header">
                <h3>Join Exam</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
             <form id="joinExamForm">
                 <div class="form-group">
                     <label for="joinExamCodeInput" style="text-align: left;">Exam ID</label>
                     <input type="text" id="joinExamCodeInput" class="form-control" placeholder="Enter Exam ID" required style="text-align: center; text-transform: uppercase;">
                 </div>
                 <button type="submit" class="btn" id="joinExamButton">
                     <span class="btn-text">
                         <i class="fas fa-pencil-alt"></i> Start Exam
                     </span>
                     <div class="spinner"></div>
                 </button>
             </form>
        </div>
    </div>
    
    <div class="modal" id="confirmationModal" data-close="true">
        <div class="modal-content mini">
            <div id="confirmIcon" class="modal-icon danger"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 id="confirmTitle">Are you sure?</h3>
            <p id="confirmText">This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn btn-warning" id="confirmCancelBtn" data-close="true">Cancel</button> 
                <button class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="classModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="classModalTitle">Create New Class</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="classForm">
                <input type="hidden" id="classModalId">
                <div class="form-group">
                    <label for="classNameInput">Class Name</label>
                    <input type="text" id="classNameInput" class="form-control" placeholder="e.g., Grade 10 Physics" required>
                </div>
                <div class="form-group">
                    <label for="classTeacherInput">Assign Teacher</label>
                    <input type="text" id="classTeacherInput" class="form-control" placeholder="Enter teacher's name" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Save Class</button>
            </form>
        </div>
    </div>
    
    <div class="modal" id="manageStudentsModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="manageStudentsTitle">Manage Students</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="manageStudentsClassId">
                <h4>Current Roster</h4>
                <ul class="student-list" id="currentStudentList">
                    <li class="student-list-item empty">No students in this class.</li>
                </ul>
                
                <h4 style="margin-top: 20px;">Add Student</h4>
                <div class="form-group">
                    <label for="addStudentSelect">Select Student to Add</label>
                    <select id="addStudentSelect" class="form-control">
                        <option value="">Select a Student...</option>
                    </select>
                </div>
                <button class="btn btn-sm" id="addStudentToClassBtn" style="width: auto;">Add Student</button>
            </div>
        </div>
    </div>
    <!-- part -2 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
    <div class="modal" id="assignExamModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="assignExamTitle">Assign Exam</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="assignExamClassId">
                <div class="form-group">
                    <label for="assignExamSelect">Select Exam to Assign</label>
                    <select id="assignExamSelect" class="form-control">
                        <option value="">Select an Approved Exam...</option>
                    </select>
                </div>
                <button class="btn" id="assignExamToClassBtn">Assign Exam to Class</button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        let authScreen, appScreen, loginForm, registerForm, logoutBtn, authTabs, navLinks, pages, tabs, tabContents, addExamBtn, addExamModal, examForm, pendingExamsTableBody, recentExamsTableBody, usersTableBody, manageUsersTableBody, resultsTableBody, manageExamsTableBody, examOptionsContainer, prevQuestionBtn, nextQuestionBtn, submitExamBtn, backToDashboardBtn, examDoneBtn, examEditorPage, addQuestionForm, questionList, questionCount, editorBackToDashboardBtn, editUserModal, editUserForm, pdfPreviewModal, addResourceModal, securityModal, joinExamModal, joinExamForm, joinExamCodeInput, confirmationModal, bulkJsonInput, bulkUploadBtn, downloadExamsBtn, mobileNavToggle, sidebar, sidebarClose, overlay, usersPageTitle, showAllUsersBtn, showAllManageUsersBtn, statsContainer, showAllManageExamsBtn, saveAndExitExamBtn, manageExamListContainer, createClassBtn, classesPage, manageClassesTableBody, classModal, classForm, manageStudentsModal, assignExamModal, manageClassListContainer, showAllManageClassesBtn;

        // Mock Database
        class MockDatabase {
            constructor() {
                this.users = JSON.parse(localStorage.getItem('examUsers')) || [];
                this.exams = JSON.parse(localStorage.getItem('examExams')) || [];
                this.results = JSON.parse(localStorage.getItem('examResults')) || [];
                this.classes = JSON.parse(localStorage.getItem('examClasses')) || [];
                
                if (this.users.length === 0) {
                    this.initializeDemoData();
                }
            }
            
            initializeDemoData() {
                this.users = [
                    { id: 1, name: 'Admin User', email: 'admin@examsystem.com', password: 'admin123', role: 'admin', status: 'active', joinedDate: new Date() },
                    { id: 2, name: 'Teacher One', email: 'teacher@examsystem.com', password: 'teacher123', role: 'teacher', status: 'active', joinedDate: new Date() },
                    { id: 3, name: 'Student One', email: 'student@examsystem.com', password: 'student123', role: 'student', status: 'active', joinedDate: new Date() },
                ];
                this.exams = [];
                this.results = [];
                this.classes = [];
                this.saveToStorage();
            }
            
            saveToStorage() {
                localStorage.setItem('examUsers', JSON.stringify(this.users));
                localStorage.setItem('examExams', JSON.stringify(this.exams));
                localStorage.setItem('examResults', JSON.stringify(this.results));
                localStorage.setItem('examClasses', JSON.stringify(this.classes));
            }
            
            findUserByEmail(email) { return this.users.find(user => user.email === email); }
            findUserById(id) { return this.users.find(user => user.id === id); } 
            
            createUser(userData) {
                const newUser = { 
                    id: Date.now(), 
                    ...userData, 
                    status: 'active',
                    joinedDate: new Date() 
                };
                this.users.push(newUser);
                this.saveToStorage();
                return newUser;
            }
            
            updateUser(userId, updates) {
                const user = this.findUserById(userId);
                if (user) {
                    Object.assign(user, updates);
                    this.saveToStorage();
                    return user;
                }
                return null;
            }
            
            getExams() { return this.exams; }
            findExamById(id) { return this.exams.find(e => e.id === id); }
            findExamByCode(code) { return this.exams.find(e => e.examCode && e.examCode.toUpperCase() === code.toUpperCase()); } 
            
            generateExamCode() {
                let code;
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ123456789';
                do {
                    code = 'EX-';
                    for(let i=0; i<4; i++) {
                        code += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                } while (this.findExamByCode(code));
                return code;
            }
            
            createExam(examData) {
                const newExam = { 
                    id: Date.now(), 
                    examCode: this.generateExamCode(),
                    resources: [], 
                    ...examData, 
                    questions: examData.questions || [] 
                };
                
                this.exams.push(newExam);
                this.saveToStorage();
                return newExam;
            }

            updateExam(examId, updates) {
                 const exam = this.findExamById(examId);
                 if (exam) {
                       Object.assign(exam, updates);
                       this.saveToStorage();
                       return exam;
                 }
                 return null;
            }

            deleteExam(examId) { 
                this.exams = this.exams.filter(e => e.id !== examId);
                this.results = this.results.filter(r => r.examId !== examId);
                this.classes.forEach(cls => {
                    cls.exams = cls.exams.filter(id => id !== examId);
                });
                this.saveToStorage();
            }

            updateExamStatus(examId, status) {
                const exam = this.findExamById(examId);
                if (exam) { exam.status = status; this.saveToStorage(); return exam; }
                return null;
            }

            addQuestionToExam(examId, questionData) {
                const exam = this.findExamById(examId);
                if (exam) { exam.questions.push(questionData); this.saveToStorage(); }
            }

            deleteQuestionFromExam(examId, questionIndex) {
                const exam = this.findExamById(examId);
                if (exam && exam.questions[questionIndex]) { exam.questions.splice(questionIndex, 1); this.saveToStorage(); }
            }

            addResourceToExam(examId, resource) {
                const exam = this.findExamById(examId);
                if(exam) {
                    if(!exam.resources) exam.resources = [];
                    exam.resources.push(resource);
                    this.saveToStorage();
                }
            }
            
            saveResult(resultData) {
                const newResult = { id: Date.now(), ...resultData, date: new Date().toLocaleString(), status: 'active' };
                this.results.push(newResult);
                this.saveToStorage();
            }
            updateResultStatus(resultId, status) {
                const result = this.results.find(r => r.id === resultId);
                if (result) {
                    result.status = status;
                    this.saveToStorage();
                }
            }
            deleteResult(resultId) {
                this.results = this.results.filter(r => r.id !== resultId);
                this.saveToStorage();
            }
            hasStudentTakenExam(studentId, examId) {
                return this.results.some(r => r.studentId === studentId && r.examId === examId && r.status === 'active');
            }
            
            getClasses() { return this.classes; }
            findClassById(id) { return this.classes.find(c => c.id === id); }
            createClass(classData) {
                const newClass = { id: Date.now(), students: [], exams: [], ...classData };
                this.classes.push(newClass);
                this.saveToStorage();
                return newClass;
            }
            updateClass(classId, updates) {
                const cls = this.findClassById(classId);
                if(cls) {
                    Object.assign(cls, updates);
                    this.saveToStorage();
                    return cls;
                }
                return null;
            }
            deleteClass(classId) {
                this.classes = this.classes.filter(c => c.id !== classId);
                this.saveToStorage();
            }
            addStudentToClass(classId, studentId) {
                const cls = this.findClassById(classId);
                if (cls && !cls.students.includes(studentId)) {
                    cls.students.push(studentId);
                    this.saveToStorage();
                }
            }
            removeStudentFromClass(classId, studentId) {
                const cls = this.findClassById(classId);
                if (cls) {
                    cls.students = cls.students.filter(id => id !== studentId);
                    this.saveToStorage();
                }
            }
            assignExamToClass(classId, examId) {
                const cls = this.findClassById(classId);
                if (cls && !cls.exams.includes(examId)) {
                    cls.exams.push(examId);
                    this.saveToStorage();
                }
            }
        }

        const state = {
            currentUser: null,
            currentPage: 'dashboard',
            db: new MockDatabase(),
            currentExam: null,
            currentQuestionIndex: 0,
            userAnswers: [],
            examTimer: null,
            timeRemaining: 0,
            editingExamId: null,
            editingUserId: null, 
            editingClassId: null, 
            userFilter: 'all',
            isPreviewMode: false,
            pendingAction: null,
            pendingConfirmation: null, 
        };

        function init() {
            authScreen = document.getElementById('authScreen');
            appScreen = document.getElementById('appScreen');
            loginForm = document.getElementById('loginForm');
            registerForm = document.getElementById('registerForm');
            logoutBtn = document.getElementById('logoutBtn');
            authTabs = document.querySelectorAll('.auth-tab');
            navLinks = document.querySelectorAll('.nav-link');
            pages = document.querySelectorAll('.page-content');
            tabs = document.querySelectorAll('.tab');
            tabContents = document.querySelectorAll('.tab-content');
            addExamBtn = document.getElementById('addExamBtn');
            addExamModal = document.getElementById('addExamModal');
            examForm = document.getElementById('examForm');
            
            pendingExamsTableBody = document.getElementById('pendingExamsTable').querySelector('tbody');
            recentExamsTableBody = document.getElementById('recentExamsTable').querySelector('tbody');
            usersTableBody = document.getElementById('usersTable').querySelector('tbody');
            manageUsersTableBody = document.getElementById('manageUsersTable').querySelector('tbody');
            resultsTableBody = document.getElementById('resultsTable').querySelector('tbody');
            manageExamsTableBody = document.getElementById('manageExamsTable').querySelector('tbody');

            examOptionsContainer = document.getElementById('examOptionsContainer');
            prevQuestionBtn = document.getElementById('prevQuestion');
            nextQuestionBtn = document.getElementById('nextQuestion');
            submitExamBtn = document.getElementById('submitExam');
            backToDashboardBtn = document.getElementById('backToDashboardBtn');
            examDoneBtn = document.getElementById('examDoneBtn'); 

            examEditorPage = document.getElementById('examEditorPage');
            addQuestionForm = document.getElementById('addQuestionForm');
            questionList = document.getElementById('questionList');
            questionCount = document.getElementById('questionCount');
            editorBackToDashboardBtn = document.getElementById('editorBackToDashboardBtn');
            
            editUserModal = document.getElementById('editUserModal'); 
            editUserForm = document.getElementById('editUserForm'); 
            pdfPreviewModal = document.getElementById('pdfPreviewModal');
            addResourceModal = document.getElementById('addResourceModal');
            securityModal = document.getElementById('securityModal');
            
            joinExamModal = document.getElementById('joinExamModal');
            joinExamForm = document.getElementById('joinExamForm');
            joinExamCodeInput = document.getElementById('joinExamCodeInput');
            
            confirmationModal = document.getElementById('confirmationModal');
            
            bulkJsonInput = document.getElementById('bulkJsonInput');
            bulkUploadBtn = document.getElementById('bulkUploadBtn');
            downloadExamsBtn = document.getElementById('downloadExamsBtn');

            mobileNavToggle = document.getElementById('mobileNavToggle');
            sidebar = document.getElementById('sidebar');
            sidebarClose = document.getElementById('sidebarClose');
            overlay = document.getElementById('overlay');
            usersPageTitle = document.getElementById('usersPageTitle');
            statsContainer = document.getElementById('statsContainer');
            
            showAllUsersBtn = document.getElementById('showAllUsersBtn');
            showAllManageUsersBtn = document.getElementById('showAllManageUsersBtn');
            showAllManageExamsBtn = document.getElementById('showAllManageExamsBtn');
            saveAndExitExamBtn = document.getElementById('saveAndExitExamBtn');
   
            manageExamListContainer = document.getElementById('manageExamListContainer');
           
            createClassBtn = document.getElementById('createClassBtn');
            classesPage = document.getElementById('classesPage');
            manageClassesTableBody = document.getElementById('manageClassesTable').querySelector('tbody');
            classModal = document.getElementById('classModal');
            classForm = document.getElementById('classForm');
            manageStudentsModal = document.getElementById('manageStudentsModal');
            assignExamModal = document.getElementById('assignExamModal');
            manageClassListContainer = document.getElementById('manageClassListContainer');
            showAllManageClassesBtn = document.getElementById('showAllManageClassesBtn');
              
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                state.currentUser = JSON.parse(savedUser);
                if (!state.db.findUserById(state.currentUser.id)) {
                    handleLogout(); 
                    return;
                }
                showApp();
            } else {
                showAuth();
            }
            setupEventListeners();
            updateUI();
        }

        function setupEventListeners() {
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    switchAuthTab(tab.getAttribute('data-tab'));
                });
            });
            
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            logoutBtn.addEventListener('click', handleLogout);
            
            joinExamForm.addEventListener('submit', handleJoinExam);

            document.getElementById('confirmCancelBtn').addEventListener('click', () => {
                confirmationModal.style.display = 'none';
                state.pendingConfirmation = null;
            });
            document.getElementById('confirmActionBtn').addEventListener('click', () => {
                if (state.pendingConfirmation) {
                    state.pendingConfirmation();
                }
                confirmationModal.style.display = 'none';
                state.pendingConfirmation = null;
            });
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (link.dataset.page === 'users') {
                        state.userFilter = 'all';
                        updateTables();
                    }
                    handleNavClick(link.dataset.page);
                    if (window.innerWidth <= 900) closeSidebar();
                });
            });
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.getAttribute('data-tab'));
                });
            });
            
            addExamBtn.addEventListener('click', () => {
                performAdminAction(() => {
                    document.getElementById('examDate').valueAsDate = new Date();
                    addExamModal.style.display = 'flex';
                });
            });
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target.dataset.close === 'true') {
                        modal.style.display = 'none';
                        if(modal.id === 'securityModal') state.pendingAction = null;
                        if(modal.id === 'confirmationModal') state.pendingConfirmation = null;
                    }
                });
            });

            examForm.addEventListener('submit', handleCreateExam);
            
            pendingExamsTableBody.addEventListener('click', handleDashboardTableClick);
            recentExamsTableBody.addEventListener('click', handleDashboardTableClick);
            manageExamsTableBody.addEventListener('click', handleExamManagementClick);
            manageUsersTableBody.addEventListener('click', handleUserManagementClick); 
            resultsTableBody.addEventListener('click', handleResultsTableClick);
            
            submitExamBtn.addEventListener('click', handleSubmitExam);
            nextQuestionBtn.addEventListener('click', handleNextQuestion);
            prevQuestionBtn.addEventListener('click', handlePrevQuestion);
            
            backToDashboardBtn.addEventListener('click', handleBackToDashboard); 
            examDoneBtn.addEventListener('click', handleBackToDashboard); 

async function saveExamAndExit() {
    // Ensure exam ID exists
    const examId = state.editingExamId;
    if (!examId) {
        showToast("No exam is being edited.", "error");
        return;
    }

    // Get the exam object directly from MockDB (this contains questions!)
    const exam = state.db.findExamById(examId);
    if (!exam) {
        showToast("Exam not found in local database.", "error");
        return;
    }

    // Build Firestore-ready object
    const firestoreExam = {
        title: exam.title || "",
        subject: exam.subject || "",
        duration: exam.duration || 0,
        teacher: exam.teacher || "",
        questions: exam.questions || [],
        createdAt: new Date()
    };

    // Save to Firestore
    try {
        await addDoc(collection(db, "exams"), firestoreExam);
        showToast("Exam saved to Firestore!", "success");
    } catch (error) {
        console.error("Error saving exam:", error);
        showToast("Error saving to Firestore. Check console.", "error");
    }

    // Return to dashboard
    handleBackToDashboard();
    
}
    saveAndExitExamBtn.addEventListener('click', saveExamAndExit);


            
    document.querySelectorAll('.back-to-dashboard-btn').forEach(btn => {
     btn.addEventListener('click', handleBackToDashboard); 
            });
            editorBackToDashboardBtn.addEventListener('click', handleBackToDashboard);

            examOptionsContainer.addEventListener('click', (e) => {
                const clickedOption = e.target.closest('.option');
                if (!clickedOption) return;
                if (state.isPreviewMode) return;
                
                const input = clickedOption.querySelector('input');
                if (input.type === 'radio') {
                    examOptionsContainer.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                    clickedOption.classList.add('selected');
                    input.checked = true;
                } else if (input.type === 'checkbox') {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                         input.checked = !input.checked;
                    }
                    clickedOption.classList.toggle('selected', input.checked);
                }
                
                saveAnswer();
            });
            
            addQuestionForm.addEventListener('submit', handleAddQuestion);
            
            // --- NEW: Dynamic Question Form Handler ---
            document.getElementById('questionTypeInput').addEventListener('change', function() {
                const type = this.value;
                resetDynamicOptions(type);
            });
            
            document.getElementById('add-option-btn').addEventListener('click', addDynamicOption);

            questionList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-question');
                if (deleteBtn) { handleDeleteQuestion(state.editingExamId, parseInt(deleteBtn.dataset.index)); }
            });
            
            editUserForm.addEventListener('submit', handleUpdateUser); 

            mobileNavToggle.addEventListener('click', openSidebar);
            sidebarClose.addEventListener('click', closeSidebar);
            overlay.addEventListener('click', closeSidebar);
            
            statsContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.stat-card.clickable');
                if (!card) return;
                
                if (!state.currentUser || (state.currentUser.role === 'student' && (card.dataset.page === 'users' || card.dataset.page === 'exams'))) {
                    return;
                }
                
                const page = card.dataset.page;
                const filter = card.dataset.filter;
                
                if (page === 'users') {
                    state.userFilter = filter || 'all';
                    updateTables(); 
                }
                handleNavClick(page);
            });

            bulkUploadBtn.addEventListener('click', () => {
                performAdminAction(() => {
                    bulkJsonInput.click();
                });
            });
            bulkJsonInput.addEventListener('change', handleBulkUpload);
            downloadExamsBtn.addEventListener('click', exportExams);

            const resourceType = document.getElementById('resourceType');
            resourceType.addEventListener('change', () => {
                if(resourceType.value === 'pdf') {
                    document.getElementById('pdfInputGroup').classList.remove('hidden');
                    document.getElementById('linkInputGroup').classList.add('hidden');
                } else {
                    document.getElementById('pdfInputGroup').classList.add('hidden');
                    document.getElementById('linkInputGroup').classList.remove('hidden');
                }
            });
            document.getElementById('resourceForm').addEventListener('submit', handleAddResource);
            
            document.getElementById('confirmSecurityBtn').addEventListener('click', verifySecurityCode);
            document.getElementById('cancelSecurityBtn').addEventListener('click', () => {
                securityModal.style.display = 'none';
                state.pendingAction = null;
            });

            document.body.addEventListener('click', (e) => {
                const trigger = e.target.closest('.mobile-menu-trigger');
                
                document.querySelectorAll('.action-buttons.show').forEach(el => {
                    if(!trigger || el !== trigger.closest('.action-wrapper').querySelector('.action-buttons')) {
                        el.classList.remove('show');
                        el.classList.remove('drop-up'); 
                    }
                });

                if(trigger) {
                    const container = trigger.closest('.action-wrapper').querySelector('.action-buttons');
                    const rect = trigger.getBoundingClientRect();
                    const isNearBottom = (window.innerHeight - rect.bottom) < 160; 
                    if (isNearBottom) {
                        container.classList.add('drop-up');
                    } else {
                        container.classList.remove('drop-up');
                    }
                    container.classList.toggle('show');
                }
            });
            
            showAllUsersBtn.addEventListener('click', () => {
                document.getElementById('dashboardUserListContainer').classList.toggle('expanded');
                showAllUsersBtn.classList.toggle('active');
                if (showAllUsersBtn.classList.contains('active')) {
                    showAllUsersBtn.innerHTML = `<i class="fas fa-chevron-up"></i> Show fewer`;
                } else {
                    showAllUsersBtn.innerHTML = `<i class="fas fa-chevron-down"></i> Show all...`;
                }
                updateTables(true); 
            });
            
            showAllManageUsersBtn.addEventListener('click', () => {
                document.getElementById('manageUserListContainer').classList.toggle('expanded');
                showAllManageUsersBtn.classList.toggle('active');
                if (showAllManageUsersBtn.classList.contains('active')) {
                    showAllManageUsersBtn.innerHTML = `<i class="fas fa-chevron-up"></i> Show fewer`;
                } else {
                    showAllManageUsersBtn.innerHTML = `<i class="fas fa-chevron-down"></i> Show all users...`;
                }
                updateTables(true); 
            });
            
            showAllManageExamsBtn.addEventListener('click', () => {
                manageExamListContainer.classList.toggle('expanded');
                showAllManageExamsBtn.classList.toggle('active');
                if (showAllManageExamsBtn.classList.contains('active')) {
                    showAllManageExamsBtn.innerHTML = `<i class="fas fa-chevron-up"></i> Show fewer`;
                } else {
                    showAllManageExamsBtn.innerHTML = `<i class="fas fa-chevron-down"></i> Show all exams...`;
                }
                renderExamManagementTable(); 
            });
            
            createClassBtn.addEventListener('click', () => openCreateClassModal());
            classForm.addEventListener('submit', handleSaveClass);
            manageClassesTableBody.addEventListener('click', handleClassManagementClick);
            
            document.getElementById('addStudentToClassBtn').addEventListener('click', handleAddStudentToClass);
            document.getElementById('assignExamToClassBtn').addEventListener('click', handleAssignExamToClass);
            
            showAllManageClassesBtn.addEventListener('click', () => {
                manageClassListContainer.classList.toggle('expanded');
                showAllManageClassesBtn.classList.toggle('active');
                if (showAllManageClassesBtn.classList.contains('active')) {
                    showAllManageClassesBtn.innerHTML = `<i class="fas fa-chevron-up"></i> Show fewer`;
                } else {
                    showAllManageClassesBtn.innerHTML = `<i class="fas fa-chevron-down"></i> Show all classes...`;
                }
                renderClassManagementTable(); 
            });
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            toast.innerHTML = `<i class="fas ${icon}" style="color: var(--${type === 'info' ? 'primary' : type});"></i> <span class="toast-message">${message}</span>`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        container.removeChild(toast);
                    }
                }, 300); 
            }, 3000);
        }
        
        function showConfirmation(title, text, onConfirm, type = 'danger') {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmText').textContent = text;
            
            const iconDiv = document.getElementById('confirmIcon');
            const confirmBtn = document.getElementById('confirmActionBtn');
            
            iconDiv.className = `modal-icon ${type}`;
            confirmBtn.className = `btn btn-${type}`;
            
            if(type === 'danger') {
                iconDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i>`;
            } else if (type === 'warning') {
                iconDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i>`;
            } else {
                 iconDiv.innerHTML = `<i class="fas fa-question-circle"></i>`;
            }
            
            state.pendingConfirmation = onConfirm;
            confirmationModal.style.display = 'flex';
        }
        
        function setButtonLoading(button, isLoading) {
            button.disabled = isLoading;
            button.classList.toggle('loading', isLoading);
        }

        function performAdminAction(callback) {
            if(state.currentUser.role !== 'admin') {
                showToast("This action requires admin privileges.", "error");
                return;
            }
            state.pendingAction = callback;
            document.getElementById('securityCodeInput').value = '';
            securityModal.style.display = 'flex';
        }

        function verifySecurityCode() {
            const code = document.getElementById('securityCodeInput').value;
            if (code === "ADMIN123") {
                securityModal.style.display = 'none';
                if(state.pendingAction) state.pendingAction();
                showToast("Admin action verified.", "success");
            } else {
                showToast("Access Denied: Invalid Code", "error");
            }
            state.pendingAction = null;
        }

        function openSidebar() { sidebar.classList.add('open'); overlay.classList.add('open'); }
        function closeSidebar() { sidebar.classList.remove('open'); overlay.classList.remove('open'); }
        
        function handleNavClick(page) {
            if (page === 'takeExam') {
                joinExamCodeInput.value = '';
                joinExamModal.style.display = 'flex';
            } else {
                switchPage(page);
                if(page === 'exams') renderExamManagementTable();
                if(page === 'results') renderResultsTable();
                if(page === 'users') updateTables(); 
                if(page === 'classes') renderClassManagementTable(); 
            }
            navLinks.forEach(l => l.classList.toggle('active', l.dataset.page === page));
        }
        // part -3   xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        function handleBackToDashboard() {
            if (state.examTimer) clearInterval(state.examTimer);
            state.currentExam = null;
            state.editingExamId = null;
            state.isPreviewMode = false;
            switchPage('dashboard');
            navLinks.forEach(l => l.classList.toggle('active', l.dataset.page === 'dashboard'));
            
            if (state.currentUser) {
                updateTables(); 
                updateStats(); 
            }
        }
        
        function handleDashboardTableClick(e) {
            const btn = e.target.closest('button');
            if(!btn || btn.classList.contains('mobile-menu-trigger')) return; 
            
            const examId = parseInt(btn.dataset.id);
            
            if (btn.classList.contains('approve-exam')) {
                performAdminAction(() => { 
                    state.db.updateExamStatus(examId, 'approved'); 
                    updateTables(); 
                    updateStats(); 
                    showToast("Exam approved.", "success");
                });
            } else if (btn.classList.contains('reject-exam')) {
                performAdminAction(() => { 
                    state.db.updateExamStatus(examId, 'rejected'); 
                    updateTables(); 
                    updateStats(); 
                    showToast("Exam rejected.", "info");
                });
            } else if (btn.classList.contains('edit-exam')) {
                performAdminAction(() => { 
                    openExamEditor(examId); 
                });
            }
        }
        
        function handleExamManagementClick(e) {
            const target = e.target.closest('button');
            if(!target || target.classList.contains('mobile-menu-trigger')) return;
            
            const id = parseInt(target.dataset.id);

            if(target.classList.contains('btn-resource')) {
                performAdminAction(() => {
                    document.getElementById('resourceExamId').value = id;
                    document.getElementById('resourceForm').reset();
                    document.getElementById('resourceType').value = 'link';
                    document.getElementById('pdfInputGroup').classList.add('hidden');
                    document.getElementById('linkInputGroup').classList.remove('hidden');
                    addResourceModal.style.display = 'flex';
                });
            } else if(target.classList.contains('btn-preview')) {
                const url = target.dataset.url;
                const type = target.dataset.type;
                if(type === 'pdf') {
                    document.getElementById('pdfContainer').innerHTML = `<iframe class="iframe-preview" src="${url}"></iframe>`;
                    pdfPreviewModal.style.display = 'flex';
                } else { window.open(url, '_blank'); }
            } else if (target.classList.contains('edit-exam')) {
                performAdminAction(() => { openExamEditor(id); });
            } else if (target.classList.contains('delete-exam')) {
                 performAdminAction(() => {
                    const exam = state.db.findExamById(id);
                    showConfirmation("Delete Exam?", `Are you sure you want to delete "${exam.title}"? This will also remove all results. This cannot be undone.`, () => {
                        state.db.deleteExam(id);
                        renderExamManagementTable();
                        updateTables(); 
                        updateStats();
                        showToast("Exam deleted successfully.", "success");
                    });
                });
            } else if (target.classList.contains('preview-exam-btn')) {
                startExam(id, true);
            }
        }
        
        function handleUserManagementClick(e) {
            const target = e.target.closest('button');
            if (!target || target.classList.contains('mobile-menu-trigger')) return;
            
            const userId = parseInt(target.dataset.id);
            const user = state.db.findUserById(userId);
            if (!user) return;

            if (target.classList.contains('edit-user')) {
                performAdminAction(() => {
                    openEditUserModal(userId);
                });
            } else if (target.classList.contains('deactivate-user')) {
                performAdminAction(() => {
                    showConfirmation("Deactivate User?", `Are you sure you want to deactivate ${user.name}? They will not be able to log in.`, () => {
                        state.db.updateUser(userId, { status: 'deactivated' });
                        updateTables();
                        showToast("User deactivated.", "success");
                    });
                });
            } else if (target.classList.contains('activate-user')) {
                performAdminAction(() => {
                    showConfirmation("Activate User?", `Are you sure you want to activate ${user.name}? They will be able to log in again.`, () => {
                        state.db.updateUser(userId, { status: 'active' });
                        updateTables();
                        showToast("User activated.", "success");
                    }, 'success'); 
                });
            }
        }

        function openEditUserModal(userId) {
            const user = state.db.findUserById(userId);
            if (!user) {
                showToast("Could not find user.", "error");
                return;
            }
            
            state.editingUserId = userId;
            
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserNameInput').value = user.name;
            document.getElementById('editUserRoleInput').value = user.role;
            
            editUserModal.style.display = 'flex';
        }
        
        function handleUpdateUser(e) {
            e.preventDefault();
            const userId = parseInt(document.getElementById('editUserId').value);
            const newName = document.getElementById('editUserNameInput').value;
            const newRole = document.getElementById('editUserRoleInput').value;
            
            state.db.updateUser(userId, { name: newName, role: newRole });
            
            editUserModal.style.display = 'none';
            updateTables(); 
            showToast("User updated successfully.", "success");
        }

       async function handleBulkUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = async function (event) {
        try {
            const exams = JSON.parse(event.target.result);

            if (!Array.isArray(exams)) {
                showToast("Invalid JSON format. Expected an array of exams.", "error");
                return;
            }

            let successCount = 0;

            for (const ex of exams) {
                // 1 Save into local mock DB (so UI sees them)
                const newLocalExam = state.db.createExam({
                    ...ex,
                    status: "approved",
                    teacher: state.currentUser ? state.currentUser.name : "Bulk Import",
                    teacherId: state.currentUser ? state.currentUser.id : null
                });

                // 2 Prepare Firestore exam object
                const firestoreExam = {
                    title: newLocalExam.title || "",
                    subject: newLocalExam.subject || "",
                    duration: newLocalExam.duration || 0,
                    teacher: newLocalExam.teacher || "",
                    questions: newLocalExam.questions || [],
                    createdAt: new Date()
                };

                // 3 Upload to Firestore
                await addDoc(collection(db, "exams"), firestoreExam);
                successCount++;
            }

            showToast(`Bulk upload successful! ${successCount} exams uploaded.`, "success");
            renderExamManagementTable();
            updateTables();
            updateStats();

        } catch (err) {
            console.error("Bulk upload error:", err);
            showToast("Error reading or uploading JSON file. Check console.", "error");
        }
    };

    reader.readAsText(file);
    // allow same file to be picked again later
    e.target.value = "";
}


        function exportExams() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.db.exams));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "exams_export.json");
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast("Exams exported successfully.", "success");
        }

        function handleAddResource(e) {
            e.preventDefault();
            const examId = parseInt(document.getElementById('resourceExamId').value);
            const type = document.getElementById('resourceType').value;
            let resource = { type: type };
            if(type === 'link') {
                resource.url = document.getElementById('resourceLink').value;
                if(!resource.url) { showToast("Please enter a valid URL.", "error"); return; }
                resource.label = "External Link";
            } else {
                const fileInput = document.getElementById('resourcePdf');
                if(fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    resource.url = URL.createObjectURL(file);
                    resource.label = "PDF Document";
                } else {
                    showToast("Please select a PDF file to upload.", "error"); return;
                }
            }
            state.db.addResourceToExam(examId, resource);
            addResourceModal.style.display = 'none';
            renderExamManagementTable();
            showToast("Resource added successfully.", "success");
        }

        function renderExamManagementTable() {
            manageExamsTableBody.innerHTML = '';
            
            const exams = state.db.exams;
            const isExpanded = manageExamListContainer.classList.contains('expanded');
            const examsToShow = isExpanded ? exams : exams.slice(0, 3);
            
            if (exams.length === 0) {
                manageExamsTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="6"><i class="fas fa-file-excel"></i>No exams found.</td></tr>`;
                showAllManageExamsBtn.style.display = 'none';
                return;
            }
            
            showAllManageExamsBtn.style.display = (exams.length > 3) ? 'flex' : 'none';

            examsToShow.forEach(exam => {
                let resourceButtons = '';
                if(exam.resources && exam.resources.length > 0) {
                    exam.resources.forEach(r => {
                        const icon = r.type === 'pdf' ? 'fa-file-pdf' : 'fa-link';
                        resourceButtons += `<button class="btn-icon btn-preview" data-url="${r.url}" data-type="${r.type}" title="View ${r.label}"><i class="fas ${icon}"></i></button>`;
                    });
                } else {
                    resourceButtons = `<span style="font-size: 0.8rem; color: var(--gray);">None</span>`;
                }

                const editButtons = `
                    <div class="action-wrapper">
                        <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                        <div class="action-buttons">
                            <button class="action-btn preview-exam-btn" data-id="${exam.id}" title="Preview"><i class="fas fa-eye"></i> Preview</button>
                            <button class="action-btn btn-resource" data-id="${exam.id}" title="Add Resource"><i class="fas fa-paperclip"></i> Resource</button>
                            <button class="action-btn edit-exam" data-id="${exam.id}" title="Edit"><i class="fas fa-edit"></i> Edit</button>
                            <button class="action-btn reject-exam delete-exam" data-id="${exam.id}" title="Delete"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                `;
                
                const sub = exam.subject || 'N/A';
                const subjectDisplay = `<span class="desktop-text">${sub}</span><span class="mobile-text">${sub.substring(0,4)}</span>`;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Title">${exam.title}</td>
                    <td data-label="Exam ID"><span style="background: #eee; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-weight: bold; user-select: all;">${exam.examCode}</span></td>
                    <td data-label="Subject">${subjectDisplay}</td>
                    <td data-label="Duration">${exam.duration === 0 ? 'Untimed' : exam.duration + ' mins'}</td>
                    <td data-label="Resources" class="resources-cell">${resourceButtons}</td>
                    <td data-label="Actions" class="admin-action-cell">${editButtons}</td>
                `;
                manageExamsTableBody.appendChild(row);
            });
        }
        
        function renderResultsTable() {
            resultsTableBody.innerHTML = '';
            const isAdmin = state.currentUser.role === 'admin';
            
            const results = state.db.results;
            if(results.length === 0) {
                resultsTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="6"><i class="fas fa-chart-bar"></i>No results found.</td></tr>`;
                return;
            }
            
            results.forEach(r => {
                  const row = document.createElement('tr');
                  const percentage = Math.round((r.score / r.total) * 100);
                  
                  const status = r.status || 'active';
                  let statusDisplay = '';
                  if (status === 'active') {
                      statusDisplay = `<span class="status status-approved">Active</span>`;
                  } else if (status === 'retaken') {
                      statusDisplay = `<span class="status status-retaken">Retaken</span>`;
                      row.classList.add('retaken');
                  }
                  
                  const adminBtns = isAdmin ? `
                      <div class="action-wrapper">
                          <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                          <div class="action-buttons">
                              <button class="action-btn reset-result" data-id="${r.id}" title="Reset Attempt"><i class="fas fa-redo"></i> Reset Attempt</button>
                              <button class="action-btn delete-result" data-id="${r.id}" title="Delete Result"><i class="fas fa-trash"></i> Delete Result</button>
                          </div>
                      </div>
                  ` : '';
                  
                  row.innerHTML = `
                      <td data-label="Student">${r.studentName}</td>
                      <td data-label="Exam">${r.examTitle}</td>
                      <td data-label="Score">${r.score} / ${r.total} (${percentage}%)</td>
                      <td data-label="Date">${r.date}</td>
                      <td data-label="Status">${statusDisplay}</td>
                      <td data-label="Actions" class="admin-action-cell">${adminBtns}</td>
                  `;
                  resultsTableBody.appendChild(row);
            });
        }
        
        function handleResultsTableClick(e) {
            const btn = e.target.closest('button');
            if(!btn || btn.classList.contains('mobile-menu-trigger')) return;
            
            const id = parseInt(btn.dataset.id);
            if(btn.classList.contains('reset-result')) {
                performAdminAction(() => {
                    const result = state.db.results.find(r=>r.id===id);
                    showConfirmation("Reset Attempt?", `This will mark ${result.studentName}'s attempt as 'Retaken' and allow them to take the exam again.`, () => {
                        state.db.updateResultStatus(id, 'retaken');
                        renderResultsTable();
                        showToast("Result marked for retake.", "success");
                    }, 'warning');
                });
            } else if (btn.classList.contains('delete-result')) {
                 performAdminAction(() => {
                    const result = state.db.results.find(r=>r.id===id);
                    showConfirmation("Delete Result?", `Are you sure you want to permanently delete this exam result for ${result.studentName}? This cannot be undone.`, () => {
                        state.db.deleteResult(id);
                        renderResultsTable();
                        updateStats();
                        showToast("Result deleted.", "success");
                    });
                });
            }
        }

        function switchAuthTab(tabName) {
            authTabs.forEach(tab => tab.classList.toggle('active', tab.getAttribute('data-tab') === tabName));
            if (tabName === 'login') { loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); } 
            else { loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); }
        }

        function handleLogin(e) {
            e.preventDefault();
            const button = document.getElementById('loginButton');
            setButtonLoading(button, true);
            
            setTimeout(() => {
                const user = state.db.findUserByEmail(document.getElementById('loginEmail').value);
                setButtonLoading(button, false);
                
                if (user && user.password === document.getElementById('loginPassword').value) {
                    if (user.status === 'deactivated') {
                        showToast('Your account is deactivated. Please contact an admin.', 'error');
                        return;
                    }
                    state.currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showApp(); 
                    updateUI();
                } else { 
                    showToast('Invalid email or password', 'error');
                }
            }, 500);
        }

        function handleRegister(e) {
            e.preventDefault();
            const button = document.getElementById('registerButton');
            setButtonLoading(button, true);

            setTimeout(() => {
                const email = document.getElementById('registerEmail').value;
                setButtonLoading(button, false);

                if (state.db.findUserByEmail(email)) { 
                    showToast('User with this email already exists', 'error');
                    return; 
                }
                state.db.createUser({
                    name: document.getElementById('registerName').value,
                    email: email,
                    password: document.getElementById('registerPassword').value,
                    role: document.getElementById('registerRole').value
                });
                showToast('Registration successful! Please log in.', 'success');
                registerForm.reset(); 
                switchAuthTab('login');
            }, 500);
        }

        function handleLogout() {
            state.currentUser = null; 
            localStorage.removeItem('currentUser');
            handleBackToDashboard(); 
            closeSidebar(); 
            showAuth();
        }

        function showAuth() { authScreen.classList.remove('hidden'); appScreen.classList.add('hidden'); }
        function showApp() { authScreen.classList.add('hidden'); appScreen.classList.remove('hidden'); }

        function updateUI() {
            if (state.currentUser) {
                document.getElementById('userName').textContent = state.currentUser.name;
                document.getElementById('userEmail').textContent = state.currentUser.email;
                document.getElementById('userAvatar').textContent = state.currentUser.name.charAt(0).toUpperCase();
                
                const roleBadge = document.getElementById('userRoleBadge');
                roleBadge.textContent = state.currentUser.role.toUpperCase();
                if (state.currentUser.role === 'parent') {
                    roleBadge.className = `role-badge role-parent`;
                } else {
                    roleBadge.className = `role-badge role-${state.currentUser.role}`;
                }
                
                const isAdmin = state.currentUser.role === 'admin';
                const isStudent = state.currentUser.role === 'student';
                const isParent = state.currentUser.role === 'parent'; 
                
                document.body.classList.toggle('is-admin', isAdmin);
                
                document.querySelector('.nav-link[data-page="users"]').style.display = (isStudent || isParent) ? 'none' : 'flex';
                document.querySelector('.nav-link[data-page="exams"]').style.display = (isStudent || isParent) ? 'none' : 'flex';
                document.querySelector('.nav-link[data-page="takeExam"]').style.display = (isStudent || isParent) ? 'flex' : 'none';
                
                updateStats(); 
                updateTables();
            }
        }

        function switchPage(page) {
            state.currentPage = page;
            pages.forEach(p => p.classList.add('hidden'));
            const pageElement = document.getElementById(`${page}Page`);
            if (pageElement) pageElement.classList.remove('hidden');
            else document.getElementById('dashboardPage').classList.remove('hidden');
        }

        function switchTab(tabId) {
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }

        function updateStats() {
            document.getElementById('totalUsers').textContent = state.db.users.length;
            document.getElementById('totalTeachers').textContent = state.db.users.filter(u => u.role === 'teacher').length;
            document.getElementById('totalStudents').textContent = state.db.users.filter(u => u.role === 'student').length;
            document.getElementById('totalParents').textContent = state.db.users.filter(u => u.role === 'parent').length;
            document.getElementById('totalExams').textContent = state.db.exams.length;
            document.getElementById('completedExams').textContent = state.db.results.filter(r => r.status === 'active').length;
        }

        function updateTables(forceRedraw = false) {
            if (state.currentPage === 'dashboard' || forceRedraw) {
                renderDashboardPendingTable();
                renderDashboardRecentTable();
                renderDashboardUserTable();
            }
            if (state.currentPage === 'users' || forceRedraw) {
                renderManageUserTable();
            }
        }
        
        function renderDashboardPendingTable() {
            pendingExamsTableBody.innerHTML = '';
            
            const pendingExams = state.db.exams.filter(exam => exam.status === 'pending');
            if (pendingExams.length === 0) {
                pendingExamsTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="5"><i class="fas fa-check-circle"></i>No pending exams.</td></tr>`;
            } else {
                pendingExams.forEach(exam => {
                    const editButtons = `
                        <div class="action-wrapper">
                            <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                            <div class="action-buttons">
                                <button class="action-btn edit-exam" data-id="${exam.id}"><i class="fas fa-edit"></i> Edit</button>
                                <button class="action-btn approve-exam" data-id="${exam.id}"><i class="fas fa-check"></i> Approve</button>
                                <button class="action-btn reject-exam" data-id="${exam.id}"><i class="fas fa-times"></i> Reject</button>
                            </div>
                        </div>
                    `;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `<td data-label="Title">${exam.title}</td><td data-label="Teacher">${exam.teacher}</td><td data-label="Questions">${exam.questions.length}</td><td data-label="Status"><span class="status status-pending">Pending</span></td><td data-label="Actions" class="admin-action-cell">${editButtons}</td>`;
                    pendingExamsTableBody.appendChild(row);
                });
            }
        }
        
        function renderDashboardRecentTable() {
             recentExamsTableBody.innerHTML = '';
             const subjectMapMobile = { 'math': 'Mat', 'physics': 'Phy', 'chemistry': 'Chem', 'biology': 'Bio' };

             const recentExams = state.db.exams.filter(exam => exam.status === 'approved');
             if (recentExams.length === 0) {
                 recentExamsTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="5"><i class="fas fa-file-alt"></i>No approved exams.</td></tr>`;
             } else {
                 recentExams.forEach(exam => {
                     const row = document.createElement('tr');
                     const participantCount = state.db.results.filter(r => r.examId === exam.id && r.status === 'active').length;
                     
                     const sub = exam.subject || 'N/A';
                     const shortSub = subjectMapMobile[sub.toLowerCase()] || sub.substring(0,3);
                     const subjectDisplay = `<span class="desktop-text">${sub}</span><span class="mobile-text">${shortSub}</span>`;
                     
                     row.innerHTML = `<td data-label="Title">${exam.title}</td><td data-label="Subject">${subjectDisplay}</td><td data-label="Questions">${exam.questions.length}</td><td data-label="Participants">${participantCount}</td><td style="min-width: 60px;" data-label="Actions" class="admin-action-cell"></td>`;
                     recentExamsTableBody.appendChild(row);
                 });
             }
        }

       function renderUserTable(tbody, userList, showAll) {
    tbody.innerHTML = '';
    const usersToShow = showAll ? userList : userList.slice(0, 3);

    const isDashboardTable = (tbody === usersTableBody);

    if (usersToShow.length === 0) {
        const colSpan = isDashboardTable ? 4 : 5;
        tbody.innerHTML = `<tr class="empty-state-row"><td colspan="${colSpan}"><i class="fas fa-user-slash"></i>No users found.</td></tr>`;
        return;
    }

    const formatDate = (dateString) => {
        const date = new Date(dateString);
        return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    };

    usersToShow.forEach(user => {
        const row = document.createElement('tr');
        const userStatus = user.status || 'active';
        const statusClass = userStatus === 'active' ? 'status-approved' : 'status-deactivated';
        const statusText = userStatus === 'active' ? 'Active' : 'Deactivated';

        if (isDashboardTable) {
            // Dashboard user list (no action buttons)
            row.innerHTML = `
                <td data-label="Name">${user.name}</td>
                <td data-label="Role">${user.role}</td>
                <td data-label="Joined">${formatDate(user.joinedDate)}</td>
                <td data-label="Status"><span class="status ${statusClass}">${statusText}</span></td>
            `;
        } else {
            // Manage Users table with actions
            let statusButton;
            if (userStatus === 'active') {
                statusButton = `<button class="action-btn deactivate-user" data-id="${user.id}" title="Deactivate User"><i class="fas fa-user-slash"></i> Deactivate</button>`;
            } else {
                statusButton = `<button class="action-btn activate-user" data-id="${user.id}" title="Activate User"><i class="fas fa-user-check"></i> Activate</button>`;
            }

            const adminButton = (state.currentUser.role === 'admin' && user.id !== state.currentUser.id) ? `
                <div class="action-wrapper">
                    <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                    <div class="action-buttons">
                        <button class="action-btn edit-user" data-id="${user.id}" title="Edit User"><i class="fas fa-edit"></i> Edit User</button>
                        ${statusButton}
                    </div>
                </div>
            ` : '';

            row.innerHTML = `
                <td data-label="Name" style="font-weight: 600;">${user.name} ${user.id === state.currentUser.id ? '(You)' : ''}</td>
                <td data-label="Email"><span style="font-size: 0.85rem;">${user.email}</span></td>
                <td data-label="Role"><span class="role-badge role-${user.role}">${user.role}</span></td>
                <td data-label="Status"><span class="status ${statusClass}">${statusText}</span></td>
                <td data-label="Actions" class="admin-action-cell">${adminButton}</td>
            `;
        }

        tbody.appendChild(row);
    });
}

        
        function renderDashboardUserTable() {
            const allUsers = state.db.users.sort((a, b) => new Date(b.joinedDate) - new Date(a.joinedDate)); 
            const isExpanded = document.getElementById('dashboardUserListContainer').classList.contains('expanded');
            renderUserTable(usersTableBody, allUsers, isExpanded);
            
            showAllUsersBtn.style.display = (allUsers.length > 3) ? 'flex' : 'none';
        }
        
        function renderManageUserTable() {
            let filteredUsers = state.db.users;
            let titleText = "User Management";
            
            if (state.userFilter === 'teacher') { filteredUsers = state.db.users.filter(u => u.role === 'teacher'); titleText += ": Teachers"; }
            else if (state.userFilter === 'student') { filteredUsers = state.db.users.filter(u => u.role === 'student'); titleText += ": Students"; }
            else if (state.userFilter === 'parent') { filteredUsers = state.db.users.filter(u => u.role === 'parent'); titleText += ": Parents"; } 
            else { titleText += ": All Users"; }
            
            usersPageTitle.textContent = titleText;
            
            const isExpanded = document.getElementById('manageUserListContainer').classList.contains('expanded');
            renderUserTable(manageUsersTableBody, filteredUsers, isExpanded);
            
            showAllManageUsersBtn.style.display = (filteredUsers.length > 3) ? 'flex' : 'none';
        }
// part -4 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        function handleCreateExam(e) {
            e.preventDefault();
            const newExam = state.db.createExam({
                title: document.getElementById('examTitleInput').value,
                subject: document.getElementById('examSubject').value,
                scheduledDate: document.getElementById('examDate').value,
                duration: parseInt(document.getElementById('examDurationInput').value),
                teacher: state.currentUser.name,
                teacherId: state.currentUser.id,
                status: state.currentUser.role === 'admin' ? 'approved' : 'pending',
            });
            addExamModal.style.display = 'none'; 
            examForm.reset();
            updateTables(); updateStats();
            showToast("Exam created! Add questions now.", "success");
            openExamEditor(newExam.id);
        }

        function handleJoinExam(e) {
            e.preventDefault();
            const button = document.getElementById('joinExamButton');
            setButtonLoading(button, true);
            
            setTimeout(() => {
                const examCode = joinExamCodeInput.value.trim();
                const exam = state.db.findExamByCode(examCode);
                setButtonLoading(button, false);

                if (!exam) {
                    showToast("Invalid Exam ID. Please try again.", "error");
                    return;
                }
                
                if (exam.status !== 'approved') {
                    showToast("This exam is not yet approved or is pending.", "error");
                    return;
                }
                
                if (exam.questions.length === 0) {
                    showToast("This exam has no questions.", "error");
                    return;
                }
                
                if (state.db.hasStudentTakenExam(state.currentUser.id, exam.id)) {
                    showToast("You have already completed this exam.", "error");
                    return;
                }
                
                joinExamModal.style.display = 'none';
                startExam(exam.id);
                
            }, 500);
        }

        function startExam(examId, isPreview = false) {
            const exam = state.db.findExamById(examId);
            if (!exam) return;
            
            state.currentExam = exam; 
            state.currentQuestionIndex = 0; 
            state.userAnswers = new Array(exam.questions.length).fill(null); 
            state.timeRemaining = exam.duration * 60;
            state.isPreviewMode = isPreview;
            
            document.getElementById('examTitle').textContent = exam.title + (isPreview ? " (Preview Mode)" : "");
            document.getElementById('examDuration').textContent = exam.duration === 0 ? "Unlimited" : exam.duration;
            document.getElementById('totalQuestions').textContent = exam.questions.length;
            
            document.getElementById('resultDisplay').classList.add('hidden');
            document.getElementById('questionContainer').classList.remove('hidden');
            document.getElementById('activeExamControls').classList.remove('hidden');
            document.getElementById('submitExam').innerText = isPreview ? "Finish Preview" : "Submit Exam";

            loadQuestion(state.currentQuestionIndex); 
            if(!isPreview && exam.duration > 0) startTimer();
            else document.getElementById('timeRemaining').textContent = isPreview ? "N/A (Preview)" : (exam.duration === 0 ? "Unlimited" : "N/A");
            
            switchPage('takeExam');
        }

       function loadQuestion(index) {
    if (!state.currentExam) return;
    const q = state.currentExam.questions[index];
    const qType = q.type || 'single';

    document.getElementById('questionText').textContent = q.question;
    document.getElementById('currentQuestion').textContent = index + 1;
    examOptionsContainer.innerHTML = '';

    switch (qType) {
        case 'single':
            q.options.forEach((optionText, i) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.dataset.index = i;
                div.innerHTML = `
                    <input type="radio" name="answer" value="${i}" id="option${i}">
                    <label for="option${i}">${optionText}</label>
                `;
                examOptionsContainer.appendChild(div);
                if (state.userAnswers[index] === i) {
                    div.querySelector('input').checked = true;
                    div.classList.add('selected');
                }
            });
            break;

        case 'multiple':
            q.options.forEach((optionText, i) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.dataset.index = i;
                div.innerHTML = `
                    <input type="checkbox" name="answer" value="${i}" id="option${i}">
                    <label for="option${i}">${optionText}</label>
                `;
                examOptionsContainer.appendChild(div);
                if (state.userAnswers[index] && state.userAnswers[index][i]) {
                    div.querySelector('input').checked = true;
                    div.classList.add('selected');
                }
            });
            break;

        case 'truefalse':
            ['true', 'false'].forEach((val, i) => {
                const labelText = val === 'true' ? 'True' : 'False';
                const div = document.createElement('div');
                div.className = 'option';
                const id = `optionTF${i}`;
                div.innerHTML = `
                    <input type="radio" name="answerTF" value="${val}" id="${id}">
                    <label for="${id}">${labelText}</label>
                `;
                examOptionsContainer.appendChild(div);
                if (state.userAnswers[index] === val) {
                    div.querySelector('input').checked = true;
                    div.classList.add('selected');
                }
            });
            break;

        case 'essay':
            examOptionsContainer.innerHTML = `
                <div class="form-group">
                    <label>Your Answer:</label>
                    <textarea class="form-control answer-textarea" id="essayAnswerInput"></textarea>
                </div>
            `;
            if (state.userAnswers[index]) {
                document.getElementById('essayAnswerInput').value = state.userAnswers[index];
            }
            break;

        default:
            // Fallback to essay style if type is unknown
            examOptionsContainer.innerHTML = `
                <div class="form-group">
                    <label>Your Answer:</label>
                    <textarea class="form-control answer-textarea" id="essayAnswerInput"></textarea>
                </div>
            `;
            if (state.userAnswers[index]) {
                document.getElementById('essayAnswerInput').value = state.userAnswers[index];
            }
            break;
    }

    prevQuestionBtn.disabled = index === 0;

    const isLast = index === state.currentExam.questions.length - 1;
    nextQuestionBtn.classList.toggle('hidden', isLast);
    submitExamBtn.classList.toggle('hidden', !isLast);
}

function saveAnswer() {
    if (state.isPreviewMode) return;

    const q = state.currentExam.questions[state.currentQuestionIndex];
    const qType = q.type || 'single';

    switch (qType) {
        case 'single': {
            const selectedSingle = document.querySelector('#examOptionsContainer input[type="radio"]:checked');
            if (selectedSingle) {
                state.userAnswers[state.currentQuestionIndex] = parseInt(selectedSingle.value);
            }
            break;
        }
        case 'multiple': {
            const selectedMultiple = document.querySelectorAll('#examOptionsContainer input[type="checkbox"]');
            const answers = Array.from(selectedMultiple).map(cb => cb.checked);
            state.userAnswers[state.currentQuestionIndex] = answers;
            break;
        }
        case 'truefalse': {
            const selectedTF = document.querySelector('#examOptionsContainer input[type="radio"]:checked');
            if (selectedTF) {
                state.userAnswers[state.currentQuestionIndex] = selectedTF.value; // "true" or "false"
            }
            break;
        }
        case 'essay': {
            const essayInput = document.getElementById('essayAnswerInput');
            if (essayInput) {
                state.userAnswers[state.currentQuestionIndex] = essayInput.value;
            }
            break;
        }
        default: {
            const essayInput = document.getElementById('essayAnswerInput');
            if (essayInput) {
                state.userAnswers[state.currentQuestionIndex] = essayInput.value;
            }
            break;
        }
    }
}


        function handleNextQuestion() { saveAnswer(); if (state.currentQuestionIndex < state.currentExam.questions.length - 1) { state.currentQuestionIndex++; loadQuestion(state.currentQuestionIndex); }}
        function handlePrevQuestion() { saveAnswer(); if (state.currentQuestionIndex > 0) { state.currentQuestionIndex--; loadQuestion(state.currentQuestionIndex); }}
        
        function startTimer() {
            if (state.examTimer) clearInterval(state.examTimer);
            const el = document.getElementById('timeRemaining');
            state.examTimer = setInterval(() => {
                state.timeRemaining--;
                const m = Math.floor(state.timeRemaining / 60), s = state.timeRemaining % 60;
                el.textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (state.timeRemaining <= 0) { 
                    clearInterval(state.examTimer); 
                    showToast("Time's up! Submitting exam.", "warning");
                    handleSubmitExam(); 
                }
            }, 1000);
        }
function handleSubmitExam() {
    saveAnswer();
    if (state.examTimer) clearInterval(state.examTimer);
    if (!state.currentExam) return;

    if (state.isPreviewMode) {
        handleBackToDashboard();
        showToast("Preview finished.", "info");
        return;
    }

    let score = 0;
    let totalAutoGraded = 0;

    state.userAnswers.forEach((userAnswer, i) => {
        const q = state.currentExam.questions[i];
        const qType = q.type || 'single';

        const normalize = (val) =>
            val === null || val === undefined ? null : String(val).toLowerCase();

        switch (qType) {
            case 'single': {
                totalAutoGraded++;
                const userAnswerNorm = normalize(userAnswer);
                const correctAnswerNorm = normalize(q.correctAnswer);
                if (userAnswerNorm === correctAnswerNorm) {
                    score++;
                }
                break;
            }
            case 'truefalse': {
                totalAutoGraded++;
                const userAnswerNorm = normalize(userAnswer);
                const correctAnswerNorm = normalize(q.correctAnswer);
                if (userAnswerNorm === correctAnswerNorm) {
                    score++;
                }
                break;
            }
            case 'multiple':
                // Still left simple/manual for now
                break;
            case 'essay':
                // Not auto-graded in this version
                break;
        }
    });

    state.db.saveResult({
        studentId: state.currentUser.id,
        studentName: state.currentUser.name,
        examId: state.currentExam.id,
        examTitle: state.currentExam.title,
        score: score,
        total: totalAutoGraded
    });

    document.getElementById('questionContainer').classList.add('hidden');
    document.getElementById('activeExamControls').classList.add('hidden');
    document.getElementById('resultDisplay').classList.remove('hidden');
    document.getElementById('finalScoreDisplay').textContent = `${score} / ${totalAutoGraded}`;
    showToast("Exam submitted successfully!", "success");
}

        
        function openExamEditor(examId) {
            const exam = state.db.findExamById(examId); if (!exam) return;
            state.editingExamId = examId; 
            
            // Reset form to default "Single Choice"
            document.getElementById('addQuestionForm').reset();
            document.getElementById('questionTypeInput').value = 'single';
            
            // Initialize dynamic options
            resetDynamicOptions('single');
            
            renderQuestionList(); 
            handleNavClick('examEditor');
        }
        
        function resetDynamicOptions(type) {
            const container = document.getElementById('add-options-container');
            const btnContainer = document.getElementById('addOptionBtnContainer');
            container.innerHTML = '';
            
            if (type === 'single' || type === 'multiple') {
                const optionType = (type === 'single') ? 'radio' : 'checkbox';
                const name = (type === 'single') ? 'correctAnswer' : 'correctAnswerMultiple';
                
                // Add default 2 options
                for(let i=0; i<2; i++) {
                    const div = document.createElement('div');
                    div.className = 'option-row';
                    div.innerHTML = `
                        <input type="${optionType}" name="${name}" value="${i}" class="option-selector" ${type === 'single' && i === 0 ? 'checked' : ''}>
                        <input type="text" class="form-control option-input" placeholder="Option ${i + 1}" required>
                        ${i > 1 ? '<button type="button" class="btn-remove-option"><i class="fas fa-times"></i></button>' : ''}
                    `;
                    container.appendChild(div);
                }
                btnContainer.classList.remove('hidden');
            } else if (type === 'truefalse') {
                container.innerHTML = `
                    <div class="option-row">
                        <input type="radio" name="correctAnswer" value="true" class="option-selector" checked>
                        <span style="font-weight:600; margin-left:5px;">True</span>
                    </div>
                    <div class="option-row">
                        <input type="radio" name="correctAnswer" value="false" class="option-selector">
                        <span style="font-weight:600; margin-left:5px;">False</span>
                    </div>
                `;
                btnContainer.classList.add('hidden');
            } else {
                // Essay or Fill - no options
                btnContainer.classList.add('hidden');
            }
        }
        
        // --- ADD OPTION LOGIC ---
        function addDynamicOption() {
            const container = document.getElementById('add-options-container');
            const type = document.getElementById('questionTypeInput').value;
            const index = container.children.length;
            
            const optionType = (type === 'single') ? 'radio' : 'checkbox';
            const name = (type === 'single') ? 'correctAnswer' : 'correctAnswerMultiple';

            const div = document.createElement('div');
            div.className = 'option-row';
            div.innerHTML = `
                <input type="${optionType}" name="${name}" value="${index}" class="option-selector">
                <input type="text" class="form-control option-input" placeholder="Option ${index + 1}" required>
                <button type="button" class="btn-remove-option"><i class="fas fa-times"></i></button>
            `;
            
            // Add remove functionality
            div.querySelector('.btn-remove-option').addEventListener('click', function() {
                div.remove();
                // Re-index radio/checkbox values if needed (simple approach for now)
            });
            
            container.appendChild(div);
        }
// Part 4 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxXxx
        function renderQuestionList() {
            const exam = state.db.findExamById(state.editingExamId); if (!exam) return;
            questionList.innerHTML = ''; 
            questionCount.textContent = exam.questions.length;
            
            if(exam.questions.length === 0) {
                questionList.classList.add('empty-list');
                return;
            }
            questionList.classList.remove('empty-list');

            exam.questions.forEach((q, index) => {
                const li = document.createElement('li'); li.className = 'question-list-item';
                const qType = q.type || 'single';
                let answerHtml = '';

                if (qType === 'single' || qType === 'multiple') {
                    answerHtml = `<div style="margin-top:5px; color:var(--gray);">Options: ${q.options.join(', ')}</div>`;
                } else if (qType === 'truefalse') {
                    answerHtml = `<div style="margin-top:5px; color:var(--gray);">Answer: ${q.correctAnswer}</div>`;
                }
                
                li.innerHTML = `
                    <div>
                        <h4 style="margin:0;">${index + 1}. [${qType}] ${q.question}</h4>
                        ${answerHtml}
                    </div>
                    <div>
                        <button class="btn-icon danger delete-question" data-index="${index}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                questionList.appendChild(li);
            });
        }

        function handleAddQuestion(e) {
            e.preventDefault();
            const form = e.target;
            const type = form.querySelector('#questionTypeInput').value;
            const questionText = form.querySelector('#questionTextInput').value;
            
            const q = {
                type: type,
                question: questionText,
            };

            if (type === 'single' || type === 'multiple') {
                // Collect options
                const inputs = form.querySelectorAll('.option-input');
                q.options = Array.from(inputs).map(i => i.value);
                
                // Determine correct answer
                if (type === 'single') {
                    const radios = form.querySelectorAll('.option-selector');
                    let correctIndex = 0;
                    radios.forEach((r, i) => { if(r.checked) correctIndex = i; });
                    q.correctAnswer = correctIndex;
                } else {
                    // Checkbox logic
                    // For simplicity in this demo, we aren't storing complex multi-answers in this specific block yet
                    // but the UI is correct. We'll just store options.
                }
            } else if (type === 'truefalse') {
                 const radios = form.querySelectorAll('.option-selector');
                 radios.forEach(r => { if(r.checked) q.correctAnswer = r.value; });
            } else {
                // Text question
                q.correctAnswer = null;
            }
            
            state.db.addQuestionToExam(state.editingExamId, q); 
            renderQuestionList(); 
            
            // Reset fields
            form.querySelector('#questionTextInput').value = '';
            resetDynamicOptions(type);
            
            showToast("Question added.", "success");
        }
        
        function handleDeleteQuestion(examId, qIndex) { 
             showConfirmation("Delete Question?", `Are you sure you want to delete question ${qIndex + 1}?`, () => {
                state.db.deleteQuestionFromExam(examId, qIndex); 
                renderQuestionList(); 
                showToast("Question deleted.", "success");
             });
        }
        
        // Class Management
        function renderClassManagementTable() {
            manageClassesTableBody.innerHTML = '';
            const classes = state.db.getClasses();
            const isExpanded = manageClassListContainer.classList.contains('expanded');
            const classesToShow = isExpanded ? classes : classes.slice(0, 3);

            if (classes.length === 0) {
                manageClassesTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="5"><i class="fas fa-chalkboard"></i>No classes created.</td></tr>`;
                showAllManageClassesBtn.style.display = 'none';
                return;
            }
            
            showAllManageClassesBtn.style.display = (classes.length > 3) ? 'flex' : 'none';
            
            classesToShow.forEach(cls => {
                const row = document.createElement('tr');
                const actionButtons = `
                    <div class="action-wrapper">
                        <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                        <div class="action-buttons">
                            <button class="action-btn manage-students" data-id="${cls.id}"><i class="fas fa-users"></i> Manage Students</button>
                            <button class="action-btn assign-exam" data-id="${cls.id}"><i class="fas fa-file-alt"></i> Assign Exam</button>
                            <button class="action-btn edit-class" data-id="${cls.id}"><i class="fas fa-edit"></i> Edit Class</button>
                            <button class="action-btn delete-class delete-result" data-id="${cls.id}"><i class="fas fa-trash"></i> Delete Class</button>
                        </div>
                    </div>
                `;
                row.innerHTML = `
                    <td data-label="Class Name">${cls.name}</td>
                    <td data-label="Teacher">${cls.teacher}</td>
                    <td data-label="Students">${cls.students.length}</td>
                    <td data-label="Exams">${cls.exams.length}</td>
                    <td data-label="Actions" class="admin-action-cell">${actionButtons}</td>
                `;
                manageClassesTableBody.appendChild(row);
            });
        }
        
        function handleClassManagementClick(e) {
            const btn = e.target.closest('button');
            if(!btn || btn.classList.contains('mobile-menu-trigger')) return;
            
            const classId = parseInt(btn.dataset.id);
            if (btn.classList.contains('edit-class')) {
                openCreateClassModal(classId);
            } else if (btn.classList.contains('delete-class')) {
                showConfirmation("Delete Class?", "Are you sure you want to delete this class? This cannot be undone.", () => {
                    state.db.deleteClass(classId);
                    renderClassManagementTable();
                    showToast("Class deleted.", "success");
                });
            } else if (btn.classList.contains('manage-students')) {
                openManageStudentsModal(classId);
            } else if (btn.classList.contains('assign-exam')) {
                openAssignExamModal(classId);
            }
        }
        
        function openCreateClassModal(classId = null) {
            performAdminAction(() => {
                const isEditing = classId !== null;
                state.editingClassId = isEditing ? classId : null;
                
                document.getElementById('classModalTitle').textContent = isEditing ? "Edit Class" : "Create New Class";
                
                if (isEditing) {
                    const cls = state.db.findClassById(classId);
                    document.getElementById('classNameInput').value = cls.name;
                    document.getElementById('classTeacherInput').value = cls.teacher;
                    document.getElementById('classModalId').value = cls.id;
                } else {
                    classForm.reset();
                    document.getElementById('classModalId').value = '';
                }
                
                classModal.style.display = 'flex';
            });
        }
        
        function handleSaveClass(e) {
            e.preventDefault();
            const classId = document.getElementById('classModalId').value;
            const classData = {
                name: document.getElementById('classNameInput').value,
                teacher: document.getElementById('classTeacherInput').value,
            };
            
            if (classId) {
                state.db.updateClass(parseInt(classId), classData);
                showToast("Class updated successfully.", "success");
            } else {
                state.db.createClass(classData);
                showToast("Class created successfully.", "success");
            }
            
            classModal.style.display = 'none';
            renderClassManagementTable();
        }
        
        function openManageStudentsModal(classId) {
            const cls = state.db.findClassById(classId);
            if (!cls) return;
            
            state.editingClassId = classId;
            document.getElementById('manageStudentsTitle').textContent = `Manage Students: ${cls.name}`;
            document.getElementById('manageStudentsClassId').value = classId;
            
            const rosterList = document.getElementById('currentStudentList');
            rosterList.innerHTML = '';
            if (cls.students.length === 0) {
                rosterList.innerHTML = '<li class="student-list-item empty">No students in this class.</li>';
            } else {
                cls.students.forEach(studentId => {
                    const student = state.db.findUserById(studentId);
                    if (student) {
                        const li = document.createElement('li');
                        li.className = 'student-list-item';
                        li.innerHTML = `
                            <span>${student.name}</span>
                            <button class="btn-icon danger remove-student-btn" data-id="${student.id}"><i class="fas fa-times"></i></button>
                        `;
                        li.querySelector('.remove-student-btn').addEventListener('click', () => {
                            state.db.removeStudentFromClass(classId, student.id);
                            openManageStudentsModal(classId); 
                        });
                        rosterList.appendChild(li);
                    }
                });
            }
            
            const addSelect = document.getElementById('addStudentSelect');
            addSelect.innerHTML = '<option value="">Select a Student...</option>';
            const allStudents = state.db.users.filter(u => u.role === 'student');
            allStudents.forEach(student => {
                if (!cls.students.includes(student.id)) {
                    addSelect.innerHTML += `<option value="${student.id}">${student.name}</option>`;
                }
            });
            
            manageStudentsModal.style.display = 'flex';
        }
        
        function handleAddStudentToClass() {
            const classId = state.editingClassId;
            const studentId = parseInt(document.getElementById('addStudentSelect').value);
            
            if (!classId || !studentId) {
                showToast("Please select a student.", "error");
                return;
            }
            
            state.db.addStudentToClass(classId, studentId);
            openManageStudentsModal(classId); 
        }
        
        function openAssignExamModal(classId) {
            const cls = state.db.findClassById(classId);
            if (!cls) return;
            
            state.editingClassId = classId;
            document.getElementById('assignExamTitle').textContent = `Assign Exam to: ${cls.name}`;
            document.getElementById('assignExamClassId').value = classId;
            
            const assignSelect = document.getElementById('assignExamSelect');
            assignSelect.innerHTML = '<option value="">Select an Approved Exam...</option>';
            const allExams = state.db.exams.filter(e => e.status === 'approved');
            allExams.forEach(exam => {
                if (!cls.exams.includes(exam.id)) {
                    assignSelect.innerHTML += `<option value="${exam.id}">${exam.title} (${exam.examCode})</option>`;
                }
            });
            
            assignExamModal.style.display = 'flex';
        }
        
        function handleAssignExamToClass() {
            const classId = state.editingClassId;
            const examId = parseInt(document.getElementById('assignExamSelect').value);
            
             if (!classId || !examId) {
                showToast("Please select an exam.", "error");
                return;
            }
            
            state.db.assignExamToClass(classId, examId);
            renderClassManagementTable(); 
            assignExamModal.style.display = 'none';
            showToast("Exam assigned to class.", "success");
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init(); 
         }
</script>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
    getFirestore,
    collection,
    addDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBtL_WitOLaxG2xfYjXnHBVGG3Gwh2uqGE",
    authDomain: "exam-app-e-awa.firebaseapp.com",
    projectId: "exam-app-e-awa",
    storageBucket: "exam-app-e-awa.firebasestorage.app",
    messagingSenderId: "238629933782",
    appId: "1:238629933782:web:5c768009dffec0644c2f77"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

//  FIX: Expose properly to the window
window.db = db;
window.addDoc = addDoc;
window.collection = collection;

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWA</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Global Font Size Reduction */
        html {
            font-size: 85%; /* MODIFIED: Increased font size */
        }

        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #f5f7fa;
            --gray: #95a5a6;
            --admin: #3498db;
            --teacher: #9b59b6;
            --student: #2ecc71;
            --parent: #e67e22; /* NEW: Parent color */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: lightgray;
            color: #333;
            min-height: 100vh;
        }
        
        /* NEW: Added admin-specific layout rules */
        body.is-admin .admin-only {
            display: flex;
        }
        body:not(.is-admin) .admin-only {
            display: none;
        }
        body:not(.is-admin) .admin-action-header,
        body:not(.is-admin) .admin-action-cell {
            display: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px; 
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            height: 80px; 
            width: 100%; /* Ensure full width */
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px; 
        }
        
        .mobile-nav-toggle {
            display: none; 
            font-size: 1.5rem;
            margin-right: 0; 
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon-wrapper {
            width: 45px;
            height: 45px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .logo h1 {
            color: var(--dark);
            font-weight: 700;
            font-size: 1.5rem;
            line-height: 1.2;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            height: 100%;
        }
        
        .user-details-text {
            /* This will help center the name vertically */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .user-email {
            display: none; /* Hide email as requested */
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .logout-btn {
            background: transparent;
            color: var(--gray);
            border: 1px solid #e0e0e0;
            padding: 8px 15px;
            border-radius: 6px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            font-weight: 600;
            height: 40px;
        }

        .logout-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* Auth Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            margin-top: 20px; /* MODIFIED: Pushed card down */
        }

        .auth-card {
            background: white;
            border-radius: 12px;
            padding: 15px; /* MODIFIED: Was 40px */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            position: relative; 
            overflow: hidden; 
        }
        
        /* NEW: Auth Header Layout */
        .auth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px 15px 15px; /* Padding for spacing */
            margin-bottom: 10px;
        }
        
        .auth-header-title {
            flex-grow: 1;
            text-align: center;
            color: var(--dark);
            font-weight: 700;
            font-size: 1.5rem;
            line-height: 1.2;
        }

        .awa-logo-auth {
            /* position: absolute;
            top: 10px;
            left: 10px; */
            font-weight: 900;
            color: var(--primary);
            font-size: 1.2rem;
            border: 2px solid var(--primary);
            padding: 5px 8px; /* Slightly more padding */
            border-radius: 4px;
            background: rgba(255,255,255,0.9);
            line-height: 1; /* Ensure tight box */
        }
        
        .auth-card .logo-icon-wrapper {
            /* position: absolute;
            top: 10px;
            right: 10px; */
            width: 45px; /* Ensure size */
            height: 45px;
            flex-shrink: 0; /* Prevent shrinking */
        }
        
        .awa-logo-header {
            font-weight: 900;
            color: var(--primary);
            font-size: 1.2rem;
            border: 2px solid var(--primary);
            padding: 2px 5px;
            border-radius: 4px;
            margin-right: 10px;
            display: none; 
        }
        
        /* MODIFIED: Auth Card styles to position icon top right */
        .auth-card .logo {
            /* justify-content: center;
            margin-bottom: 20px;
            margin-top: 20px; 
            visibility: hidden;  */
            display: none; /* Replaced by auth-header */
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }

        .auth-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            width: 100%;
            position: relative; /* For loading spinner */
            min-height: 44px; /* Ensure height consistency */
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }
        
        /* NEW: Loading spinner */
        .btn .btn-text {
            transition: opacity 0.2s ease;
        }
        .btn .spinner {
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            margin-left: -8px;
            margin-top: -8px;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .btn.loading .btn-text {
            opacity: 0;
        }
        .btn.loading .spinner {
            display: block;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-danger {
            background: var(--danger);
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-success {
            background: var(--secondary);
        }
        .btn-success:hover {
            background: #27ae60;
        }
        .btn-warning {
            background: var(--warning);
        }
        .btn-warning:hover {
            background: #d35400;
        }

        .btn i {
            font-size: 0.9rem;
        }

        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
        }

        /* Sidebar Styles */
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            height: 100%; 
            position: relative; 
        }
        
        .sidebar-close {
            display: none; 
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
        }

        .user-role {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .role-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        .role-admin { background: var(--admin); }
        .role-teacher { background: var(--teacher); }
        .role-student { background: var(--student); }
        .role-parent { background: var(--parent); } /* NEW: Parent badge */

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border-radius: 8px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--light);
            color: var(--primary);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            min-height: 60vh;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        /* NEW: Class header button group */
        .content-header-actions {
            display: flex;
            gap: 10px;
        }

        .content-header h2 {
            color: var(--dark);
            font-weight: 600;
        }

        .btn-sm {
            width: auto;
            padding: 10px 20px;
        }
        
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--gray);
            transition: color 0.2s ease;
        }
        .btn-icon:hover {
            color: var(--primary);
        }
        .btn-icon.danger:hover {
            color: var(--danger);
        }

        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* MODIFIED: Two per row */
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary);
        }
        
        .stat-card.clickable {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .stat-card.clickable:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .stat-card.teacher { border-left-color: var(--teacher); }
        .stat-card.student { border-left-color: var(--student); }
        .stat-card.parent { border-left-color: var(--parent); } /* NEW: Parent stat card */

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        
        /* NEW: Scrollable list for user tables */
        .table-container.scrollable-list {
            max-height: 250px;
            /* MODIFIED: Changed from auto to visible to fix dropdown clipping */
            overflow-y: visible;
            border: none;
        }
        /* MODIFIED: Added expanded state to stop clipping */
        .table-container.scrollable-list.expanded {
            max-height: none;
            /* MODIFIED: Set to visible */
            overflow-y: visible;
        }
        .table-container.scrollable-list table {
           border: none;
        }
        /* NEW: Added min-height to rows to fix dropdown clipping */
        .table-container.scrollable-list tr {
            min-height: 60px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: normal; 
            word-break: break-word;
            vertical-align: middle; 
        }
        
        tr td:first-child,
        tr th:first-child {
            padding-left: 20px;
        }
        tr td:last-child,
        tr th:last-child {
            padding-right: 20px;
        }

        th {
            background: var(--light);
            color: var(--dark);
            font-weight: 600;
            white-space: nowrap; /* Keep headers on one line */
        }
        
        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: #f9f9f9;
        }
        
        /* NEW: Empty state row */
        .empty-state-row {
            text-align: center;
            color: var(--gray);
            font-style: italic;
        }
        .empty-state-row td {
            padding: 40px;
        }
        .empty-state-row i {
            display: block;
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #ddd;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; } /* MODIFIED: Swapped with completed */
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-deactivated { background: #fff3cd; color: #856404; } /* NEW: Deactivated */
        /* NEW: Retaken status */
        .status-retaken { background: #f8d7da; color: #721c24; }
        tr.retaken { background-color: #fff8f8; }


        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary);
            margin-right: 10px;
            font-size: 1rem;
        }
        .action-btn:hover { color: #2980b9; }
        .action-btn.reject-exam { color: var(--danger); }
        .action-btn.reject-exam:hover { color: #c0392b; }
        .action-btn.edit-exam { color: var(--warning); }
        .action-btn.edit-exam:hover { color: #d35400; }
        
        /* NEW: Action button colors for user status */
        .action-btn.deactivate-user { color: var(--danger); }
        .action-btn.deactivate-user:hover { color: #c0392b; }
        .action-btn.activate-user { color: var(--secondary); }
        .action-btn.activate-user:hover { color: #27ae60; }
        /* NEW: Action button colors for results */
        .action-btn.reset-result { color: var(--warning); }
        .action-btn.reset-result:hover { color: #d35400; }
        .action-btn.delete-result { color: var(--danger); }
        .action-btn.delete-result:hover { color: #c0392b; }


        /* NEW: Align resources cell to the right */
        .resources-cell {
            text-align: right;
        }

        /* Exam Interface */
        .exam-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .exam-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .exam-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            /* NEW: Added for timer */
            align-items: center;
        }
        
        /* NEW: Fancy timer style */
        #timeRemaining {
            background: #e3f2fd;
            color: var(--primary);
            padding: 5px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .question-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.1rem;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option:hover {
            background: #f5f5f5;
        }

        .option.selected {
            border-color: var(--primary);
            background: #e3f2fd;
        }
        
        .option input[type="radio"],
        .option input[type="checkbox"] {
            /* MODIFIED: Allow checkbox/radio to be visible */
            display: inline-block;
            flex-shrink: 0;
            width: 1.15em;
            height: 1.15em;
            margin-right: 5px;
            cursor: pointer;
        }
        
        /* NEW: Style for answer text areas */
        .answer-textarea {
            width: 100%;
            min-height: 120px;
        }
        .answer-input {
            width: 100%;
        }

        .exam-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .result-card {
            text-align: center; 
            padding: 40px; 
            background: #f8f9fa; 
            border-radius: 12px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto; 
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px; 
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            /* NEW: Added for long student lists */
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-content.mini {
            max-width: 400px;
            text-align: center;
        }
        
        /* NEW: Added modal body for scrolling */
        .modal-body {
            overflow-y: auto;
            flex-grow: 1;
            padding-top: 10px; /* Space from header */
        }
        
        /* NEW: Student list styling in modal */
        .student-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .student-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        .student-list-item:last-child {
            border-bottom: none;
        }
        .student-list-item.empty {
            justify-content: center;
            color: var(--gray);
            font-style: italic;
            padding: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        /* NEW: Confirmation Modal styles */
        #confirmationModal .modal-icon {
            font-size: 3rem;
            color: var(--warning);
            margin-bottom: 15px;
        }
        #confirmationModal .modal-icon.danger {
            color: var(--danger);
        }
        #confirmationModal h3 {
            margin-bottom: 10px;
        }
        #confirmationModal p {
            margin-bottom: 20px;
            color: var(--dark);
        }
        #confirmationModal .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        #confirmationModal .modal-actions .btn {
            width: 100%;
        }


        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        /* Exam Editor Styles */
        .question-editor-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        .add-question-form {
            background: var(--light);
            padding: 25px;
            border-radius: 10px;
        }
        
        .add-question-form h3 {
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        /* MODIFIED: Option input styling */
        .option-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .option-input-group input[type="radio"],
        .option-input-group input[type="checkbox"] {
            flex-shrink: 0;
            width: 1.15em;
            height: 1.15em;
        }
        .option-input-group input[type="text"] {
            flex-grow: 1;
        }
        /* NEW: Remove option button */
        .option-input-group .btn-remove-option {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 5px;
        }
        .btn-add-option {
            width: auto;
            font-size: 0.9rem;
            padding: 8px 15px;
            background: var(--gray);
        }
        
        .question-list {
            list-style: none;
            padding: 0;
        }
        
        .question-list-item {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.03);
        }
        
        /* NEW: Empty state for question list */
        #questionList.empty-list {
            padding: 40px 20px;
            background: #f9f9f9;
            border-radius: 8px;
            text-align: center;
            color: var(--gray);
            border: 2px dashed #eee;
        }
        #questionList.empty-list::before {
            content: "\f055"; /* FontAwesome plus-circle */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 2rem;
            display: block;
            margin-bottom: 10px;
            color: #ccc;
        }
        #questionList.empty-list::after {
            content: "No questions added. Use the form to add your first question.";
            font-style: italic;
            display: block;
        }
        
        .question-list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .question-list-item-header h4 {
            color: var(--dark);
            font-weight: 600;
            max-width: 80%;
        }
        
        .question-list-item-options {
            list-style: none;
            padding-left: 20px;
        }
        
        .question-list-item-options li {
            margin-bottom: 5px;
            color: var(--gray);
        }
        
        .question-list-item-options li.correct {
            color: var(--secondary);
            font-weight: 600;
        }
        /* NEW: Display for different answer types in list */
        .question-list-item-answer {
            padding-left: 20px;
            font-style: italic;
            color: var(--secondary);
            font-weight: 600;
        }

        /* Overlay for mobile menu */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            transition: opacity 0.3s ease-in-out;
        }
        .overlay.open {
            display: block;
            opacity: 1;
        }

        /* NEW STYLES FOR BULK UPLOAD */
        .bulk-upload-container {
            /* REMOVED: All old styles */
        }
        .bulk-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 20px;
            /* NEW: Stack buttons */
            flex-direction: column;
            align-items: center;
            width: 220px;
            margin-left: auto;
            margin-right: auto;
            margin-top: -10px;
        }
        .bulk-actions .btn {
            width: 100%; /* Make buttons full width of container */
        }
        .iframe-preview {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        /* NEW: Toast Notification */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: white;
            color: var(--dark);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid var(--primary);
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success { border-left-color: var(--secondary); }
        .toast.error { border-left-color: var(--danger); }
        .toast.info i { color: var(--primary); }

        /* Responsive Utilities */
        .desktop-text { display: inline; }
        .mobile-text { display: none; }
        
        /* --- ACTION MENU (ALWAYS DROPDOWN) --- */
        .action-wrapper {
            display: flex; 
            align-items: center; 
            justify-content: flex-end; /* Align trigger to the right */
            width: 100%; 
            position: relative; 
            z-index: 5; /* MODIFIED: Lifted wrapper */
        }
        .action-label {
            display: none; /* No longer used */
        }
        .mobile-menu-trigger {
            background: none;
            border: none;
            font-size: 1.5rem; 
            color: var(--dark);
            padding: 0 5px; 
            cursor: pointer;
            display: block; /* Always visible */
            margin-left: auto; /* Push to far right */
        }
        .action-buttons {
            display: none; /* Dropdown is hidden by default */
            position: absolute;
            top: 100%; 
            right: 0;
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            flex-direction: column;
            padding: 5px;
            z-index: 10;
            min-width: 130px; /* More space for text */
            align-items: flex-start;
        }
        .action-buttons .action-btn {
            width: 100%;
            text-align: left;
            justify-content: flex-start;
            padding: 8px 10px;
            color: var(--dark);
            margin: 0; 
            gap: 10px; /* Space between icon and text */
        }
        .action-buttons .action-btn:hover {
            background: var(--light);
            color: var(--primary);
        }
        
        .action-buttons.show {
            display: flex; /* Class to show the dropdown */
        }
        
        /* NEW: Drop-up menu */
        .action-buttons.drop-up {
            bottom: 100%; /* Position above trigger */
            top: auto;
        }

        /* --- RESPONSIVE STYLES --- */
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                height: 100vh;
                z-index: 2000;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                width: 280px;
                overflow-y: auto;
                box-shadow: 0 0 20px rgba(0,0,0,0.2);
                border-radius: 0; 
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .sidebar-close {
                display: block;
            }
            .mobile-nav-toggle {
                display: block;
            }
            
            /* Show AWA Logo next to hamburger */
            .awa-logo-header {
                display: inline-block;
            }
        }
        
        @media (max-width: 640px) {
            .container { padding: 10px; }
            
            header { 
                padding: 10px 15px; 
                margin-bottom: 20px; 
                height: auto; 
                flex-wrap: nowrap; 
                overflow-x: hidden; 
                width: 100%; /* Ensure full width */
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .logo h1 { display: none; } 
            .user-info .user-details-text { display: none; } 
            .logout-btn span { display: none; }
            .logout-btn { padding: 8px; margin-left: auto; } 
            .main-content { padding: 15px; }
            .auth-card { padding: 20px; }
            .modal-content { padding: 20px; }
            
            .content-header { 
                margin-bottom: 20px; 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 10px;
            }
            .content-header h2 {
                font-size: 1.3rem; 
            }
            /* MODIFIED: Button group on mobile */
            .content-header .content-header-actions {
                flex-direction: column;
                width: 100%;
            }

            .stats-container { 
                grid-template-columns: repeat(2, 1fr); /* MODIFIED: Two per row on small mobile */
                gap: 15px; 
            } 
            
            /* Text Visibility */
            .desktop-text { display: none; }
            .mobile-text { display: inline; }

            /* CARD VIEW FOR TABLES ON MOBILE */
            table, thead, tbody, th, td, tr {
                display: block;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                margin-bottom: 15px;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                padding: 5px;
            }
            
            /* NEW: Empty state row on mobile */
            tr.empty-state-row {
                border: 1px dashed #ddd;
                box-shadow: none;
                background: #f9f9f9;
            }
            tr.empty-state-row td {
                justify-content: center;
                text-align: center;
                border: none;
                padding: 30px 15px !important;
            }
            tr.empty-state-row td:before {
                display: none;
            }

            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding: 10px 15px !important;
                text-align: right;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.9rem;
            }
            
            td:before {
                content: attr(data-label);
                font-weight: 600;
                text-align: left;
                color: var(--dark);
                margin-right: 15px;
            }

            /* Specific Styling for Last Row (Actions) on Mobile */
            tr td:last-child {
                border-bottom: none;
                /* MODIFIED: Align label to left, button to right */
                justify-content: space-between; 
                padding-left: 15px !important;
                padding-right: 15px !important; 
            }
            
            /* MODIFIED: Show 'Action' label */
            tr td:last-child:before {
                display: inline-block !important;
                white-space: nowrap; /* ADDED: Keep "Actions" on one line */
            }
            
            /* Mobile styles for action wrapper are now default */
            
            tr td:first-child, tr th:first-child { padding-left: 15px; }
            
            .add-question-form { padding: 20px; }
        }
        @media (max-width: 480px) {
            .exam-controls { flex-direction: column; gap: 10px; }
            .exam-controls .btn-sm { width: 100%; }
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="login-section" style="text-align: center; margin-top: 100px;">
    <h2>Please log in to access the Dashboard</h2>
    <button id="login-btn" style="padding: 15px 30px; background-color: #4285F4; color: white; border: none; font-size: 16px; cursor: pointer;">
        Sign in with Google
    </button>
</div>

<div id="quiz-container" style="display: none;">
    </div>
    <div class="overlay" id="overlay"></div>

    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            
            <!-- NEW: Auth Header -->
            <div class="auth-header">
                <div class="awa-logo-auth">AWA</div> 
                <h1 class="auth-header-title">WELCOME!</h1>
                <div class="logo-icon-wrapper"><i class="fas fa-graduation-cap"></i></div>
            </div>
            
            <div class="logo">
                <div class="logo-icon-wrapper"><i class="fas fa-graduation-cap"></i></div>
                <h1>AWA</h1>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">Login</div>
                <div class="auth-tab" data-tab="register">Register</div>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" value="admin@examsystem.com" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" value="admin123" required>
                </div>
                <button type="submit" class="btn" id="loginButton">
                    <span class="btn-text">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </span>
                    <div class="spinner"></div>
                </button>
            </form>
            <form id="registerForm" class="hidden">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" class="form-control" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="Enter your password" required>
                </div>
                <div class="form-group">
                    <label for="registerRole">Role</label>
                    <select id="registerRole" class="form-control" required>
                        <option value="">Select Role</option>
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                        <option value="admin">Admin</option>
                        <option value="parent">Parent</option> <!-- NEW: Added Parent option -->
                    </select>
                </div>
                <button type="submit" class="btn" id="registerButton">
                    <span class="btn-text">
                        <i class="fas fa-user-plus"></i> Register
                    </span>
                    <div class="spinner"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appScreen" class="hidden">
        <div class="container">
            <header>
                <div class="header-left">
                    <button class="btn-icon mobile-nav-toggle" id="mobileNavToggle"><i class="fas fa-bars"></i></button>
                    <div class="awa-logo-header">AWA</div>
                    <div class="logo">
                        <div class="logo-icon-wrapper"><i class="fas fa-graduation-cap"></i></div>
                        <h1>AWA</h1>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">AD</div>
                    <div class="user-details-text"> 
                        <div class="user-name" id="userName">Admin User</div>
                        <div class="user-email" id="userEmail">admin@examsystem.com</div>
                    </div>
                    <button class="logout-btn" id="logoutBtn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                    </button>
                </div>
            </header>

            <div class="dashboard">
                <div class="sidebar" id="sidebar">
                    <button class="btn-icon sidebar-close" id="sidebarClose"><i class="fas fa-times"></i></button>
                    <div class="user-role">
                        <div class="role-badge role-admin" id="userRoleBadge">Admin</div>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-item"><a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                        <li class="nav-item"><a href="#" class="nav-link" data-page="users"><i class="fas fa-users"></i> User Management</a></li>
                        <!-- NEW: Class Management Link -->
                        <li class="nav-item admin-only"><a href="#" class="nav-link" data-page="classes"><i class="fas fa-chalkboard-teacher"></i> Class Management</a></li>
                        <li class="nav-item"><a href="#" class="nav-link" data-page="exams"><i class="fas fa-file-alt"></i> Exam Management</a></li>
                        <li class="nav-item"><a href="#" class="nav-link" data-page="results"><i class="fas fa-chart-bar"></i> Results & Analytics</a></li>
                        <li class="nav-item"><a href="#" class="nav-link" data-page="takeExam"><i class="fas fa-pencil-alt"></i> Take Exam</a></li>
                    </ul>
                </div>

                <div class="main-content">
                    <!-- Dashboard Page -->
                    <div id="dashboardPage" class="page-content">
                        <div class="content-header">
                            <h2>Dashboard Overview</h2>
                            <!-- <button class="btn btn-sm admin-only" id="addExamBtn"><i class="fas fa-plus"></i> Add New Exam</button> -->
                        </div>

                        <div class="stats-container" id="statsContainer">
                            <div class="stat-card clickable" data-page="users" data-filter="all">
                                <div class="stat-value" id="totalUsers">0</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                            <div class="stat-card teacher clickable" data-page="users" data-filter="teacher">
                                <div class="stat-value" id="totalTeachers">0</div>
                                <div class="stat-label">Teachers</div>
                            </div>
                            <div class="stat-card student clickable" data-page="users" data-filter="student">
                                <div class="stat-value" id="totalStudents">0</div>
                                <div class="stat-label">Students</div>
                            </div>
                            <!-- NEW: Parent stat card -->
                            <div class="stat-card parent clickable" data-page="users" data-filter="parent">
                                <div class="stat-value" id="totalParents">0</div>
                                <div class="stat-label">Parents</div>
                            </div>
                            <div class="stat-card clickable" data-page="exams">
                                <div class="stat-value" id="totalExams">0</div>
                                <div class="stat-label">Exams Created</div>
                            </div>
                            <div class="stat-card clickable" data-page="results">
                                <div class="stat-value" id="completedExams">0</div>
                                <div class="stat-label">Exams Completed</div>
                            </div>
                        </div>

                        <div class="tabs">
                            <div class="tab active" data-tab="pending">Pending Approval</div>
                            <div class="tab" data-tab="recent">Recent Exams</div>
                            <div class="tab" data-tab="users">User Activity</div>
                        </div>

                        <div class="tab-content active" id="pending-tab">
                            <div class="table-container">
                                <table id="pendingExamsTable">
                                    <thead>
                                        <tr>
                                            <th>Exam Title</th>
                                            <th>Teacher</th>
                                            <th>Questions</th>
                                            <th>Status</th>
                                            <th class="admin-action-header">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-content" id="recent-tab">
                            <div class="table-container">
                                <table id="recentExamsTable">
                                    <thead>
                                        <tr>
                                            <th>Exam Title</th>
                                            <th>Subject</th>
                                            <th>Questions</th>
                                            <th>Participants</th>
                                            <th class="admin-action-header">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-content" id="users-tab">
                            <!-- MODIFIED: Added scrollable-list class -->
                            <div class="table-container scrollable-list" id="dashboardUserListContainer">
                                <table id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Role</th>
                                            <th>Joined</th>
                                            <th>Status</th>
                                            <!-- <th class="admin-action-header">Actions</th> -->
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <!-- NEW: Show all button -->
                            <button class="btn btn-sm" id="showAllUsersBtn" style="width: auto; margin-top: 10px; display: none;">
                                <i class="fas fa-chevron-down"></i> Show all...
                            </button>
                        </div>
                    </div>

                    <!-- Take Exam Page -->
                    <div id="takeExamPage" class="page-content hidden">
                        <div class="exam-container">
                            <div class="exam-header">
                                <button class="btn-icon" id="backToDashboardBtn" style="float: left;" title="Back to Dashboard"><i class="fas fa-arrow-left"></i></button>
                                <h2 id="examTitle">Mathematics Final Exam</h2>
                                <p>Duration: <span id="examDuration">60</span> minutes</p>
                            </div>
                            <div class="exam-info">
                                <div>Time Remaining: <span id="timeRemaining">60:00</span></div>
                                <div>Question: <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span></div>
                            </div>
                            <div class="question-card" id="questionContainer">
                                <div class="question-text" id="questionText">Question Text</div>
                                <div class="options" id="examOptionsContainer"></div>
                            </div>
                            <div id="resultDisplay" class="result-card hidden">
                                <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--secondary); margin-bottom: 20px;"></i>
                                <h3>Exam Submitted!</h3>
                                <p style="font-size: 1.5rem; margin: 20px 0;">Your Score: <span id="finalScoreDisplay" style="font-weight: bold;"></span></p>
                                <button class="btn" id="examDoneBtn" style="width: auto; margin: 0 auto;">Back to Dashboard</button>
                            </div>
                            
                            <div class="exam-controls" id="activeExamControls">
                                <button class="btn btn-sm" id="prevQuestion"><i class="fas fa-arrow-left"></i> Previous</button>
                                <button class="btn btn-sm" id="nextQuestion">Next <i class="fas fa-arrow-right"></i></button>
                                <button class="btn btn-sm hidden" id="submitExam" style="background: var(--secondary);">Submit Exam</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exam Editor Page -->
                    <div id="examEditorPage" class="page-content hidden">
                        <div class="content-header">
                            <h2 id="examEditorTitle">Edit Exam</h2>
                            <div class="content-header-actions">
                                <!-- MODIFIED: Moved Save button -->
                                <!-- <button class="btn btn-sm btn-success" id="saveAndExitExamBtn"><i class="fas fa-save"></i> Save and Exit</button> -->
                                <button class="btn btn-sm" id="editorBackToDashboardBtn"><i class="fas fa-arrow-left"></i> Back</button>
                            </div>
                        </div>
                        
                        <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                            <h3>Exam Details</h3>
                            <form id="editExamDetailsForm" style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <div class="form-group">
                                    <label>Title</label>
                                    <input type="text" id="editExamTitleInput" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Subject</label>
                                    <!-- MODIFIED: Changed to text input -->
                                    <input type="text" id="editExamSubjectInput" class="form-control" placeholder="e.g., Physics 101">
                                </div>
                                <div class="form-group">
                                    <label>Duration (mins) <small>(0 = Untimed)</small></label>
                                    <input type="number" id="editExamDurationInput" class="form-control">
                                </div>
                                <div class="form-group" style="display: flex; align-items: flex-end;">
                                    <button type="submit" class="btn btn-sm">Update Details</button>
                                </div>
                            </form>
                        </div>

                        <div class="question-editor-container">
                            <div class="add-question-form">
                                <h3>Add New Question</h3>
                                <form id="addQuestionForm">
                                    <!-- NEW: Question Type Dropdown -->
                                    <div class="form-group">
                                        <label for="questionTypeInput">Question Type</label>
                                        <select id="questionTypeInput" class="form-control">
                                            <option value="single">Single Choice (Radio)</option>
                                            <option value="multiple">Multiple Choice (Checkbox)</option>
                                            <option value="truefalse">True / False</option>
                                            <option value="fill">Fill-in-the-Blank</option>
                                            <option value="essay">Essay (Manual Grade)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="questionTextInput">Question Text</label>
                                        <textarea id="questionTextInput" class="form-control" required></textarea>
                                    </div>
                                    
                                    <!-- Options: Single Choice -->
                                    <div class="form-group" id="add-options-single">
                                        <label>Options (select the correct answer)</label>
                                        <div id="add-options-single-list">
                                            <div class="option-input-group">
                                                <input type="radio" name="correctAnswer" value="0" required>
                                                <input type="text" class="form-control" placeholder="Option 1" required>
                                            </div>
                                            <div class="option-input-group">
                                                <input type="radio" name="correctAnswer" value="1" required>
                                                <input type="text" class="form-control" placeholder="Option 2" required>
                                            </div>
                                        </div>
                                        <button type="button" class="btn-add-option" id="add-option-btn-single"><i class="fas fa-plus"></i> Add Option</button>
                                    </div>

                                    <!-- Options: Multiple Choice -->
                                    <div class="form-group hidden" id="add-options-multiple">
                                        <label>Options (select correct answers)</label>
                                        <div id="add-options-multiple-list">
                                            <div class="option-input-group">
                                                <input type="checkbox" name="correctAnswerMultiple" value="0">
                                                <input type="text" class="form-control" placeholder="Option 1">
                                            </div>
                                            <div class="option-input-group">
                                                <input type="checkbox" name="correctAnswerMultiple" value="1">
                                                <input type="text" class="form-control" placeholder="Option 2">
                                            </div>
                                        </div>
                                        <button type="button" class="btn-add-option" id="add-option-btn-multiple"><i class="fas fa-plus"></i> Add Option</button>
                                    </div>
                                    
                                    <!-- Answer: True/False -->
                                    <div class="form-group hidden" id="add-answer-truefalse">
                                        <label>Correct Answer</label>
                                        <select class="form-control" id="addAnswerTrueFalse">
                                            <option value="true">True</option>
                                            <option value="false">False</option>
                                        </select>
                                    </div>

                                    <!-- Answer: Fill-in-the-Blank -->
                                    <div class="form-group hidden" id="add-answer-fill">
                                        <label>Correct Answer (case-insensitive)</label>
                                        <input type="text" id="addAnswerFill" class="form-control" placeholder="Enter the exact answer">
                                    </div>
                                    
                                    <!-- Answer: Essay -->
                                    <div class="form-group hidden" id="add-answer-essay">
                                        <p style="color: var(--gray); font-style: italic;">Essay questions are not auto-graded and must be reviewed manually.</p>
                                    </div>

                                    <button type="submit" class="btn btn-sm" style="width: auto;">Add Question</button>
                                </form>
                            </div>
                            <div>
                                <h3>Existing Questions (<span id="questionCount">0</span>)</h3>
                                <ul id="questionList" class="question-list"></ul>
                                <!-- MODIFIED: Moved Save button here -->
                                <button class="btn btn-sm btn-success" id="saveAndExitExamBtn" style="width: auto; margin-top: 20px;">
                                    <i class="fas fa-save"></i> Save and Exit
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- User Management Page -->
                    <div id="usersPage" class="page-content hidden">
                         <div class="content-header">
                             <h2 id="usersPageTitle">User Management</h2>
                             <button class="btn btn-sm back-to-dashboard-btn"><i class="fas fa-arrow-left"></i> Back</button>
                         </div>
                         <!-- MODIFIED: Added scrollable-list class -->
                         <div class="table-container scrollable-list" id="manageUserListContainer">
                             <table id="manageUsersTable">
                                 <thead>
                                     <tr>
                                         <th>Name</th>
                                         <th>Email</th>
                                         <th>Role</th>
                                         <th>Status</th>
                                         <th class="admin-action-header">Actions</th>
                                     </tr>
                                 </thead>
                                 <tbody></tbody>
                             </table>
                         </div>
                         <!-- NEW: Show all button -->
                         <button class="btn btn-sm" id="showAllManageUsersBtn" style="width: auto; margin-top: 10px; display: none;">
                             <i class="fas fa-chevron-down"></i> Show all users...
                         </button>
                    </div>

                    <!-- Exam Management Page -->
                    <div id="examsPage" class="page-content hidden">
                         <div class="content-header">
                             <h2>Exam Management</h2>
                             <button class="btn btn-sm back-to-dashboard-btn"><i class="fas fa-arrow-left"></i> Back</button>
                         </div>
                         
                         <!-- MODIFIED: Centered, stacked, and equal-width buttons -->
                         <div class="bulk-actions" id="bulkUploadSection">
                            <!-- MODIFIED: Added btn class -->
                             <button class="btn btn-sm btn-success admin-only" id="downloadExamsBtn" title="Download All Exams">
                                 <i class="fas fa-download"></i> Export JSON
                             </button>
                             <!-- MODIFIED: Added btn class -->
                             <button class="btn btn-sm admin-only" id="bulkUploadBtn" title="Upload JSON File">
                                <i class="fas fa-upload"></i> Bulk Upload JSON
                             </button>
                             <input type="file" id="bulkJsonInput" accept=".json" style="display: none;">
                             <!-- MODIFIED: Added btn class -->
                             <button class="btn btn-sm admin-only" id="addExamBtn">
                                 <i class="fas fa-plus"></i> Add New Exam
                             </button>
                         </div>

                         <div class="table-container scrollable-list" id="manageExamListContainer">
                             <table id="manageExamsTable">
                                 <thead>
                                     <tr>
                                         <th>Exam Title</th>
                                         <th>Exam ID</th> <!-- ADDED: Header for ID -->
                                         <th>Subject</th>
                                         <th>Duration</th>
                                         <th class="resources-cell">Resources</th>
                                         <th class="admin-action-header">Actions</th>
                                     </tr>
                                 </thead>
                                 <tbody></tbody>
                             </table>
                         </div>
                         <!-- NEW: Show all exams button -->
                         <button class="btn btn-sm" id="showAllManageExamsBtn" style="width: auto; margin-top: 10px; display: none;">
                             <i class="fas fa-chevron-down"></i> Show all exams...
                         </button>
                    </div>

                    <!-- NEW: Class Management Page -->
                    <div id="classesPage" class="page-content hidden">
                         <div class="content-header">
                             <h2>Class Management</h2>
                             <!-- MODIFIED: Button layout -->
                             <div class="content-header-actions admin-only">
                                <button class="btn btn-sm" id="createClassBtn"><i class="fas fa-plus"></i> Create Class</button>
                                <button class="btn btn-sm back-to-dashboard-btn"><i class="fas fa-arrow-left"></i> Back</button>
                             </div>
                         </div>
                         
                         <div class="table-container scrollable-list" id="manageClassListContainer">
                             <table id="manageClassesTable">
                                 <thead>
                                     <tr>
                                         <th>Class Name</th>
                                         <th>Teacher</th>
                                         <th>Students</th>
                                         <th>Exams</th>
                                         <th class="admin-action-header">Actions</th>
                                     </tr>
                                 </thead>
                                 <tbody></tbody>
                             </table>
                         </div>
                         <!-- NEW: Show all classes button -->
                         <button class="btn btn-sm admin-only" id="showAllManageClassesBtn" style="width: auto; margin-top: 10px; display: none;">
                             <i class="fas fa-chevron-down"></i> Show all classes...
                         </button>
                    </div>

                    <div id="resultsPage" class="page-content hidden">
                         <div class="content-header">
                             <h2>Results & Analytics</h2>
                             <button class="btn btn-sm back-to-dashboard-btn"><i class="fas fa-arrow-left"></i> Back</button>
                         </div>
                         <div class="table-container">
                             <table id="resultsTable">
                                 <thead>
                                     <tr>
                                         <th>Student</th>
                                         <th>Exam</th>
                                         <th>Score</th>
                                         <th>Date</th>
                                         <th>Status</th>
                                         <th class="admin-action-header">Actions</th>
                                     </tr>
                                 </thead>
                                 <tbody></tbody>
                             </table>
                         </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NEW: Toast Notification Container -->
        <div id="toastContainer"></div>
    </div>

    <!-- Modals -->
    <div class="modal" id="addExamModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Exam</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="examForm">
                <div class="form-group">
                    <label for="examTitleInput">Exam Title</label>
                    <input type="text" id="examTitleInput" class="form-control" placeholder="Enter exam title" required>
                </div>
                <div class="form-group">
                    <label for="examSubject">Subject</label>
                    <!-- MODIFIED: Changed to text input -->
                    <input type="text" id="examSubject" class="form-control" placeholder="e.g., Biology 101" required>
                </div>
                <div class="form-group">
                    <label for="examDate">Exam Date</label>
                    <input type="date" id="examDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="examDurationInput">Duration (minutes) <small>(0 for untimed)</small></label>
                    <input type="number" id="examDurationInput" class="form-control" placeholder="60" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn" style="width: 100%;">Create & Add Questions</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="editQuestionModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Question</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="editQuestionForm">
                <!-- NEW: Question Type Dropdown -->
                <div class="form-group">
                    <label for="editQuestionTypeInput">Question Type</label>
                    <select id="editQuestionTypeInput" class="form-control">
                        <option value="single">Single Choice (Radio)</option>
                        <option value="multiple">Multiple Choice (Checkbox)</option>
                        <option value="truefalse">True / False</option>
                        <option value="fill">Fill-in-the-Blank</option>
                        <option value="essay">Essay (Manual Grade)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editQuestionTextInput">Question Text</label>
                    <textarea id="editQuestionTextInput" class="form-control" required></textarea>
                </div>

                <!-- Options: Single Choice -->
                <div class="form-group" id="edit-options-single">
                    <label>Options (select the correct answer)</label>
                    <div id="edit-options-single-list">
                        <!-- Options will be dynamically injected here -->
                    </div>
                    <button type="button" class="btn-add-option" id="edit-option-btn-single"><i class="fas fa-plus"></i> Add Option</button>
                </div>

                <!-- Options: Multiple Choice -->
                <div class="form-group hidden" id="edit-options-multiple">
                    <label>Options (select correct answers)</label>
                    <div id="edit-options-multiple-list">
                        <!-- Options will be dynamically injected here -->
                    </div>
                    <button type="button" class="btn-add-option" id="edit-option-btn-multiple"><i class="fas fa-plus"></i> Add Option</button>
                </div>
                
                <!-- Answer: True/False -->
                <div class="form-group hidden" id="edit-answer-truefalse">
                    <label>Correct Answer</label>
                    <select class="form-control" id="editAnswerTrueFalse">
                        <option value="true">True</option>
                        <option value="false">False</option>
                    </select>
                </div>

                <!-- Answer: Fill-in-the-Blank -->
                <div class="form-group hidden" id="edit-answer-fill">
                    <label>Correct Answer (case-insensitive)</label>
                    <input type="text" id="editAnswerFill" class="form-control" placeholder="Enter the exact answer">
                </div>
                
                <!-- Answer: Essay -->
                <div class="form-group hidden" id="edit-answer-essay">
                    <p style="color: var(--gray); font-style: italic;">Essay questions are not auto-graded and must be reviewed manually.</p>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- NEW: Edit User Modal -->
    <div class="modal" id="editUserModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit User</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label for="editUserNameInput">Full Name</label>
                    <input type="text" id="editUserNameInput" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editUserRoleInput">Role</label>
                    <select id="editUserRoleInput" class="form-control" required>
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                        <option value="admin">Admin</option>
                        <option value="parent">Parent</option> <!-- NEW: Added Parent option -->
                    </select>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <div class="modal" id="pdfPreviewModal" data-close="true">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Resource Preview</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <div id="pdfContainer">
                <!-- Iframe will be injected here -->
            </div>
        </div>
    </div>

    <div class="modal" id="addResourceModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Attach Resource</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="resourceForm">
                <input type="hidden" id="resourceExamId">
                <div class="form-group">
                    <label>Resource Type</label>
                    <select id="resourceType" class="form-control">
                        <option value="link">External Link (Reference)</option>
                        <option value="pdf">PDF File</option>
                    </select>
                </div>
                
                <div id="linkInputGroup" class="form-group">
                    <label for="resourceLink">URL</label>
                    <input type="url" id="resourceLink" class="form-control" placeholder="https://example.com">
                </div>

                <div id="pdfInputGroup" class="form-group hidden">
                    <label for="resourcePdf">Upload PDF</label>
                    <input type="file" id="resourcePdf" class="form-control" accept="application/pdf">
                    <p style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">Note: For simulation, PDF is viewable only during this session.</p>
                </div>

                <button type="submit" class="btn">Attach Resource</button>
            </form>
        </div>
    </div>

    <div class="modal" id="securityModal" data-close="true"> <!-- MODIFIED: Added data-close -->
        <div class="modal-content mini">
            <i class="fas fa-shield-alt" style="font-size: 3rem; color: var(--warning); margin-bottom: 15px;"></i>
            <h3 style="margin-bottom: 10px;">Admin Access Required</h3>
            <p style="margin-bottom: 20px;">Please enter the admin security code.</p>
            <input type="password" id="securityCodeInput" class="form-control" placeholder="Enter Code" style="text-align: center; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" id="cancelSecurityBtn" data-close="true">Cancel</button> <!-- MODIFIED: Added data-close -->
                <button class="btn" id="confirmSecurityBtn">Verify</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Join Exam Modal -->
    <div class="modal" id="joinExamModal" data-close="true">
        <div class="modal-content mini">
            <div class="modal-header">
                <h3>Join Exam</h3>
                <!-- NEW: Close button -->
                <button class="close-modal" data-close="true">&times;</button>
            </div>
             <form id="joinExamForm">
                 <div class="form-group">
                     <label for="joinExamCodeInput" style="text-align: left;">Exam ID</label>
                     <!-- MODIFIED: Updated placeholder and removed max length -->
                     <input type="text" id="joinExamCodeInput" class="form-control" placeholder="Enter Exam ID" required style="text-align: center; text-transform: uppercase;">
                 </div>
                 <button type="submit" class="btn" id="joinExamButton">
                     <span class="btn-text">
                         <i class="fas fa-pencil-alt"></i> Start Exam
                     </span>
                     <div class="spinner"></div>
                 </button>
             </form>
        </div>
    </div>
    
    <!-- NEW: Confirmation Modal -->
    <div class="modal" id="confirmationModal" data-close="true"> <!-- MODIFIED: Added data-close -->
        <div class="modal-content mini">
            <div id="confirmIcon" class="modal-icon danger"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 id="confirmTitle">Are you sure?</h3>
            <p id="confirmText">This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn btn-warning" id="confirmCancelBtn" data-close="true">Cancel</button> <!-- MODIFIED: Added data-close -->
                <button class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Class Modals -->
    <div class="modal" id="classModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="classModalTitle">Create New Class</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <form id="classForm">
                <input type="hidden" id="classModalId">
                <div class="form-group">
                    <label for="classNameInput">Class Name</label>
                    <input type="text" id="classNameInput" class="form-control" placeholder="e.g., Grade 10 Physics" required>
                </div>
                <div class="form-group">
                    <label for="classTeacherInput">Assign Teacher</label>
                    <!-- MODIFIED: Changed to text input -->
                    <input type="text" id="classTeacherInput" class="form-control" placeholder="Enter teacher's name" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Save Class</button>
            </form>
        </div>
    </div>
    
    <div class="modal" id="manageStudentsModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="manageStudentsTitle">Manage Students</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="manageStudentsClassId">
                <h4>Current Roster</h4>
                <ul class="student-list" id="currentStudentList">
                    <li class="student-list-item empty">No students in this class.</li>
                </ul>
                
                <h4 style="margin-top: 20px;">Add Student</h4>
                <div class="form-group">
                    <label for="addStudentSelect">Select Student to Add</label>
                    <select id="addStudentSelect" class="form-control">
                        <option value="">Select a Student...</option>
                        <!-- Student options will be dynamically injected -->
                    </select>
                </div>
                <button class="btn btn-sm" id="addStudentToClassBtn" style="width: auto;">Add Student</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="assignExamModal" data-close="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="assignExamTitle">Assign Exam</h3>
                <button class="close-modal" data-close="true">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="assignExamClassId">
                <div class="form-group">
                    <label for="assignExamSelect">Select Exam to Assign</label>
                    <select id="assignExamSelect" class="form-control">
                        <option value="">Select an Approved Exam...</option>
                        <!-- Exam options will be dynamically injected -->
                    </select>
                </div>
                <button class="btn" id="assignExamToClassBtn">Assign Exam to Class</button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        // Moved all element selectors inside init() to prevent race conditions
        let authScreen, appScreen, loginForm, registerForm, logoutBtn, authTabs, navLinks, pages, tabs, tabContents, addExamBtn, addExamModal, examForm, pendingExamsTableBody, recentExamsTableBody, usersTableBody, manageUsersTableBody, resultsTableBody, manageExamsTableBody, examOptionsContainer, prevQuestionBtn, nextQuestionBtn, submitExamBtn, backToDashboardBtn, examDoneBtn, examEditorPage, examEditorTitle, addQuestionForm, questionList, questionCount, editorBackToDashboardBtn, editExamDetailsForm, editQuestionModal, editQuestionForm, editUserModal, editUserForm, pdfPreviewModal, addResourceModal, securityModal, joinExamModal, joinExamForm, joinExamCodeInput, confirmationModal, bulkJsonInput, bulkUploadBtn, downloadExamsBtn, mobileNavToggle, sidebar, sidebarClose, overlay, usersPageTitle, showAllUsersBtn, showAllManageUsersBtn, statsContainer, showAllManageExamsBtn, saveAndExitExamBtn, manageExamListContainer, createClassBtn, classesPage, manageClassesTableBody, classModal, classForm, manageStudentsModal, assignExamModal, manageClassListContainer, showAllManageClassesBtn;

        // Mock Database
        class MockDatabase {
            constructor() {
                this.users = JSON.parse(localStorage.getItem('examUsers')) || [];
                this.exams = JSON.parse(localStorage.getItem('examExams')) || [];
                this.results = JSON.parse(localStorage.getItem('examResults')) || [];
                this.classes = JSON.parse(localStorage.getItem('examClasses')) || [];
                
                if (this.users.length === 0) {
                    this.initializeDemoData();
                }
                
                // Run retention policy check
                this.applyRetentionPolicy();
            }
            
            // NEW: Get date from 2 years ago
            getRetentionCutoff() {
                const cutoff = new Date();
                cutoff.setFullYear(cutoff.getFullYear() - 2);
                return cutoff;
            }

            // NEW: Apply retention policy
            applyRetentionPolicy() {
                const cutoffDate = this.getRetentionCutoff();
                const deletedUserIds = [];
                
                // Filter users
                const originalUserCount = this.users.length;
                this.users = this.users.filter(user => {
                    // Always keep admin
                    if (user.role === 'admin') return true;
                    
                    const joinedDate = new Date(user.joinedDate);
                    if (joinedDate < cutoffDate) {
                        deletedUserIds.push(user.id);
                        return false; // Remove user
                    }
                    return true; // Keep user
                });
                
                if (deletedUserIds.length > 0) {
                     console.log(`RETENTION POLICY: Removed ${deletedUserIds.length} users.`);
                    
                    // Filter results
                    this.results = this.results.filter(result => !deletedUserIds.includes(result.studentId));
                    
                    // Anonymize exams from deleted teachers
                    this.exams.forEach(exam => {
                        if (deletedUserIds.includes(exam.teacherId)) {
                            exam.teacher = "Archived User";
                            exam.teacherId = null;
                        }
                    });
                    
                    // Anonymize classes from deleted teachers
                    this.classes.forEach(cls => {
                         if (deletedUserIds.includes(cls.teacherId)) {
                            cls.teacher = "Archived User";
                            cls.teacherId = null;
                        }
                        // Remove deleted students from classes
                        cls.students = cls.students.filter(studentId => !deletedUserIds.includes(studentId));
                    });
                }
                
                // Save changes if any users were deleted
                if (this.users.length !== originalUserCount) {
                    this.saveToStorage();
                }
            }
            
            initializeDemoData() {
                const twoYearsAgo = new Date();
                twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
                
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                
                this.users = [
                    { id: 1, name: 'Admin User', email: 'admin@examsystem.com', password: 'admin123', role: 'admin', status: 'active', joinedDate: new Date() },
                    // This teacher is OLD and will be deleted
                    { id: 2, name: 'Teacher One (Old)', email: 'teacher@examsystem.com', password: 'teacher123', role: 'teacher', status: 'active', joinedDate: twoYearsAgo },
                    { id: 3, name: 'Student One', email: 'student@examsystem.com', password: 'student123', role: 'student', status: 'active', joinedDate: oneYearAgo },
                    { id: 4, name: 'Teacher Two (New)', email: 'teacher2@examsystem.com', password: 'teacher123', role: 'teacher', status: 'active', joinedDate: new Date() },
                    { id: 5, name: 'Student Two', email: 'student2@examsystem.com', password: 'student123', role: 'student', status: 'active', joinedDate: new Date() },
                    { id: 6, name: 'Parent One', email: 'parent@examsystem.com', password: 'parent123', role: 'parent', status: 'active', joinedDate: new Date() } // NEW: Added parent user
                ];
                
                this.exams = [
                    { 
                        id: 1, 
                        examCode: 'EX-A1B2',
                        title: 'Mathematics Midterm', 
                        subject: 'math', 
                        teacher: 'Teacher One (Old)', // This name will be anonymized
                        teacherId: 2, // ID of the old teacher
                        duration: 60, 
                        scheduledDate: '2023-11-15', 
                        status: 'pending', 
                        questions: [
                            { type: 'single', question: 'What is 2+2?', options:['3','4','5','6'], correctAnswer: 1 }
                        ],
                        resources: [] 
                    },
                    { 
                        id: 2, 
                        examCode: 'EX-C3D4',
                        title: 'Physics Final (Grade 8)', 
                        subject: 'physics', 
                        teacher: 'Teacher Two (New)',
                        teacherId: 4, // ID of the new teacher
                        duration: 45, 
                        scheduledDate: '2023-12-20', 
                        status: 'approved', 
                        questions: [
                            { type: 'single', question: "What is the unit of force?", options: ["Newton", "Joule", "Watt", "Pascal"], correctAnswer: 0 },
                            { type: 'single', question: "Which law states F=ma?", options: ["Newton's 1st Law", "Newton's 2nd Law", "Newton's 3rd Law", "Law of Gravity"], correctAnswer: 1 },
                            { type: 'single', question: "What is the speed of light?", options: ["3x10^8 m/s", "300 m/s", "100 km/h", "Sound speed"], correctAnswer: 0 },
                            { type: 'multiple', question: "Which of these are planets?", options: ["Earth", "Sun", "Mars", "Moon"], correctAnswer: [true, false, true, false] },
                            { type: 'truefalse', question: "Gravity on Earth is approx 9.8 m/s^2.", correctAnswer: 'true' },
                            { type: 'fill', question: "The chemical symbol for water is __.", correctAnswer: 'H2O' },
                            { type: 'essay', question: "Explain Newton's 3rd Law." }
                        ],
                        resources: []
                    }
                ];

                this.results = [
                    { id: 101, studentId: 3, studentName: "Student One", examId: 2, examTitle: "Physics Final (Grade 8)", score: 4, total: 6, date: new Date().toLocaleString(), status: 'active' } // 6 auto-graded questions
                ];
                
                this.classes = [
                    { id: 1, name: "Physics Grade 8", teacher: "Teacher Two (New)", teacherId: 4, students: [3, 5], exams: [2] }
                ];
                
                this.saveToStorage();
            }
            
            saveToStorage() {
                localStorage.setItem('examUsers', JSON.stringify(this.users));
                localStorage.setItem('examExams', JSON.stringify(this.exams));
                localStorage.setItem('examResults', JSON.stringify(this.results));
                localStorage.setItem('examClasses', JSON.stringify(this.classes));
            }
            
            findUserByEmail(email) { return this.users.find(user => user.email === email); }
            findUserById(id) { return this.users.find(user => user.id === id); } // NEW
            
            createUser(userData) {
                const newUser = { 
                    id: Date.now(), 
                    ...userData, 
                    status: 'active',
                    joinedDate: new Date() // NEW: Add joinedDate
                };
                this.users.push(newUser);
                this.saveToStorage();
                return newUser;
            }
            
            // NEW: Update User Method
            updateUser(userId, updates) {
                const user = this.findUserById(userId);
                if (user) {
                    Object.assign(user, updates);
                    this.saveToStorage();
                    return user;
                }
                return null;
            }
            
            getExams() { return this.exams; }
            findExamById(id) { return this.exams.find(e => e.id === id); }
            findExamByCode(code) { return this.exams.find(e => e.examCode && e.examCode.toUpperCase() === code.toUpperCase()); } // NEW
            
            // NEW: Generate 6-char Exam ID
            generateExamCode() {
                let code;
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ123456789';
                do {
                    code = 'EX-';
                    for(let i=0; i<4; i++) {
                        code += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                } while (this.findExamByCode(code));
                return code;
            }
            
          //  MODIFIED: Now saves to Firebase + Local Storage
            async createExam(examData) {
                const newExam = { 
                    id: Date.now(), 
                    examCode: this.generateExamCode(),
                    resources: [], 
                    ...examData, 
                    questions: examData.questions || [] 
                };
                
                // 1. Save Locally (Keep this so the app feels fast)
                this.exams.push(newExam);
                this.saveToStorage();

                // 2. Save to Firebase Cloud 
                    try {
                        // Use window.addDoc and window.collection to be 100% sure
                        await window.addDoc(window.collection(window.db, "questions"), newExam);
                        console.log(` SUCCESS: Saved ${newExam.title} to Cloud.`);
                    } catch (e) {
                        console.error(" FIREBASE ERROR:", e);
                    }
                return newExam;
            }

            updateExam(examId, updates) {
                 const exam = this.findExamById(examId);
                 if (exam) {
                      Object.assign(exam, updates);
                      this.saveToStorage();
                      return exam;
                 }
                 return null;
            }

            deleteExam(examId) { 
                this.exams = this.exams.filter(e => e.id !== examId);
                // Also delete associated results
                this.results = this.results.filter(r => r.examId !== examId);
                // Remove exam from classes
                this.classes.forEach(cls => {
                    cls.exams = cls.exams.filter(id => id !== examId);
                });
                this.saveToStorage();
            }

            updateExamStatus(examId, status) {
                const exam = this.findExamById(examId);
                if (exam) { exam.status = status; this.saveToStorage(); return exam; }
                return null;
            }

            addQuestionToExam(examId, questionData) {
                const exam = this.findExamById(examId);
                if (exam) { exam.questions.push(questionData); this.saveToStorage(); }
            }

            deleteQuestionFromExam(examId, questionIndex) {
                const exam = this.findExamById(examId);
                if (exam && exam.questions[questionIndex]) { exam.questions.splice(questionIndex, 1); this.saveToStorage(); }
            }

            updateQuestionInExam(examId, questionIndex, questionData) {
                const exam = this.findExamById(examId);
                if (exam && exam.questions[questionIndex]) { exam.questions[questionIndex] = questionData; this.saveToStorage(); }
            }

            addResourceToExam(examId, resource) {
                const exam = this.findExamById(examId);
                if(exam) {
                    if(!exam.resources) exam.resources = [];
                    exam.resources.push(resource);
                    this.saveToStorage();
                }
            }
            
            //  MODIFIED: Bulk Upload now sends to Firebase
           //  DEBUG VERSION: Prints everything to console
            async bulkImportExams(examsArray, importingUser) {
                console.log(" STARTING IMPORT...");
                console.log(" Data received:", examsArray); // <--- SPY ON THE DATA

                if (!examsArray || examsArray.length === 0) {
                    console.error(" ERROR: The array is empty! Check your JSON file format.");
                    alert("Error: No exams found in file.");
                    return;
                }

                // Make sure DB is connected
                if (!window.db) {
                     console.warn(" WARNING: window.db is not set. Trying to use global 'db'...");
                     if (typeof db !== 'undefined') window.db = db;
                }

                for (const ex of examsArray) {
                    console.log(`Processing exam: ${ex.title || "Untitled"}`); // <--- Log each item

                    const newExam = { 
                        ...ex, 
                        id: Date.now() + Math.floor(Math.random() * 1000), 
                        examCode: this.generateExamCode(), 
                        status: 'approved',
                        teacher: importingUser.name, 
                        teacherId: importingUser.id  
                    };
                    
                    // 1. Save Locally
                    this.exams.push(newExam);

                    // 2. Save to Firebase Cloud 
                    try {
                        // Check if addDoc exists
                        if (typeof addDoc === 'undefined') {
                            throw new Error("addDoc is missing! Check imports.");
                        }
                        
                        await addDoc(collection(window.db, "questions"), newExam);
                        console.log(` SUCCESS: Saved to Cloud.`);
                    } catch (e) {
                        console.error(" FIREBASE ERROR:", e); // <--- PRINT THE REAL ERROR
                    }
                }
                
                this.saveToStorage();
                alert(`Import Attempt Finished. Check Console for details.`);
            }
            saveResult(resultData) {
                const newResult = { id: Date.now(), ...resultData, date: new Date().toLocaleString(), status: 'active' };
                this.results.push(newResult);
                this.saveToStorage();
            }
            // MODIFIED: For retakes
            updateResultStatus(resultId, status) {
                const result = this.results.find(r => r.id === resultId);
                if (result) {
                    result.status = status;
                    this.saveToStorage();
                }
            }
            deleteResult(resultId) {
                this.results = this.results.filter(r => r.id !== resultId);
                this.saveToStorage();
            }
            // MODIFIED: Check for ACTIVE results
            hasStudentTakenExam(studentId, examId) {
                return this.results.some(r => r.studentId === studentId && r.examId === examId && r.status === 'active');
            }
            
            // --- NEW: Class Methods ---
            getClasses() { return this.classes; }
            findClassById(id) { return this.classes.find(c => c.id === id); }
            createClass(classData) {
                const newClass = { id: Date.now(), students: [], exams: [], ...classData };
                this.classes.push(newClass);
                this.saveToStorage();
                return newClass;
            }
            updateClass(classId, updates) {
                const cls = this.findClassById(classId);
                if(cls) {
                    Object.assign(cls, updates);
                    this.saveToStorage();
                    return cls;
                }
                return null;
            }
            deleteClass(classId) {
                this.classes = this.classes.filter(c => c.id !== classId);
                this.saveToStorage();
            }
            addStudentToClass(classId, studentId) {
                const cls = this.findClassById(classId);
                if (cls && !cls.students.includes(studentId)) {
                    cls.students.push(studentId);
                    this.saveToStorage();
                }
            }
            removeStudentFromClass(classId, studentId) {
                const cls = this.findClassById(classId);
                if (cls) {
                    cls.students = cls.students.filter(id => id !== studentId);
                    this.saveToStorage();
                }
            }
            assignExamToClass(classId, examId) {
                const cls = this.findClassById(classId);
                if (cls && !cls.exams.includes(examId)) {
                    cls.exams.push(examId);
                    this.saveToStorage();
                }
            }
        }

        // --- Application State ---
        const state = {
            currentUser: null,
            currentPage: 'dashboard',
            db: new MockDatabase(),
            currentExam: null,
            currentQuestionIndex: 0,
            userAnswers: [],
            examTimer: null,
            timeRemaining: 0,
            editingExamId: null,
            editingQuestionIndex: null,
            editingUserId: null, // NEW
            editingClassId: null, // NEW
            userFilter: 'all',
            isPreviewMode: false,
            pendingAction: null,
            pendingConfirmation: null, // NEW: For confirmation modal
        };

        // --- Initialization ---
        function init() {
            // --- Query Selectors ---
            authScreen = document.getElementById('authScreen');
            appScreen = document.getElementById('appScreen');
            loginForm = document.getElementById('loginForm');
            registerForm = document.getElementById('registerForm');
            logoutBtn = document.getElementById('logoutBtn');
            authTabs = document.querySelectorAll('.auth-tab');
            navLinks = document.querySelectorAll('.nav-link');
            pages = document.querySelectorAll('.page-content');
            tabs = document.querySelectorAll('.tab');
            tabContents = document.querySelectorAll('.tab-content');
            addExamBtn = document.getElementById('addExamBtn');
            addExamModal = document.getElementById('addExamModal');
            examForm = document.getElementById('examForm');
            
            pendingExamsTableBody = document.getElementById('pendingExamsTable').querySelector('tbody');
            recentExamsTableBody = document.getElementById('recentExamsTable').querySelector('tbody');
            usersTableBody = document.getElementById('usersTable').querySelector('tbody');
            manageUsersTableBody = document.getElementById('manageUsersTable').querySelector('tbody');
            resultsTableBody = document.getElementById('resultsTable').querySelector('tbody');
            manageExamsTableBody = document.getElementById('manageExamsTable').querySelector('tbody');

            examOptionsContainer = document.getElementById('examOptionsContainer');
            prevQuestionBtn = document.getElementById('prevQuestion');
            nextQuestionBtn = document.getElementById('nextQuestion');
            submitExamBtn = document.getElementById('submitExam');
            backToDashboardBtn = document.getElementById('backToDashboardBtn');
            examDoneBtn = document.getElementById('examDoneBtn'); // NEW

            examEditorPage = document.getElementById('examEditorPage');
            examEditorTitle = document.getElementById('examEditorTitle');
            addQuestionForm = document.getElementById('addQuestionForm');
            questionList = document.getElementById('questionList');
            questionCount = document.getElementById('questionCount');
            editorBackToDashboardBtn = document.getElementById('editorBackToDashboardBtn');
            editExamDetailsForm = document.getElementById('editExamDetailsForm');
            
            editQuestionModal = document.getElementById('editQuestionModal');
            editQuestionForm = document.getElementById('editQuestionForm');
            editUserModal = document.getElementById('editUserModal'); // NEW
            editUserForm = document.getElementById('editUserForm'); // NEW
            pdfPreviewModal = document.getElementById('pdfPreviewModal');
            addResourceModal = document.getElementById('addResourceModal');
            securityModal = document.getElementById('securityModal');
            
            // NEW: Exam ID Modal
            joinExamModal = document.getElementById('joinExamModal');
            joinExamForm = document.getElementById('joinExamForm');
            joinExamCodeInput = document.getElementById('joinExamCodeInput');
            
            // NEW: Confirmation Modal
            confirmationModal = document.getElementById('confirmationModal');
            
            bulkJsonInput = document.getElementById('bulkJsonInput');
            bulkUploadBtn = document.getElementById('bulkUploadBtn');
            downloadExamsBtn = document.getElementById('downloadExamsBtn');

            mobileNavToggle = document.getElementById('mobileNavToggle');
            sidebar = document.getElementById('sidebar');
            sidebarClose = document.getElementById('sidebarClose');
            overlay = document.getElementById('overlay');
            usersPageTitle = document.getElementById('usersPageTitle');
            statsContainer = document.getElementById('statsContainer');
            
            // NEW: User list "Show All" buttons
            showAllUsersBtn = document.getElementById('showAllUsersBtn');
            showAllManageUsersBtn = document.getElementById('showAllManageUsersBtn');
            showAllManageExamsBtn = document.getElementById('showAllManageExamsBtn');
            saveAndExitExamBtn = document.getElementById('saveAndExitExamBtn');
            manageExamListContainer = document.getElementById('manageExamListContainer');

            // NEW: Class Management Elements
            createClassBtn = document.getElementById('createClassBtn');
            classesPage = document.getElementById('classesPage');
            manageClassesTableBody = document.getElementById('manageClassesTable').querySelector('tbody');
            classModal = document.getElementById('classModal');
            classForm = document.getElementById('classForm');
            manageStudentsModal = document.getElementById('manageStudentsModal');
            assignExamModal = document.getElementById('assignExamModal');
            manageClassListContainer = document.getElementById('manageClassListContainer');
            showAllManageClassesBtn = document.getElementById('showAllManageClassesBtn');

            
            // --- Initial Load ---
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                state.currentUser = JSON.parse(savedUser);
                // Re-verify user, in case they were deleted by retention policy
                if (!state.db.findUserById(state.currentUser.id)) {
                    handleLogout(); // Force logout if user no longer exists
                    return;
                }
                showApp();
            } else {
                showAuth();
            }
            setupEventListeners();
            updateUI();
        }

        function setupEventListeners() {
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    switchAuthTab(tab.getAttribute('data-tab'));
                });
            });
            
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            logoutBtn.addEventListener('click', handleLogout);
            
            // NEW: Join Exam Form
            joinExamForm.addEventListener('submit', handleJoinExam);

            // NEW: Confirmation Modal Buttons
            document.getElementById('confirmCancelBtn').addEventListener('click', () => {
                confirmationModal.style.display = 'none';
                state.pendingConfirmation = null;
            });
            document.getElementById('confirmActionBtn').addEventListener('click', () => {
                if (state.pendingConfirmation) {
                    state.pendingConfirmation();
                }
                confirmationModal.style.display = 'none';
                state.pendingConfirmation = null;
            });
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (link.dataset.page === 'users') {
                        state.userFilter = 'all';
                        updateTables();
                    }
                    handleNavClick(link.dataset.page);
                    if (window.innerWidth <= 900) closeSidebar();
                });
            });
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.getAttribute('data-tab'));
                });
            });
            
            addExamBtn.addEventListener('click', () => {
                performAdminAction(() => {
                    addExamModal.style.display = 'flex';
                });
            });
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target.dataset.close === 'true') {
                        modal.style.display = 'none';
                        if(modal.id === 'securityModal') state.pendingAction = null;
                        if(modal.id === 'confirmationModal') state.pendingConfirmation = null;
                    }
                });
            });

            examForm.addEventListener('submit', handleCreateExam);
            
            pendingExamsTableBody.addEventListener('click', handleDashboardTableClick);
            recentExamsTableBody.addEventListener('click', handleDashboardTableClick);
            manageExamsTableBody.addEventListener('click', handleExamManagementClick);
            manageUsersTableBody.addEventListener('click', handleUserManagementClick); // NEW
            resultsTableBody.addEventListener('click', handleResultsTableClick);
            
            submitExamBtn.addEventListener('click', handleSubmitExam);
            nextQuestionBtn.addEventListener('click', handleNextQuestion);
            prevQuestionBtn.addEventListener('click', handlePrevQuestion);
            
            backToDashboardBtn.addEventListener('click', handleBackToDashboard); // For exam page
            examDoneBtn.addEventListener('click', handleBackToDashboard); // For result page
            saveAndExitExamBtn.addEventListener('click', handleBackToDashboard);
            
            document.querySelectorAll('.back-to-dashboard-btn').forEach(btn => {
                btn.addEventListener('click', handleBackToDashboard); // For management pages
            });
            editorBackToDashboardBtn.addEventListener('click', handleBackToDashboard);

            examOptionsContainer.addEventListener('click', (e) => {
                const clickedOption = e.target.closest('.option');
                if (!clickedOption) return;
                if (state.isPreviewMode) return;
                
                // NEW: Handle different input types
                const input = clickedOption.querySelector('input');
                if (input.type === 'radio') {
                    // Radio button logic (deselect others)
                    examOptionsContainer.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                    clickedOption.classList.add('selected');
                    input.checked = true;
                } else if (input.type === 'checkbox') {
                    // Checkbox logic (toggle self)
                    // MODIFIED: Fix for checkbox not checking
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                         input.checked = !input.checked;
                    }
                    clickedOption.classList.toggle('selected', input.checked);
                }
                
                saveAnswer();
            });
            
            addQuestionForm.addEventListener('submit', handleAddQuestion);
            // NEW: Add dynamic question fields
            document.getElementById('questionTypeInput').addEventListener('change', (e) => {
                toggleQuestionFields(e.target.value, 'add');
            });
            document.getElementById('editQuestionTypeInput').addEventListener('change', (e) => {
                toggleQuestionFields(e.target.value, 'edit');
            });
            
            // NEW: Add option buttons
            document.getElementById('add-option-btn-single').addEventListener('click', () => addDynamicOption('add', 'single'));
            document.getElementById('add-option-btn-multiple').addEventListener('click', () => addDynamicOption('add', 'multiple'));
            document.getElementById('edit-option-btn-single').addEventListener('click', () => addDynamicOption('edit', 'single'));
            document.getElementById('edit-option-btn-multiple').addEventListener('click', () => addDynamicOption('edit', 'multiple'));

            
            questionList.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-question');
                const deleteBtn = e.target.closest('.delete-question');
                if (editBtn) { openEditQuestionModal(state.editingExamId, parseInt(editBtn.dataset.index)); }
                if (deleteBtn) { handleDeleteQuestion(state.editingExamId, parseInt(deleteBtn.dataset.index)); }
            });
            
            editQuestionForm.addEventListener('submit', handleUpdateQuestion);
            editUserForm.addEventListener('submit', handleUpdateUser); // NEW
            editExamDetailsForm.addEventListener('submit', handleUpdateExamDetails);

            mobileNavToggle.addEventListener('click', openSidebar);
            sidebarClose.addEventListener('click', closeSidebar);
            overlay.addEventListener('click', closeSidebar);
            
            // MODIFIED: More robust click handler
            statsContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.stat-card.clickable');
                if (!card) return;
                
                // Safety check for user role
                if (!state.currentUser || (state.currentUser.role === 'student' && (card.dataset.page === 'users' || card.dataset.page === 'exams'))) {
                    return;
                }
                
                const page = card.dataset.page;
                const filter = card.dataset.filter;
                
                if (page === 'users') {
                    state.userFilter = filter || 'all';
                    updateTables(); 
                }
                handleNavClick(page);
            });

            bulkUploadBtn.addEventListener('click', () => {
                performAdminAction(() => {
                    bulkJsonInput.click();
                });
            });
            bulkJsonInput.addEventListener('change', handleBulkUpload);
            downloadExamsBtn.addEventListener('click', exportExams);

            const resourceType = document.getElementById('resourceType');
            resourceType.addEventListener('change', () => {
                if(resourceType.value === 'pdf') {
                    document.getElementById('pdfInputGroup').classList.remove('hidden');
                    document.getElementById('linkInputGroup').classList.add('hidden');
                } else {
                    document.getElementById('pdfInputGroup').classList.add('hidden');
                    document.getElementById('linkInputGroup').classList.remove('hidden');
                }
            });
            document.getElementById('resourceForm').addEventListener('submit', handleAddResource);
            
            document.getElementById('confirmSecurityBtn').addEventListener('click', verifySecurityCode);
            document.getElementById('cancelSecurityBtn').addEventListener('click', () => {
                securityModal.style.display = 'none';
                state.pendingAction = null;
            });

            // Mobile Action Menu Toggle Delegation
            document.body.addEventListener('click', (e) => {
                const trigger = e.target.closest('.mobile-menu-trigger');
                
                // Close all other dropdowns
                document.querySelectorAll('.action-buttons.show').forEach(el => {
                    if(!trigger || el !== trigger.closest('.action-wrapper').querySelector('.action-buttons')) {
                        el.classList.remove('show');
                        el.classList.remove('drop-up'); // NEW: Clean up drop-up class
                    }
                });

                // Toggle the clicked one
                if(trigger) {
                    const container = trigger.closest('.action-wrapper').querySelector('.action-buttons');
                    
                    // NEW: Check if it should drop up
                    const rect = trigger.getBoundingClientRect();
                    // Check if menu bottom would be off-screen. (Approx 150px for menu height)
                    const isNearBottom = (window.innerHeight - rect.bottom) < 160; 
                    if (isNearBottom) {
                        container.classList.add('drop-up');
                    } else {
                        container.classList.remove('drop-up');
                    }
                    
                    container.classList.toggle('show');
                }
            });
            
            // NEW: User list "Show All" button events
            showAllUsersBtn.addEventListener('click', () => {
                document.getElementById('dashboardUserListContainer').classList.toggle('expanded');
                showAllUsersBtn.classList.toggle('active');
                if (showAllUsersBtn.classList.contains('active')) {
                    showAllUsersBtn.innerHTML = `<i class="fas fa-chevron-up"></i> Show fewer`;
                } else {
                    showAllUsersBtn.innerHTML = `<i class="fas fa-chevron-down"></i> Show all...`;
                }
                updateTables(true); // Force redraw
            });
            
            showAllManageUsersBtn.addEventListener('click', () => {
                document.getElementById('manageUserListContainer').classList.toggle('expanded');
                showAllManageUsersBtn.classList.toggle('active');
                if (showAllManageUsersBtn.classList.contains('active')) {
                    showAllManageUsersBtn.innerHTML = `<i class="fas fa-chevron-up"></i> Show fewer`;
                } else {
                    showAllManageUsersBtn.innerHTML = `<i class="fas fa-chevron-down"></i> Show all users...`;
                }
                updateTables(true); // Force redraw
            });
            
            showAllManageExamsBtn.addEventListener('click', () => {
                manageExamListContainer.classList.toggle('expanded');
                showAllManageExamsBtn.classList.toggle('active');
                if (showAllManageExamsBtn.classList.contains('active')) {
                    showAllManageExamsBtn.innerHTML = `<i class="fas fa-chevron-up"></i> Show fewer`;
                } else {
                    showAllManageExamsBtn.innerHTML = `<i class="fas fa-chevron-down"></i> Show all exams...`;
                }
                renderExamManagementTable(); // Force redraw
            });
            
            // --- NEW: Class Management Listeners ---
            createClassBtn.addEventListener('click', () => openCreateClassModal());
            classForm.addEventListener('submit', handleSaveClass);
            manageClassesTableBody.addEventListener('click', handleClassManagementClick);
            
            document.getElementById('addStudentToClassBtn').addEventListener('click', handleAddStudentToClass);
            document.getElementById('assignExamToClassBtn').addEventListener('click', handleAssignExamToClass);
            
            showAllManageClassesBtn.addEventListener('click', () => {
                manageClassListContainer.classList.toggle('expanded');
                showAllManageClassesBtn.classList.toggle('active');
                if (showAllManageClassesBtn.classList.contains('active')) {
                    showAllManageClassesBtn.innerHTML = `<i class="fas fa-chevron-up"></i> Show fewer`;
                } else {
                    showAllManageClassesBtn.innerHTML = `<i class="fas fa-chevron-down"></i> Show all classes...`;
                }
                renderClassManagementTable(); // Force redraw
            });
        }
        
        // --- NEW: Toast Notifier ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            toast.innerHTML = `<i class="fas ${icon}" style="color: var(--${type === 'info' ? 'primary' : type});"></i> <span class="toast-message">${message}</span>`;
            
            container.appendChild(toast);
            
            // Trigger the slide-in animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Automatically remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        container.removeChild(toast);
                    }
                }, 300); // Wait for slide-out animation
            }, 3000);
        }
        
        // --- NEW: Confirmation Modal ---
        function showConfirmation(title, text, onConfirm, type = 'danger') {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmText').textContent = text;
            
            const iconDiv = document.getElementById('confirmIcon');
            const confirmBtn = document.getElementById('confirmActionBtn');
            
            iconDiv.className = `modal-icon ${type}`;
            confirmBtn.className = `btn btn-${type}`;
            
            if(type === 'danger') {
                iconDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i>`;
            } else if (type === 'warning') {
                iconDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i>`;
            } else {
                 iconDiv.innerHTML = `<i class="fas fa-question-circle"></i>`;
            }
            
            state.pendingConfirmation = onConfirm;
            confirmationModal.style.display = 'flex';
        }
        
        // --- NEW: Loading Button State ---
        function setButtonLoading(button, isLoading) {
            button.disabled = isLoading;
            button.classList.toggle('loading', isLoading);
        }

        function performAdminAction(callback) {
            if(state.currentUser.role !== 'admin') {
                showToast("This action requires admin privileges.", "error");
                return;
            }
            state.pendingAction = callback;
            document.getElementById('securityCodeInput').value = '';
            securityModal.style.display = 'flex';
        }

        function verifySecurityCode() {
            const code = document.getElementById('securityCodeInput').value;
            if (code === "ADMIN123") {
                securityModal.style.display = 'none';
                if(state.pendingAction) state.pendingAction();
                showToast("Admin action verified.", "success");
            } else {
                showToast("Access Denied: Invalid Code", "error");
            }
            state.pendingAction = null;
        }

        function openSidebar() { sidebar.classList.add('open'); overlay.classList.add('open'); }
        function closeSidebar() { sidebar.classList.remove('open'); overlay.classList.remove('open'); }
        
        function handleNavClick(page) {
            if (page === 'takeExam') {
                // NEW: Show modal instead of navigating
                joinExamCodeInput.value = '';
                joinExamModal.style.display = 'flex';
            } else {
                switchPage(page);
                if(page === 'exams') renderExamManagementTable();
                if(page === 'results') renderResultsTable();
                if(page === 'users') updateTables(); // NEW: Refresh users table on nav
                if(page === 'classes') renderClassManagementTable(); // NEW
            }
            navLinks.forEach(l => l.classList.toggle('active', l.dataset.page === page));
        }
        
        function handleBackToDashboard() {
            if (state.examTimer) clearInterval(state.examTimer);
            state.currentExam = null;
            state.editingExamId = null;
            state.isPreviewMode = false;
            // MODIFIED: Navigate to dashboard page correctly
            switchPage('dashboard');
            navLinks.forEach(l => l.classList.toggle('active', l.dataset.page === 'dashboard'));
            
            // MODIFIED: Added check for currentUser to prevent logout errors
            if (state.currentUser) {
                updateTables(); // Refresh dashboard tables
                updateStats(); // Refresh stats
            }
        }
        
        function handleDashboardTableClick(e) {
            const btn = e.target.closest('button');
            if(!btn || btn.classList.contains('mobile-menu-trigger')) return; // Ignore trigger
            
            const examId = parseInt(btn.dataset.id);
            
            if (btn.classList.contains('approve-exam')) {
                performAdminAction(() => { 
                    state.db.updateExamStatus(examId, 'approved'); 
                    updateTables(); 
                    updateStats(); 
                    showToast("Exam approved.", "success");
                });
            } else if (btn.classList.contains('reject-exam')) {
                performAdminAction(() => { 
                    state.db.updateExamStatus(examId, 'rejected'); 
                    updateTables(); 
                    updateStats(); 
                    showToast("Exam rejected.", "info");
                });
            } else if (btn.classList.contains('edit-exam')) {
                performAdminAction(() => { 
                    openExamEditor(examId); 
                });
            }
        }
        
        function handleExamManagementClick(e) {
            const target = e.target.closest('button');
            if(!target || target.classList.contains('mobile-menu-trigger')) return;
            
            const id = parseInt(target.dataset.id);

            if(target.classList.contains('btn-resource')) {
                performAdminAction(() => {
                    document.getElementById('resourceExamId').value = id;
                    document.getElementById('resourceForm').reset();
                    // Reset to default
                    document.getElementById('resourceType').value = 'link';
                    document.getElementById('pdfInputGroup').classList.add('hidden');
                    document.getElementById('linkInputGroup').classList.remove('hidden');
                    addResourceModal.style.display = 'flex';
                });
            } else if(target.classList.contains('btn-preview')) {
                const url = target.dataset.url;
                const type = target.dataset.type;
                if(type === 'pdf') {
                    document.getElementById('pdfContainer').innerHTML = `<iframe class="iframe-preview" src="${url}"></iframe>`;
                    pdfPreviewModal.style.display = 'flex';
                } else { window.open(url, '_blank'); }
            } else if (target.classList.contains('edit-exam')) {
                performAdminAction(() => { openExamEditor(id); });
            } else if (target.classList.contains('delete-exam')) {
                 performAdminAction(() => {
                    const exam = state.db.findExamById(id);
                    showConfirmation("Delete Exam?", `Are you sure you want to delete "${exam.title}"? This will also remove all results. This cannot be undone.`, () => {
                        state.db.deleteExam(id);
                        renderExamManagementTable();
                        updateTables(); // NEW: Refresh dashboard tables
                        updateStats();
                        showToast("Exam deleted successfully.", "success");
                    });
                });
            } else if (target.classList.contains('preview-exam-btn')) {
                startExam(id, true);
            }
        }
        
        // --- NEW: Handle User Management Click ---
        function handleUserManagementClick(e) {
            const target = e.target.closest('button');
            if (!target || target.classList.contains('mobile-menu-trigger')) return;
            
            const userId = parseInt(target.dataset.id);
            const user = state.db.findUserById(userId);
            if (!user) return;

            if (target.classList.contains('edit-user')) {
                performAdminAction(() => {
                    openEditUserModal(userId);
                });
            } else if (target.classList.contains('deactivate-user')) {
                performAdminAction(() => {
                    showConfirmation("Deactivate User?", `Are you sure you want to deactivate ${user.name}? They will not be able to log in.`, () => {
                        state.db.updateUser(userId, { status: 'deactivated' });
                        updateTables();
                        showToast("User deactivated.", "success");
                    });
                });
            } else if (target.classList.contains('activate-user')) {
                performAdminAction(() => {
                    showConfirmation("Activate User?", `Are you sure you want to activate ${user.name}? They will be able to log in again.`, () => {
                        state.db.updateUser(userId, { status: 'active' });
                        updateTables();
                        showToast("User activated.", "success");
                    }, 'success'); // 'success' type for green button
                });
            }
        }

        // --- NEW: Open Edit User Modal ---
        function openEditUserModal(userId) {
            const user = state.db.findUserById(userId);
            if (!user) {
                showToast("Could not find user.", "error");
                return;
            }
            
            state.editingUserId = userId;
            
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserNameInput').value = user.name;
            document.getElementById('editUserRoleInput').value = user.role;
            
            editUserModal.style.display = 'flex';
        }
        
        // --- NEW: Handle User Update ---
        function handleUpdateUser(e) {
            e.preventDefault();
            const userId = parseInt(document.getElementById('editUserId').value);
            const newName = document.getElementById('editUserNameInput').value;
            const newRole = document.getElementById('editUserRoleInput').value;
            
            state.db.updateUser(userId, { name: newName, role: newRole });
            
            editUserModal.style.display = 'none';
            updateTables(); // Refresh the user list
            showToast("User updated successfully.", "success");
        }

        function handleBulkUpload(e) {
            // This function is now called *after* performAdminAction
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const exams = JSON.parse(event.target.result);
                    if(Array.isArray(exams)) {
                        // MODIFIED: Pass current user
                        state.db.bulkImportExams(exams, state.currentUser);
                        showToast(`Bulk upload successful! ${exams.length} exams added.`, "success");
                        renderExamManagementTable();
                        updateTables(); // FIXED: Refresh dashboard tables too
                        updateStats();
                    } else { showToast("Invalid JSON format. Expected an array.", "error"); }
                } catch(err) { 
                    showToast("Error parsing JSON file.", "error"); 
                    console.error("JSON Parse Error:", err); // Added for debugging
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function exportExams() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.db.exams));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "exams_export.json");
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast("Exams exported successfully.", "success");
        }

        function handleAddResource(e) {
            e.preventDefault();
            const examId = parseInt(document.getElementById('resourceExamId').value);
            const type = document.getElementById('resourceType').value;
            let resource = { type: type };
            if(type === 'link') {
                resource.url = document.getElementById('resourceLink').value;
                if(!resource.url) { showToast("Please enter a valid URL.", "error"); return; }
                resource.label = "External Link";
            } else {
                const fileInput = document.getElementById('resourcePdf');
                if(fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    resource.url = URL.createObjectURL(file);
                    resource.label = "PDF Document";
                } else {
                    showToast("Please select a PDF file to upload.", "error"); return;
                }
            }
            state.db.addResourceToExam(examId, resource);
            addResourceModal.style.display = 'none';
            renderExamManagementTable();
            showToast("Resource added successfully.", "success");
        }

        function renderExamManagementTable() {
            manageExamsTableBody.innerHTML = '';
            const isAdmin = state.currentUser.role === 'admin';
            // document.getElementById('bulkUploadSection').classList.toggle('hidden', !isAdmin);
            
            const exams = state.db.exams;
            const isExpanded = manageExamListContainer.classList.contains('expanded');
            const examsToShow = isExpanded ? exams : exams.slice(0, 3);
            
            if (exams.length === 0) {
                manageExamsTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="6"><i class="fas fa-file-excel"></i>No exams found.</td></tr>`;
                showAllManageExamsBtn.style.display = 'none';
                return;
            }
            
            showAllManageExamsBtn.style.display = (exams.length > 3) ? 'flex' : 'none';

            examsToShow.forEach(exam => {
                let resourceButtons = '';
                if(exam.resources && exam.resources.length > 0) {
                    exam.resources.forEach(r => {
                        const icon = r.type === 'pdf' ? 'fa-file-pdf' : 'fa-link';
                        resourceButtons += `<button class="btn-icon btn-preview" data-url="${r.url}" data-type="${r.type}" title="View ${r.label}"><i class="fas ${icon}"></i></button>`;
                    });
                } else {
                    resourceButtons = `<span style="font-size: 0.8rem; color: var(--gray);">None</span>`;
                }

                const editButtons = `
                    <div class="action-wrapper">
                        <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                        <div class="action-buttons">
                            <button class="action-btn preview-exam-btn" data-id="${exam.id}" title="Preview"><i class="fas fa-eye"></i> Preview</button>
                            <button class="action-btn btn-resource" data-id="${exam.id}" title="Add Resource"><i class="fas fa-paperclip"></i> Resource</button>
                            <button class="action-btn edit-exam" data-id="${exam.id}" title="Edit"><i class="fas fa-edit"></i> Edit</button>
                            <button class="action-btn reject-exam delete-exam" data-id="${exam.id}" title="Delete"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                `;
                
                const sub = exam.subject || 'N/A';
                const subjectDisplay = `<span class="desktop-text">${sub}</span><span class="mobile-text">${sub.substring(0,4)}</span>`;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Title">${exam.title}</td>
                    <td data-label="Exam ID"><span style="background: #eee; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-weight: bold; user-select: all;">${exam.examCode}</span></td>
                    <td data-label="Subject">${subjectDisplay}</td>
                    <td data-label="Duration">${exam.duration === 0 ? 'Untimed' : exam.duration + ' mins'}</td>
                    <td data-label="Resources" class="resources-cell">${resourceButtons}</td>
                    <td data-label="Actions" class="admin-action-cell">${editButtons}</td>
                `;
                manageExamsTableBody.appendChild(row);
            });
        }
        
        function renderResultsTable() {
            resultsTableBody.innerHTML = '';
            const isAdmin = state.currentUser.role === 'admin';
            
            const results = state.db.results;
            if(results.length === 0) {
                resultsTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="6"><i class="fas fa-chart-bar"></i>No results found.</td></tr>`;
                return;
            }
            
            results.forEach(r => {
                  const row = document.createElement('tr');
                  const percentage = Math.round((r.score / r.total) * 100);
                  
                  // NEW: Handle status
                  const status = r.status || 'active';
                  let statusDisplay = '';
                  if (status === 'active') {
                      statusDisplay = `<span class="status status-approved">Active</span>`;
                  } else if (status === 'retaken') {
                      statusDisplay = `<span class="status status-retaken">Retaken</span>`;
                      row.classList.add('retaken');
                  }
                  
                  // NEW: Modified admin buttons
                  const adminBtns = isAdmin ? `
                      <div class="action-wrapper">
                          <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                          <div class="action-buttons">
                              <button class="action-btn reset-result" data-id="${r.id}" title="Reset Attempt"><i class="fas fa-redo"></i> Reset Attempt</button>
                              <button class="action-btn delete-result" data-id="${r.id}" title="Delete Result"><i class="fas fa-trash"></i> Delete Result</button>
                          </div>
                      </div>
                  ` : '';
                  
                  row.innerHTML = `
                      <td data-label="Student">${r.studentName}</td>
                      <td data-label="Exam">${r.examTitle}</td>
                      <td data-label="Score">${r.score} / ${r.total} (${percentage}%)</td>
                      <td data-label="Date">${r.date}</td>
                      <td data-label="Status">${statusDisplay}</td>
                      <td data-label="Actions" class="admin-action-cell">${adminBtns}</td>
                  `;
                  resultsTableBody.appendChild(row);
            });
        }
        
        function handleResultsTableClick(e) {
            const btn = e.target.closest('button');
            if(!btn || btn.classList.contains('mobile-menu-trigger')) return;
            
            const id = parseInt(btn.dataset.id);
            if(btn.classList.contains('reset-result')) {
                performAdminAction(() => {
                    const result = state.db.results.find(r=>r.id===id);
                    showConfirmation("Reset Attempt?", `This will mark ${result.studentName}'s attempt as 'Retaken' and allow them to take the exam again.`, () => {
                        state.db.updateResultStatus(id, 'retaken');
                        renderResultsTable();
                        showToast("Result marked for retake.", "success");
                    }, 'warning');
                });
            } else if (btn.classList.contains('delete-result')) {
                 performAdminAction(() => {
                    const result = state.db.results.find(r=>r.id===id);
                    showConfirmation("Delete Result?", `Are you sure you want to permanently delete this exam result for ${result.studentName}? This cannot be undone.`, () => {
                        state.db.deleteResult(id);
                        renderResultsTable();
                        updateStats();
                        showToast("Result deleted.", "success");
                    });
                });
            }
        }

        // --- Auth functions ---
        function switchAuthTab(tabName) {
            authTabs.forEach(tab => tab.classList.toggle('active', tab.getAttribute('data-tab') === tabName));
            if (tabName === 'login') { loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); } 
            else { loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); }
        }

        function handleLogin(e) {
            e.preventDefault();
            const button = document.getElementById('loginButton');
            setButtonLoading(button, true);
            
            // Simulate API delay
            setTimeout(() => {
                const user = state.db.findUserByEmail(document.getElementById('loginEmail').value);
                setButtonLoading(button, false);
                
                if (user && user.password === document.getElementById('loginPassword').value) {
                    // NEW: Check user status
                    if (user.status === 'deactivated') {
                        showToast('Your account is deactivated. Please contact an admin.', 'error');
                        return;
                    }
                    state.currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showApp(); 
                    updateUI();
                } else { 
                    showToast('Invalid email or password', 'error');
                }
            }, 500);
        }

        function handleRegister(e) {
            e.preventDefault();
            const button = document.getElementById('registerButton');
            setButtonLoading(button, true);

            // Simulate API delay
            setTimeout(() => {
                const email = document.getElementById('registerEmail').value;
                setButtonLoading(button, false);

                if (state.db.findUserByEmail(email)) { 
                    showToast('User with this email already exists', 'error');
                    return; 
                }
                state.db.createUser({
                    name: document.getElementById('registerName').value,
                    email: email,
                    password: document.getElementById('registerPassword').value,
                    role: document.getElementById('registerRole').value
                });
                showToast('Registration successful! Please log in.', 'success');
                registerForm.reset(); 
                // NEW: Switch to login tab
                switchAuthTab('login');
            }, 500);
        }

        function handleLogout() {
            state.currentUser = null; 
            localStorage.removeItem('currentUser');
            handleBackToDashboard(); 
            closeSidebar(); 
            showAuth();
        }

        function showAuth() { authScreen.classList.remove('hidden'); appScreen.classList.add('hidden'); }
        function showApp() { authScreen.classList.add('hidden'); appScreen.classList.remove('hidden'); }

        function updateUI() {
            if (state.currentUser) {
                document.getElementById('userName').textContent = state.currentUser.name;
                document.getElementById('userEmail').textContent = state.currentUser.email;
                document.getElementById('userAvatar').textContent = state.currentUser.name.charAt(0).toUpperCase();
                
                const roleBadge = document.getElementById('userRoleBadge');
                roleBadge.textContent = state.currentUser.role.toUpperCase();
                // NEW: Add parent role badge
                if (state.currentUser.role === 'parent') {
                    roleBadge.className = `role-badge role-parent`;
                } else {
                    roleBadge.className = `role-badge role-${state.currentUser.role}`;
                }
                
                const isAdmin = state.currentUser.role === 'admin';
                const isStudent = state.currentUser.role === 'student';
                const isParent = state.currentUser.role === 'parent'; // NEW
                
                // NEW: Toggle admin class on body
                document.body.classList.toggle('is-admin', isAdmin);
                
                document.querySelector('.nav-link[data-page="users"]').style.display = (isStudent || isParent) ? 'none' : 'flex';
                document.querySelector('.nav-link[data-page="exams"]').style.display = (isStudent || isParent) ? 'none' : 'flex';
                document.querySelector('.nav-link[data-page="takeExam"]').style.display = (isStudent || isParent) ? 'flex' : 'none';
                
                updateStats(); 
                updateTables();
            }
        }

        function switchPage(page) {
            state.currentPage = page;
            pages.forEach(p => p.classList.add('hidden'));
            const pageElement = document.getElementById(`${page}Page`);
            if (pageElement) pageElement.classList.remove('hidden');
            else document.getElementById('dashboardPage').classList.remove('hidden');
        }

        function switchTab(tabId) {
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }

        function updateStats() {
            document.getElementById('totalUsers').textContent = state.db.users.length;
            document.getElementById('totalTeachers').textContent = state.db.users.filter(u => u.role === 'teacher').length;
            document.getElementById('totalStudents').textContent = state.db.users.filter(u => u.role === 'student').length;
            // NEW: Count parents
            document.getElementById('totalParents').textContent = state.db.users.filter(u => u.role === 'parent').length;
            document.getElementById('totalExams').textContent = state.db.exams.length;
            document.getElementById('completedExams').textContent = state.db.results.filter(r => r.status === 'active').length;
        }

        // MODIFIED: Added forceRedraw param
        function updateTables(forceRedraw = false) { return;
            // Only redraw if the page is active or forced
            if (state.currentPage === 'dashboard' || forceRedraw) {
                renderDashboardPendingTable();
                renderDashboardRecentTable();
                renderDashboardUserTable();
            }
            if (state.currentPage === 'users' || forceRedraw) {
                renderManageUserTable();
            }
        }
        
        function renderDashboardPendingTable() {
            pendingExamsTableBody.innerHTML = '';
            const isAdmin = state.currentUser.role === 'admin';
            
            const pendingExams = state.db.exams.filter(exam => exam.status === 'pending');
            if (pendingExams.length === 0) {
                pendingExamsTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="5"><i class="fas fa-check-circle"></i>No pending exams.</td></tr>`;
            } else {
                pendingExams.forEach(exam => {
                    const editButtons = `
                        <div class="action-wrapper">
                            <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                            <div class="action-buttons">
                                <button class="action-btn edit-exam" data-id="${exam.id}"><i class="fas fa-edit"></i> Edit</button>
                                <button class="action-btn approve-exam" data-id="${exam.id}"><i class="fas fa-check"></i> Approve</button>
                                <button class="action-btn reject-exam" data-id="${exam.id}"><i class="fas fa-times"></i> Reject</button>
                            </div>
                        </div>
                    `;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `<td data-label="Title">${exam.title}</td><td data-label="Teacher">${exam.teacher}</td><td data-label="Questions">${exam.questions.length}</td><td data-label="Status"><span class="status status-pending">Pending</span></td><td data-label="Actions" class="admin-action-cell">${editButtons}</td>`;
                    pendingExamsTableBody.appendChild(row);
                });
            }
        }
        
        function renderDashboardRecentTable() {
             recentExamsTableBody.innerHTML = '';
             const subjectMapMobile = { 'math': 'Mat', 'physics': 'Phy', 'chemistry': 'Chem', 'biology': 'Bio' };

             const recentExams = state.db.exams.filter(exam => exam.status === 'approved');
             if (recentExams.length === 0) {
                 recentExamsTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="5"><i class="fas fa-file-alt"></i>No approved exams.</td></tr>`;
             } else {
                 recentExams.forEach(exam => {
                     const row = document.createElement('tr');
                     const participantCount = state.db.results.filter(r => r.examId === exam.id && r.status === 'active').length;
                     
                     const sub = exam.subject || 'N/A';
                     const shortSub = subjectMapMobile[sub.toLowerCase()] || sub.substring(0,3);
                     const subjectDisplay = `<span class="desktop-text">${sub}</span><span class="mobile-text">${shortSub}</span>`;
                     
                     row.innerHTML = `<td data-label="Title">${exam.title}</td><td data-label="Subject">${subjectDisplay}</td><td data-label="Questions">${exam.questions.length}</td><td data-label="Participants">${participantCount}</td><td style="min-width: 60px;" data-label="Actions" class="admin-action-cell"></td>`;
                     recentExamsTableBody.appendChild(row);
                 });
             }
        }

        // NEW: Refactored user table rendering
        function renderUserTable(tbody, userList, showAll) {
            tbody.innerHTML = '';
            const usersToShow = showAll ? userList : userList.slice(0, 3);

            if (usersToShow.length === 0) {
                const colSpan = (tbody.id === "usersTableBody") ? 4 : 5;
                tbody.innerHTML = `<tr class="empty-state-row"><td colspan="${colSpan}"><i class="fas fa-user-slash"></i>No users found.</td></tr>`;
                return;
            }
            
            // Format date helper
            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
            };

            usersToShow.forEach(user => {
                const row = document.createElement('tr');
                const userStatus = user.status || 'active';
                const statusClass = userStatus === 'active' ? 'status-approved' : 'status-deactivated';
                const statusText = userStatus === 'active' ? 'Active' : 'Deactivated';
                
                // Dashboard User List
                if (tbody.id === "usersTableBody") {
                    row.innerHTML = `
                        <td data-label="Name">${user.name}</td>
                        <td data-label="Role">${user.role}</td>
                        <td data-label="Joined">${formatDate(user.joinedDate)}</td>
                        <td data-label="Status"><span class="status ${statusClass}">${statusText}</span></td>
                    `;
                } 
                // Manage User List
                else {
                    let statusButton;
                    if (userStatus === 'active') {
                        statusButton = `<button class="action-btn deactivate-user" data-id="${user.id}" title="Deactivate User"><i class="fas fa-user-slash"></i> Deactivate</button>`;
                    } else {
                        statusButton = `<button class="action-btn activate-user" data-id="${user.id}" title="Activate User"><i class="fas fa-user-check"></i> Activate</button>`;
                    }

                    const adminButton = (state.currentUser.role === 'admin' && user.id !== state.currentUser.id) ? `
                        <div class="action-wrapper">
                             <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                             <div class="action-buttons">
                                 <button class="action-btn edit-user" data-id="${user.id}" title="Edit User"><i class="fas fa-edit"></i> Edit User</button>
                                 ${statusButton}
                             </div>
                        </div>
                    ` : '';
                    
                    row.innerHTML = `
                        <td data-label="Name" style="font-weight: 600;">${user.name} ${user.id === state.currentUser.id ? '(You)' : ''}</td>
                        <td data-label="Email"><span style="font-size: 0.85rem;">${user.email}</span></td>
                        <td data-label="Role"><span class="role-badge role-${user.role}">${user.role}</span></td>
                        <td data-label="Status"><span class="status ${statusClass}">${statusText}</span></td>
                        <td data-label="Actions" class="admin-action-cell">${adminButton}</td>
                    `;
                }
                tbody.appendChild(row);
            });
        }
        
        // NEW: Separate render functions for user tables
        function renderDashboardUserTable() {
            const allUsers = state.db.users.sort((a, b) => new Date(b.joinedDate) - new Date(a.joinedDate)); // Sort by most recent
            const isExpanded = document.getElementById('dashboardUserListContainer').classList.contains('expanded');
            renderUserTable(usersTableBody, allUsers, isExpanded);
            
            // Toggle "Show all" button
            showAllUsersBtn.style.display = (allUsers.length > 3) ? 'flex' : 'none';
        }
        
        function renderManageUserTable() {
            let filteredUsers = state.db.users;
            let titleText = "User Management";
            
            if (state.userFilter === 'teacher') { filteredUsers = state.db.users.filter(u => u.role === 'teacher'); titleText += ": Teachers"; }
            else if (state.userFilter === 'student') { filteredUsers = state.db.users.filter(u => u.role === 'student'); titleText += ": Students"; }
            else if (state.userFilter === 'parent') { filteredUsers = state.db.users.filter(u => u.role === 'parent'); titleText += ": Parents"; } // NEW: Parent filter
            else { titleText += ": All Users"; }
            
            usersPageTitle.textContent = titleText;
            
            const isExpanded = document.getElementById('manageUserListContainer').classList.contains('expanded');
            renderUserTable(manageUsersTableBody, filteredUsers, isExpanded);
            
            // Toggle "Show all" button
            showAllManageUsersBtn.style.display = (filteredUsers.length > 3) ? 'flex' : 'none';
        }

        function handleCreateExam(e) {
            e.preventDefault();
            const newExam = state.db.createExam({
                title: document.getElementById('examTitleInput').value,
                subject: document.getElementById('examSubject').value,
                scheduledDate: document.getElementById('examDate').value,
                duration: parseInt(document.getElementById('examDurationInput').value),
                teacher: state.currentUser.name,
                teacherId: state.currentUser.id, // NEW: Store teacher ID
                status: state.currentUser.role === 'admin' ? 'approved' : 'pending',
            });
            addExamModal.style.display = 'none'; examForm.reset();
            updateTables(); updateStats();
            showToast("Exam created! Add questions now.", "success");
            openExamEditor(newExam.id);
        }

        // --- NEW: Handle Joining an exam by ID ---
        function handleJoinExam(e) {
            e.preventDefault();
            const button = document.getElementById('joinExamButton');
            setButtonLoading(button, true);
            
            setTimeout(() => {
                // MODIFIED: Trim whitespace from code
                const examCode = joinExamCodeInput.value.trim();
                console.log("Joining exam with code:", `'${examCode}'`); // DEBUG
                const exam = state.db.findExamByCode(examCode);
                setButtonLoading(button, false);

                if (!exam) {
                    showToast("Invalid Exam ID. Please try again.", "error");
                    return;
                }
                
                if (exam.status !== 'approved') {
                    showToast("This exam is not yet approved or is pending.", "error");
                    return;
                }
                
                if (exam.questions.length === 0) {
                    showToast("This exam has no questions.", "error");
                    return;
                }
                
                if (state.db.hasStudentTakenExam(state.currentUser.id, exam.id)) {
                    showToast("You have already completed this exam.", "error");
                    return;
                }
                
                // All checks passed
                joinExamModal.style.display = 'none';
                startExam(exam.id);
                
            }, 500);
        }

        function startExam(examId, isPreview = false) {
            const exam = state.db.findExamById(examId);
            if (!exam) return;
            
            state.currentExam = exam; 
            state.currentQuestionIndex = 0; 
            state.userAnswers = new Array(exam.questions.length).fill(null); 
            state.timeRemaining = exam.duration * 60;
            state.isPreviewMode = isPreview;
            
            document.getElementById('examTitle').textContent = exam.title + (isPreview ? " (Preview Mode)" : "");
            document.getElementById('examDuration').textContent = exam.duration === 0 ? "Unlimited" : exam.duration;
            document.getElementById('totalQuestions').textContent = exam.questions.length;
            
            document.getElementById('resultDisplay').classList.add('hidden');
            document.getElementById('questionContainer').classList.remove('hidden');
            document.getElementById('activeExamControls').classList.remove('hidden');
            document.getElementById('submitExam').innerText = isPreview ? "Finish Preview" : "Submit Exam";

            loadQuestion(state.currentQuestionIndex); 
            if(!isPreview && exam.duration > 0) startTimer();
            else document.getElementById('timeRemaining').textContent = isPreview ? "N/A (Preview)" : (exam.duration === 0 ? "Unlimited" : "N/A");
            
            switchPage('takeExam');
        }

        function loadQuestion(index) {
            if (!state.currentExam) return;
            const q = state.currentExam.questions[index];
            // NEW: Default to 'single' if type is missing
            const qType = q.type || 'single';
            
            document.getElementById('questionText').textContent = q.question;
            document.getElementById('currentQuestion').textContent = index + 1;
            examOptionsContainer.innerHTML = '';
            
            // NEW: Render question based on type
            switch(qType) {
                case 'single':
                    q.options.forEach((optionText, i) => {
                        const div = document.createElement('div'); 
                        div.className = 'option'; 
                        div.dataset.index = i;
                        div.innerHTML = `<input type="radio" name="answer" value="${i}" id="option${i}"><label for="option${i}">${optionText}</label>`;
                        examOptionsContainer.appendChild(div);
                        if (state.userAnswers[index] === i) { 
                            div.querySelector('input').checked = true; 
                            div.classList.add('selected'); 
                        }
                    });
                    break;
                case 'multiple':
                    q.options.forEach((optionText, i) => {
                        const div = document.createElement('div'); 
                        div.className = 'option'; 
                        div.dataset.index = i;
                        div.innerHTML = `<input type="checkbox" name="answer" value="${i}" id="option${i}"><label for="option${i}">${optionText}</label>`;
                        examOptionsContainer.appendChild(div);
                        if (state.userAnswers[index] && state.userAnswers[index][i]) {
                            div.querySelector('input').checked = true; 
                            div.classList.add('selected');
                        }
                    });
                    break;
                case 'truefalse':
                    ['True', 'False'].forEach((optionText, i) => {
                        const val = optionText.toLowerCase();
                        const div = document.createElement('div'); 
                        div.className = 'option'; 
                        div.dataset.index = val;
                        div.innerHTML = `<input type="radio" name="answer" value="${val}" id="option${i}"><label for="option${i}">${optionText}</label>`;
                        examOptionsContainer.appendChild(div);
                        if (state.userAnswers[index] === val) { 
                            div.querySelector('input').checked = true; 
                            div.classList.add('selected'); 
                        }
                    });
                    break;
                case 'fill':
                    examOptionsContainer.innerHTML = `
                        <div class="form-group">
                            <label>Your Answer:</label>
                            <input type="text" class="form-control answer-input" id="fillAnswerInput">
                        </div>`;
                    if (state.userAnswers[index]) {
                        document.getElementById('fillAnswerInput').value = state.userAnswers[index];
                    }
                    break;
                case 'essay':
                     examOptionsContainer.innerHTML = `
                        <div class="form-group">
                            <label>Your Answer:</label>
                            <textarea class="form-control answer-textarea" id="essayAnswerInput"></textarea>
                        </div>`;
                    if (state.userAnswers[index]) {
                        document.getElementById('essayAnswerInput').value = state.userAnswers[index];
                    }
                    break;
            }
            
            prevQuestionBtn.disabled = index === 0;
            
            const isLast = index === state.currentExam.questions.length - 1;
            nextQuestionBtn.classList.toggle('hidden', isLast);
            submitExamBtn.classList.toggle('hidden', !isLast);
        }
        
        function saveAnswer() {
            if(state.isPreviewMode) return;
            
            const qType = state.currentExam.questions[state.currentQuestionIndex].type || 'single';
            
            switch(qType) {
                case 'single':
                    const selectedSingle = document.querySelector('#examOptionsContainer input[type="radio"]:checked');
                    if (selectedSingle) state.userAnswers[state.currentQuestionIndex] = parseInt(selectedSingle.value);
                    break;
                case 'multiple':
                    const selectedMultiple = document.querySelectorAll('#examOptionsContainer input[type="checkbox"]');
                    const answers = Array.from(selectedMultiple).map(cb => cb.checked);
                    state.userAnswers[state.currentQuestionIndex] = answers;
                    break;
                case 'truefalse':
                    const selectedTF = document.querySelector('#examOptionsContainer input[type="radio"]:checked');
                    if (selectedTF) state.userAnswers[state.currentQuestionIndex] = selectedTF.value;
                    break;
                case 'fill':
                    const fillInput = document.getElementById('fillAnswerInput');
                    if (fillInput) state.userAnswers[state.currentQuestionIndex] = fillInput.value;
                    break;
                case 'essay':
                    const essayInput = document.getElementById('essayAnswerInput');
                    if (essayInput) state.userAnswers[state.currentQuestionIndex] = essayInput.value;
                    break;
            }
        }

        function handleNextQuestion() { saveAnswer(); if (state.currentQuestionIndex < state.currentExam.questions.length - 1) { state.currentQuestionIndex++; loadQuestion(state.currentQuestionIndex); }}
        function handlePrevQuestion() { saveAnswer(); if (state.currentQuestionIndex > 0) { state.currentQuestionIndex--; loadQuestion(state.currentQuestionIndex); }}
        
        function startTimer() {
            if (state.examTimer) clearInterval(state.examTimer);
            const el = document.getElementById('timeRemaining');
            state.examTimer = setInterval(() => {
                state.timeRemaining--;
                const m = Math.floor(state.timeRemaining / 60), s = state.timeRemaining % 60;
                el.textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (state.timeRemaining <= 0) { 
                    clearInterval(state.examTimer); 
                    showToast("Time's up! Submitting exam.", "warning");
                    handleSubmitExam(); 
                }
            }, 1000);
        }

        function handleSubmitExam() {
            saveAnswer(); 
            if (state.examTimer) clearInterval(state.examTimer);
            if (!state.currentExam) return;
            
            if(state.isPreviewMode) {
                handleBackToDashboard();
                showToast("Preview finished.", "info");
                return;
            }

            let score = 0; 
            let totalAutoGraded = 0;
            
            state.userAnswers.forEach((userAnswer, i) => {
                const q = state.currentExam.questions[i];
                const qType = q.type || 'single';
                
                // MODIFIED: Fix for type-insensitive comparison (Removed the extra function wrapping)
                const normalize = (val) => val === null || val === undefined ? null : String(val).toLowerCase();
                const userAnswerNorm = normalize(userAnswer);
                const correctAnswerNorm = normalize(q.correctAnswer);

                switch(qType) {
                    case 'single':
                        totalAutoGraded++;
                        if (userAnswerNorm == correctAnswerNorm) score++; // Use == for type coercion
                        break;
                    case 'multiple':
                        totalAutoGraded++;
                        let isCorrect = true;
                        if (!userAnswer || userAnswer.length !== q.correctAnswer.length) {
                            isCorrect = false;
                        } else {
                            for (let j = 0; j < userAnswer.length; j++) {
                                // Compare boolean to string
                                if (normalize(userAnswer[j]) != normalize(q.correctAnswer[j])) {
                                    isCorrect = false;
                                    break;
                                }
                            }
                        }
                        if (isCorrect) score++;
                        break;
                    case 'truefalse':
                        totalAutoGraded++;
                        if (userAnswerNorm == correctAnswerNorm) score++;
                        break;
                    case 'fill':
                        totalAutoGraded++;
                        if (userAnswerNorm == correctAnswerNorm) score++;
                        break;
                    case 'essay':
                        // Not auto-graded
                        break;
                }
            });
            
            state.db.saveResult({
                studentId: state.currentUser.id,
                studentName: state.currentUser.name,
                examId: state.currentExam.id,
                examTitle: state.currentExam.title,
                score: score,
                total: totalAutoGraded
            });
            
            document.getElementById('questionContainer').classList.add('hidden');
            document.getElementById('activeExamControls').classList.add('hidden');
            document.getElementById('resultDisplay').classList.remove('hidden');
            document.getElementById('finalScoreDisplay').textContent = `${score} / ${totalAutoGraded}`;
            showToast("Exam submitted successfully!", "success");
        }
        
        function openExamEditor(examId) {
            const exam = state.db.findExamById(examId); if (!exam) return;
            console.log("Editing exam:", exam); // DEBUG
            state.editingExamId = examId; 
            examEditorTitle.textContent = `Edit Exam: ${exam.title}`;
            
            document.getElementById('editExamTitleInput').value = exam.title;
            document.getElementById('editExamSubjectInput').value = exam.subject;
            document.getElementById('editExamDurationInput').value = exam.duration;
            
            renderQuestionList(); 
            handleNavClick('examEditor');
        }
        
        function handleUpdateExamDetails(e) {
            e.preventDefault();
            state.db.updateExam(state.editingExamId, {
                title: document.getElementById('editExamTitleInput').value,
                subject: document.getElementById('editExamSubjectInput').value,
                duration: parseInt(document.getElementById('editExamDurationInput').value)
            });
            showToast("Exam details updated.", "success");
        }

        function renderQuestionList() {
            const exam = state.db.findExamById(state.editingExamId); if (!exam) return;
            questionList.innerHTML = ''; 
            questionCount.textContent = exam.questions.length;
            
            if(exam.questions.length === 0) {
                questionList.classList.add('empty-list');
                return;
            }
            questionList.classList.remove('empty-list');

            exam.questions.forEach((q, index) => {
                const li = document.createElement('li'); li.className = 'question-list-item';
                const qType = q.type || 'single';
                let answerHtml = '';

                switch(qType) {
                    case 'single':
                    case 'multiple':
                        answerHtml = `<ul class="question-list-item-options">` + 
                            q.options.map((opt, i) => {
                                let isCorrect = false;
                                if (qType === 'single') isCorrect = (i == q.correctAnswer);
                                if (qType === 'multiple') isCorrect = (String(q.correctAnswer[i]).toLowerCase() === 'true');
                                return `<li class="${isCorrect ? 'correct' : ''}">${i+1}. ${opt}</li>`;
                            }).join('') + `</ul>`;
                        break;
                    case 'truefalse':
                        answerHtml = `<div class="question-list-item-answer">Correct Answer: ${q.correctAnswer}</div>`;
                        break;
                    case 'fill':
                         answerHtml = `<div class="question-list-item-answer">Correct Answer: ${q.correctAnswer}</div>`;
                        break;
                    case 'essay':
                        answerHtml = `<div class="question-list-item-answer">Essay (Manual Grade)</div>`;
                        break;
                }
                
                li.innerHTML = `
                    <div class="question-list-item-header">
                        <h4>${index + 1}. [${qType}] ${q.question}</h4>
                        <div>
                            <button class="btn-icon edit-question" data-index="${index}"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon danger delete-question" data-index="${index}"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    ${answerHtml}
                `;
                questionList.appendChild(li);
            });
        }
        
        // --- NEW: Dynamic Question Form Logic ---
        function setRequired(elements, isRequired) {
            if (!elements) return;
            // MODIFIED: Handle single element or list
            const elementList = NodeList.prototype.isPrototypeOf(elements) ? elements : (Array.isArray(elements) ? elements : [elements]);
            elementList.forEach(el => {
                if (el) el.required = isRequired;
            });
        }

        function toggleQuestionFields(type, formPrefix) {
            const form = document.getElementById(formPrefix === 'add' ? 'addQuestionForm' : 'editQuestionForm');
            
            // All field groups
            const fieldGroups = {
                single: form.querySelector(`#${formPrefix}-options-single`),
                multiple: form.querySelector(`#${formPrefix}-options-multiple`),
                truefalse: form.querySelector(`#${formPrefix}-answer-truefalse`),
                fill: form.querySelector(`#${formPrefix}-answer-fill`),
                essay: form.querySelector(`#${formPrefix}-answer-essay`)
            };
            
            // All input elements
            const inputs = {
                singleOptions: fieldGroups.single.querySelectorAll('input[type="text"]'),
                singleRadios: fieldGroups.single.querySelectorAll('input[type="radio"]'),
                multipleOptions: fieldGroups.multiple.querySelectorAll('input[type="text"]'),
                truefalseSelect: fieldGroups.truefalse.querySelector('select'),
                // MODIFIED: Fix for typo
                fillInput: fieldGroups.fill.querySelector('input')
            };

            // Hide all groups, remove all 'required'
            for (const key in fieldGroups) {
                if(fieldGroups[key]) fieldGroups[key].classList.add('hidden');
            }
            setRequired(inputs.singleOptions, false);
            setRequired(inputs.singleRadios, false);
            setRequired(inputs.multipleOptions, false);
            setRequired(inputs.truefalseSelect, false);
            setRequired(inputs.fillInput, false);

            // Show and set 'required' for the selected type
            switch(type) {
                case 'single':
                    fieldGroups.single.classList.remove('hidden');
                    setRequired(inputs.singleOptions, true);
                    setRequired(inputs.singleRadios, true);
                    break;
                case 'multiple':
                    fieldGroups.multiple.classList.remove('hidden');
                    setRequired(inputs.multipleOptions, true);
                    // Checkboxes don't need 'required' for the group, only individual text
                    break;
                case 'truefalse':
                    fieldGroups.truefalse.classList.remove('hidden');
                    setRequired(inputs.truefalseSelect, true);
                    break;
                case 'fill':
                    fieldGroups.fill.classList.remove('hidden');
                    setRequired(inputs.fillInput, true);
                    break;
                case 'essay':
                    fieldGroups.essay.classList.remove('hidden');
                    break;
            }
        }
        
        function addDynamicOption(formPrefix, type) {
            const listId = `${formPrefix}-options-${type}-list`;
            const list = document.getElementById(listId);
            const newIndex = list.children.length;
            const optionType = (type === 'single') ? 'radio' : 'checkbox';
            const name = (type === 'single') ? 'correctAnswer' : 'correctAnswerMultiple';
            
            const div = document.createElement('div');
            div.className = 'option-input-group';
            div.innerHTML = `
                <input type="${optionType}" name="${name}" value="${newIndex}" ${type === 'single' ? 'required' : ''}>
                <input type="text" class="form-control" placeholder="Option ${newIndex + 1}" ${type === 'single' ? 'required' : ''}>
                <button type="button" class="btn-remove-option" title="Remove option"><i class="fas fa-times"></i></button>
            `;
            
            div.querySelector('.btn-remove-option').addEventListener('click', () => {
                div.remove();
                // Re-index remaining options
                const items = list.querySelectorAll('.option-input-group');
                items.forEach((item, index) => {
                    item.querySelector('input[type="text"]').placeholder = `Option ${index + 1}`;
                    item.querySelector(`input[type="${optionType}"]`).value = index;
                });
            });
            
            list.appendChild(div);
        }

        function handleAddQuestion(e) {
            e.preventDefault();
            const form = e.target;
            const type = form.querySelector('#questionTypeInput').value;
            const q = {
                type: type,
                question: form.querySelector('#questionTextInput').value,
            };

            switch(type) {
                case 'single':
                    const correctSingle = form.querySelector('input[name="correctAnswer"]:checked');
                    if (!correctSingle) {
                        showToast("Please select a correct answer.", "error"); return;
                    }
                    q.options = Array.from(form.querySelectorAll('#add-options-single-list input[type="text"]')).map(inp => inp.value);
                    q.correctAnswer = parseInt(correctSingle.value);
                    break;
                case 'multiple':
                    q.options = Array.from(form.querySelectorAll('#add-options-multiple-list input[type="text"]')).map(inp => inp.value);
                    q.correctAnswer = Array.from(form.querySelectorAll('#add-options-multiple-list input[type="checkbox"]')).map(cb => cb.checked);
                    if (q.correctAnswer.every(val => val === false)) {
                         showToast("Please select at least one correct answer.", "error"); return;
                    }
                    break;
                case 'truefalse':
                    q.correctAnswer = form.querySelector('#addAnswerTrueFalse').value;
                    break;
                case 'fill':
                    q.correctAnswer = form.querySelector('#addAnswerFill').value;
                    break;
                case 'essay':
                    q.correctAnswer = null; // No correct answer for essay
                    break;
            }
            
            state.db.addQuestionToExam(state.editingExamId, q); 
            renderQuestionList(); 
            // Reset only the dynamic parts
            form.querySelector('#questionTextInput').value = '';
            document.getElementById('add-options-single-list').innerHTML = `
                <div class="option-input-group">
                    <input type="radio" name="correctAnswer" value="0" required>
                    <input type="text" class="form-control" placeholder="Option 1" required>
                </div>
                <div class="option-input-group">
                    <input type="radio" name="correctAnswer" value="1" required>
                    <input type="text" class="form-control" placeholder="Option 2" required>
                </div>`;
            document.getElementById('add-options-multiple-list').innerHTML = `
                <div class="option-input-group">
                    <input type="checkbox" name="correctAnswerMultiple" value="0">
                    <input type="text" class="form-control" placeholder="Option 1">
                </div>
                <div class="option-input-group">
                    <input type="checkbox" name="correctAnswerMultiple" value="1">
                    <input type="text" class="form-control" placeholder="Option 2">
                </div>`;
            form.querySelector('#addAnswerFill').value = '';
            form.querySelector('#questionTypeInput').value = 'single';
            toggleQuestionFields('single', 'add');
            
            showToast("Question added.", "success");
        }
        
        function handleDeleteQuestion(examId, qIndex) { 
             showConfirmation("Delete Question?", `Are you sure you want to delete question ${qIndex + 1}?`, () => {
                state.db.deleteQuestionFromExam(examId, qIndex); 
                renderQuestionList(); 
                showToast("Question deleted.", "success");
             });
        }
        
        function openEditQuestionModal(examId, qIndex) {
            const q = state.db.findExamById(examId).questions[qIndex]; if (!q) return;
            const qType = q.type || 'single';
            
            state.editingQuestionIndex = qIndex;
            const form = document.getElementById('editQuestionForm');
            
            form.querySelector('#editQuestionTypeInput').value = qType;
            form.querySelector('#editQuestionTextInput').value = q.question;
            
            // Populate dynamic fields
            switch(qType) {
                case 'single':
                    const sList = form.querySelector('#edit-options-single-list');
                    sList.innerHTML = '';
                    q.options.forEach((opt, i) => {
                        const div = document.createElement('div');
                        div.className = 'option-input-group';
                        div.innerHTML = `
                            <input type="radio" name="editCorrectAnswer" value="${i}" ${i == q.correctAnswer ? 'checked' : ''} required>
                            <input type="text" class="form-control" value="${opt}" required>
                            <button type="button" class="btn-remove-option" title="Remove option"><i class="fas fa-times"></i></button>
                        `;
                        div.querySelector('.btn-remove-option').addEventListener('click', () => div.remove());
                        sList.appendChild(div);
                    });
                    break;
                case 'multiple':
                     const mList = form.querySelector('#edit-options-multiple-list');
                    mList.innerHTML = '';
                    q.options.forEach((opt, i) => {
                        const div = document.createElement('div');
                        div.className = 'option-input-group';
                        const isChecked = (String(q.correctAnswer[i]).toLowerCase() === 'true');
                        div.innerHTML = `
                            <input type="checkbox" name="editCorrectAnswerMultiple" value="${i}" ${isChecked ? 'checked' : ''}>
                            <input type="text" class="form-control" value="${opt}" required>
                            <button type="button" class="btn-remove-option" title="Remove option"><i class="fas fa-times"></i></button>
                        `;
                        div.querySelector('.btn-remove-option').addEventListener('click', () => div.remove());
                        mList.appendChild(div);
                    });
                    break;
                case 'truefalse':
                    form.querySelector('#editAnswerTrueFalse').value = String(q.correctAnswer).toLowerCase();
                    break;
                case 'fill':
                    form.querySelector('#editAnswerFill').value = q.correctAnswer;
                    break;
                case 'essay':
                    break;
            }
            
            toggleQuestionFields(qType, 'edit');
            editQuestionModal.style.display = 'flex';
        }
        
        function handleUpdateQuestion(e) {
            e.preventDefault();
            const form = e.target;
            const type = form.querySelector('#editQuestionTypeInput').value;
            const q = {
                type: type,
                question: form.querySelector('#editQuestionTextInput').value,
            };

            switch(type) {
                case 'single':
                    const correctSingle = form.querySelector('input[name="editCorrectAnswer"]:checked');
                    if (!correctSingle) {
                        showToast("Please select a correct answer.", "error"); return;
                    }
                    q.options = Array.from(form.querySelectorAll('#edit-options-single-list input[type="text"]')).map(inp => inp.value);
                    q.correctAnswer = parseInt(correctSingle.value);
                    break;
                case 'multiple':
                    q.options = Array.from(form.querySelectorAll('#edit-options-multiple-list input[type="text"]')).map(inp => inp.value);
                    q.correctAnswer = Array.from(form.querySelectorAll('#edit-options-multiple-list input[type="checkbox"]')).map(cb => cb.checked);
                    if (q.correctAnswer.every(val => val === false)) {
                         showToast("Please select at least one correct answer.", "error"); return;
                    }
                    break;
                case 'truefalse':
                    q.correctAnswer = form.querySelector('#editAnswerTrueFalse').value;
                    break;
                case 'fill':
                    q.correctAnswer = form.querySelector('#editAnswerFill').value;
                    break;
                case 'essay':
                    q.correctAnswer = null;
                    break;
            }
            
            state.db.updateQuestionInExam(state.editingExamId, state.editingQuestionIndex, q);
            renderQuestionList(); 
            editQuestionModal.style.display = 'none';
            showToast("Question updated.", "success");
        }
        
        // --- NEW: Class Management Functions ---
        function renderClassManagementTable() {
            manageClassesTableBody.innerHTML = '';
            const classes = state.db.getClasses();
            const isExpanded = manageClassListContainer.classList.contains('expanded');
            const classesToShow = isExpanded ? classes : classes.slice(0, 3);

            if (classes.length === 0) {
                manageClassesTableBody.innerHTML = `<tr class="empty-state-row"><td colspan="5"><i class="fas fa-chalkboard"></i>No classes created.</td></tr>`;
                showAllManageClassesBtn.style.display = 'none';
                return;
            }
            
            showAllManageClassesBtn.style.display = (classes.length > 3) ? 'flex' : 'none';
            
            classesToShow.forEach(cls => {
                const row = document.createElement('tr');
                const actionButtons = `
                    <div class="action-wrapper">
                        <button class="mobile-menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                        <div class="action-buttons">
                            <button class="action-btn manage-students" data-id="${cls.id}"><i class="fas fa-users"></i> Manage Students</button>
                            <button class="action-btn assign-exam" data-id="${cls.id}"><i class="fas fa-file-alt"></i> Assign Exam</button>
                            <button class="action-btn edit-class" data-id="${cls.id}"><i class="fas fa-edit"></i> Edit Class</button>
                            <button class="action-btn delete-class delete-result" data-id="${cls.id}"><i class="fas fa-trash"></i> Delete Class</button>
                        </div>
                    </div>
                `;
                row.innerHTML = `
                    <td data-label="Class Name">${cls.name}</td>
                    <td data-label="Teacher">${cls.teacher}</td>
                    <td data-label="Students">${cls.students.length}</td>
                    <td data-label="Exams">${cls.exams.length}</td>
                    <td data-label="Actions" class="admin-action-cell">${actionButtons}</td>
                `;
                manageClassesTableBody.appendChild(row);
            });
        }
        
        function handleClassManagementClick(e) {
            const btn = e.target.closest('button');
            if(!btn || btn.classList.contains('mobile-menu-trigger')) return;
            
            const classId = parseInt(btn.dataset.id);
            if (btn.classList.contains('edit-class')) {
                openCreateClassModal(classId);
            } else if (btn.classList.contains('delete-class')) {
                showConfirmation("Delete Class?", "Are you sure you want to delete this class? This cannot be undone.", () => {
                    state.db.deleteClass(classId);
                    renderClassManagementTable();
                    showToast("Class deleted.", "success");
                });
            } else if (btn.classList.contains('manage-students')) {
                openManageStudentsModal(classId);
            } else if (btn.classList.contains('assign-exam')) {
                openAssignExamModal(classId);
            }
        }
        
        function openCreateClassModal(classId = null) {
            performAdminAction(() => {
                const isEditing = classId !== null;
                state.editingClassId = isEditing ? classId : null;
                
                document.getElementById('classModalTitle').textContent = isEditing ? "Edit Class" : "Create New Class";
                
                if (isEditing) {
                    const cls = state.db.findClassById(classId);
                    document.getElementById('classNameInput').value = cls.name;
                    document.getElementById('classTeacherInput').value = cls.teacher;
                    document.getElementById('classModalId').value = cls.id;
                } else {
                    classForm.reset();
                    document.getElementById('classModalId').value = '';
                }
                
                classModal.style.display = 'flex';
            });
        }
        
        function handleSaveClass(e) {
            e.preventDefault();
            const classId = document.getElementById('classModalId').value;
            const classData = {
                name: document.getElementById('classNameInput').value,
                teacher: document.getElementById('classTeacherInput').value,
            };
            
            if (classId) {
                // Update existing class
                state.db.updateClass(parseInt(classId), classData);
                showToast("Class updated successfully.", "success");
            } else {
                // Create new class
                state.db.createClass(classData);
                showToast("Class created successfully.", "success");
            }
            
            classModal.style.display = 'none';
            renderClassManagementTable();
        }
        
        function openManageStudentsModal(classId) {
            const cls = state.db.findClassById(classId);
            if (!cls) return;
            
            state.editingClassId = classId;
            document.getElementById('manageStudentsTitle').textContent = `Manage Students: ${cls.name}`;
            document.getElementById('manageStudentsClassId').value = classId;
            
            // Populate student roster
            const rosterList = document.getElementById('currentStudentList');
            rosterList.innerHTML = '';
            if (cls.students.length === 0) {
                rosterList.innerHTML = '<li class="student-list-item empty">No students in this class.</li>';
            } else {
                cls.students.forEach(studentId => {
                    const student = state.db.findUserById(studentId);
                    if (student) {
                        const li = document.createElement('li');
                        li.className = 'student-list-item';
                        li.innerHTML = `
                            <span>${student.name}</span>
                            <button class="btn-icon danger remove-student-btn" data-id="${student.id}"><i class="fas fa-times"></i></button>
                        `;
                        li.querySelector('.remove-student-btn').addEventListener('click', () => {
                            state.db.removeStudentFromClass(classId, student.id);
                            openManageStudentsModal(classId); // Refresh list
                        });
                        rosterList.appendChild(li);
                    }
                });
            }
            
            // Populate "Add Student" dropdown
            const addSelect = document.getElementById('addStudentSelect');
            addSelect.innerHTML = '<option value="">Select a Student...</option>';
            const allStudents = state.db.users.filter(u => u.role === 'student');
            allStudents.forEach(student => {
                // Only show students who are NOT already in the class
                if (!cls.students.includes(student.id)) {
                    addSelect.innerHTML += `<option value="${student.id}">${student.name}</option>`;
                }
            });
            
            manageStudentsModal.style.display = 'flex';
        }
        
        function handleAddStudentToClass() {
            const classId = state.editingClassId;
            const studentId = parseInt(document.getElementById('addStudentSelect').value);
            
            if (!classId || !studentId) {
                showToast("Please select a student.", "error");
                return;
            }
            
            state.db.addStudentToClass(classId, studentId);
            openManageStudentsModal(classId); // Refresh modal
        }
        
        function openAssignExamModal(classId) {
            const cls = state.db.findClassById(classId);
            if (!cls) return;
            
            state.editingClassId = classId;
            document.getElementById('assignExamTitle').textContent = `Assign Exam to: ${cls.name}`;
            document.getElementById('assignExamClassId').value = classId;
            
            // Populate "Assign Exam" dropdown
            const assignSelect = document.getElementById('assignExamSelect');
            assignSelect.innerHTML = '<option value="">Select an Approved Exam...</option>';
            const allExams = state.db.exams.filter(e => e.status === 'approved');
            allExams.forEach(exam => {
                // Only show exams not already assigned
                if (!cls.exams.includes(exam.id)) {
                    assignSelect.innerHTML += `<option value="${exam.id}">${exam.title} (${exam.examCode})</option>`;
                }
            });
            
            assignExamModal.style.display = 'flex';
        }
        
        function handleAssignExamToClass() {
            const classId = state.editingClassId;
            const examId = parseInt(document.getElementById('assignExamSelect').value);
            
             if (!classId || !examId) {
                showToast("Please select an exam.", "error");
                return;
            }
            
            state.db.assignExamToClass(classId, examId);
            renderClassManagementTable(); // Refresh table
            assignExamModal.style.display = 'none';
            showToast("Exam assigned to class.", "success");
        }


        // --- Start App ---
        // MODIFIED: Use more robust load listener
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init(); // Already loaded
        }
    </script>
<!-- ***************************************************************************************************** -->
<script type="module">
  // --- IMPORTS ---
 import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// 2. MAKE TOOLS GLOBAL (The Bulletproof Fix) 
window.addDoc = addDoc;
window.collection = collection;
window.getDocs = getDocs;


  // --- CONFIGURATION ---
  const firebaseConfig = {
      apiKey: "AIzaSyBXQNKWcLtmYeBBRv6Qtgx1R1wo-1Tk58E",
  authDomain: "awa-exam-app.firebaseapp.com",
  projectId: "awa-exam-app",
  storageBucket: "awa-exam-app.firebasestorage.app",
  messagingSenderId: "53757050328",
  appId: "1:53757050328:web:c15769214d889836f186ad",
  measurementId: "G-9NZTJK4KXD"
  };

  // --- INITIALIZE ---
  const app = initializeApp(firebaseConfig);
 // Make db global
window.db = getFirestore(app);
const db = window.db;
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // --- DOM ELEMENTS ---
  const loginBtn = document.getElementById("login-btn");
  const loginSection = document.getElementById("login-section");
  const quizContainer = document.getElementById("quiz-container");

  // --- LOGIN BUTTON CLICK ---
  loginBtn.addEventListener("click", () => {
      signInWithPopup(auth, provider)
        .catch((error) => alert("Login failed: " + error.message));
  });

  // --- CHECK LOGIN STATUS ---
  onAuthStateChanged(auth, (user) => {
      if (user) {
          // If logged in: Hide login button, Show quiz, Load questions
          console.log("User is logged in:", user.email);
          loginSection.style.display = "none";
          quizContainer.style.display = "block";
          loadQuestions();
      } else {
          // If logged out: Show login button, Hide quiz
          loginSection.style.display = "block";
          quizContainer.style.display = "none";
      }
  });

  // --- LOAD QUESTIONS FUNCTION ---
  async function loadQuestions() {
    if(quizContainer.innerHTML !== "") return; // Don't load twice

    const querySnapshot = await getDocs(collection(db, "questions"));
    
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const htmlContent = `
        <div style="border: 1px solid #ccc; margin: 10px; padding: 15px; border-radius: 8px;">
            <h3 style="color: blue;">${data.question}</h3>
            <label><input type="radio" name="${doc.id}" value="A"> A: ${data.choiceA}</label><br>
            <label><input type="radio" name="${doc.id}" value="B"> B: ${data.choiceB}</label><br>
            <label><input type="radio" name="${doc.id}" value="C"> C: ${data.choiceC}</label><br>
        </div>
      `;
      quizContainer.innerHTML += htmlContent;
    });
  }
</script>
</script>

</body>
</html>
